name: Deploy Admin (VPS)

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    if: ${{ secrets.VPS_SSH_HOST != '' && secrets.VPS_SSH_USER != '' && secrets.VPS_SSH_KEY != '' && secrets.TAILSCALE_AUTHKEY != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          VPS_PM2_APP_NAME: ${{ secrets.VPS_PM2_APP_NAME }}
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT != '' && secrets.VPS_SSH_PORT || '22' }}
          envs: VPS_APP_DIR,VPS_PM2_APP_NAME
          script: |
            set -euo pipefail
            export APP_DIR="${VPS_APP_DIR:-/home/deploy/apps/admin-repo}"
            export PM2_APP_NAME="${VPS_PM2_APP_NAME:-vb-admin}"
            cd "$APP_DIR"
            bash scripts/deploy-admin.sh
