# Sprint 0.6: Integration Verification Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Verify that auth, database, and protected routes work together end-to-end via Playwright E2E tests.

**Architecture:** Install Playwright in the admin app. Write E2E tests that verify: login creates a session in the database, protected routes redirect unauthenticated users to login, and logout clears the session. Tests run against a real (test) database.

**Tech Stack:** Playwright, PostgreSQL (test DB), Better Auth, Prisma

---

## Prerequisites

- PostgreSQL running locally or accessible via DATABASE_URL
- `.env` file configured in `apps/admin/` with valid DATABASE_URL, BETTER_AUTH_SECRET, BETTER_AUTH_URL
- Test user seeded in database (from `pnpm db:seed`)

---

### Task 1: Install Playwright in Admin App

**Files:**
- Modify: `apps/admin/package.json`
- Create: `apps/admin/playwright.config.ts`
- Modify: `apps/admin/.gitignore`

**Step 1: Add Playwright dependency**

```bash
cd /mnt/c/VelikiBukovec_web/apps/admin && pnpm add -D @playwright/test
```

**Step 2: Install Playwright browsers**

```bash
cd /mnt/c/VelikiBukovec_web/apps/admin && pnpm exec playwright install chromium
```

**Step 3: Create Playwright config**

Create `apps/admin/playwright.config.ts`:

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: false, // Auth tests need sequential execution
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: 1, // Single worker for auth state consistency
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3001',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:3001',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
});
```

**Step 4: Add e2e to .gitignore**

Append to `apps/admin/.gitignore`:

```
# Playwright
/test-results/
/playwright-report/
/blob-report/
/playwright/.cache/
```

**Step 5: Add test:e2e script to admin package.json**

Add to `apps/admin/package.json` scripts:

```json
"test:e2e": "playwright test"
```

**Step 6: Commit**

```bash
git add apps/admin/package.json apps/admin/playwright.config.ts apps/admin/.gitignore pnpm-lock.yaml
git commit -m "$(cat <<'EOF'
chore(admin): add Playwright for E2E testing

- Install @playwright/test
- Configure Playwright with webServer for dev mode
- Single worker for auth test consistency

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 2: Update Seed Script to Create Users with Passwords

**Files:**
- Modify: `packages/database/prisma/seed.ts`
- Modify: `packages/database/package.json`

**Step 1: Add bcryptjs dependency to database package**

```bash
cd /mnt/c/VelikiBukovec_web/packages/database && pnpm add bcryptjs && pnpm add -D @types/bcryptjs
```

**Step 2: Update seed.ts to hash passwords**

Replace the seed.ts content:

```typescript
import bcrypt from 'bcryptjs';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// Seed-specific logger (console is acceptable in development scripts)
const log = (message: string) => process.stdout.write(`${message}\n`);

// Test password for seeded users (only for development/testing)
const TEST_PASSWORD = '<TEST_PASSWORD>';

async function main() {
  log('Seeding database...');

  // Hash the test password
  const passwordHash = await bcrypt.hash(TEST_PASSWORD, 10);

  // Create test admin user
  const adminUser = await prisma.user.upsert({
    where: { email: 'admin@velikibukovec.hr' },
    update: {},
    create: {
      email: 'admin@velikibukovec.hr',
      name: 'Admin',
      role: 'super_admin',
      emailVerified: true,
    },
  });

  // Create account with password for admin
  await prisma.account.upsert({
    where: {
      providerId_accountId: {
        providerId: 'credential',
        accountId: adminUser.id,
      },
    },
    update: { password: passwordHash },
    create: {
      userId: adminUser.id,
      providerId: 'credential',
      accountId: adminUser.id,
      password: passwordHash,
    },
  });

  log(`Created admin user: ${adminUser.email} (password: ${TEST_PASSWORD})`);

  // Create test staff user
  const staffUser = await prisma.user.upsert({
    where: { email: 'staff@velikibukovec.hr' },
    update: {},
    create: {
      email: 'staff@velikibukovec.hr',
      name: 'Staff Member',
      role: 'staff',
      emailVerified: true,
    },
  });

  // Create account with password for staff
  await prisma.account.upsert({
    where: {
      providerId_accountId: {
        providerId: 'credential',
        accountId: staffUser.id,
      },
    },
    update: { password: passwordHash },
    create: {
      userId: staffUser.id,
      providerId: 'credential',
      accountId: staffUser.id,
      password: passwordHash,
    },
  });

  log(`Created staff user: ${staffUser.email} (password: ${TEST_PASSWORD})`);

  // Create initial settings
  const settings = [
    { key: 'site_name', value: { hr: 'OpÄ‡ina Veliki Bukovec' } },
    { key: 'site_description', value: { hr: 'SluÅ¾bena web stranica OpÄ‡ine Veliki Bukovec' } },
    { key: 'contact_email', value: 'info@velikibukovec.hr' },
    { key: 'contact_phone', value: '+385 42 XXX XXX' },
    { key: 'contact_address', value: 'Veliki Bukovec XX, 42231 Veliki Bukovec' },
    { key: 'social_facebook', value: 'https://facebook.com/opcinaveliki.bukovec' },
    { key: 'newsletter_enabled', value: true },
    { key: 'ai_generation_enabled', value: false },
  ];

  for (const setting of settings) {
    await prisma.setting.upsert({
      where: { key: setting.key },
      update: { value: setting.value },
      create: setting,
    });
  }

  log('Created initial settings');

  // Create sample page
  const aboutPage = await prisma.page.upsert({
    where: { slug: 'o-opcini' },
    update: {},
    create: {
      title: 'O OpÄ‡ini',
      slug: 'o-opcini',
      content: JSON.stringify({
        type: 'doc',
        content: [
          {
            type: 'paragraph',
            content: [{ type: 'text', text: 'DobrodoÅ¡li u OpÄ‡inu Veliki Bukovec.' }],
          },
        ],
      }),
      menuOrder: 1,
    },
  });

  log(`Created sample page: ${aboutPage.slug}`);

  log('Seeding completed!');
}

main()
  .then(async () => {
    await prisma.$disconnect();
  })
  .catch(async (e) => {
    process.stderr.write(`${String(e)}\n`);
    await prisma.$disconnect();
    process.exit(1);
  });
```

**Step 3: Re-run seed to create users with passwords**

```bash
cd /mnt/c/VelikiBukovec_web && pnpm db:seed
```

**Step 4: Commit**

```bash
git add packages/database/prisma/seed.ts packages/database/package.json pnpm-lock.yaml
git commit -m "$(cat <<'EOF'
fix(database): seed users with credential passwords

Better Auth requires Account records with hashed passwords for
email/password login. Adds bcryptjs for password hashing.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 3: Create E2E Test Helpers

**Files:**
- Create: `apps/admin/e2e/helpers/db.ts`
- Create: `apps/admin/e2e/helpers/test-user.ts`

**Step 1: Create e2e directory structure**

```bash
mkdir -p /mnt/c/VelikiBukovec_web/apps/admin/e2e/helpers
```

**Step 2: Create database helper**

Create `apps/admin/e2e/helpers/db.ts`:

```typescript
import { PrismaClient } from '@prisma/client';

// Direct Prisma client for test assertions (bypasses Better Auth)
const prisma = new PrismaClient();

export async function getSessionCount(userId: string): Promise<number> {
  return prisma.session.count({
    where: { userId },
  });
}

export async function getSessionByUserId(userId: string) {
  return prisma.session.findFirst({
    where: { userId },
    orderBy: { createdAt: 'desc' },
  });
}

export async function getUserByEmail(email: string) {
  return prisma.user.findUnique({
    where: { email },
  });
}

export async function clearUserSessions(userId: string): Promise<void> {
  await prisma.session.deleteMany({
    where: { userId },
  });
}

export async function disconnectDb(): Promise<void> {
  await prisma.$disconnect();
}
```

**Step 3: Create test user helper**

Create `apps/admin/e2e/helpers/test-user.ts`:

```typescript
// Test user credentials (must match seed.ts)
export const TEST_USER = {
  email: 'admin@velikibukovec.hr',
  password: '<TEST_PASSWORD>',
} as const;
```

**Step 4: Commit**

```bash
git add apps/admin/e2e/
git commit -m "$(cat <<'EOF'
test(admin): add E2E test helpers

- Database helper for session assertions
- Test user credentials from seed

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 4: Write Login Creates Session Test

**Files:**
- Create: `apps/admin/e2e/auth.spec.ts`

**Step 1: Create auth E2E test file**

Create `apps/admin/e2e/auth.spec.ts`:

```typescript
import { expect, test } from '@playwright/test';

import {
  clearUserSessions,
  disconnectDb,
  getSessionByUserId,
  getUserByEmail,
} from './helpers/db';
import { TEST_USER } from './helpers/test-user';

test.describe('Authentication Flow', () => {
  let testUserId: string;

  test.beforeAll(async () => {
    // Get test user ID for session assertions
    const user = await getUserByEmail(TEST_USER.email);
    if (!user) {
      throw new Error(
        `Test user ${TEST_USER.email} not found. Run: pnpm db:seed`
      );
    }
    testUserId = user.id;
  });

  test.beforeEach(async () => {
    // Clear sessions before each test for clean state
    await clearUserSessions(testUserId);
  });

  test.afterAll(async () => {
    await disconnectDb();
  });

  test('login creates session in database', async ({ page }) => {
    // Navigate to login page
    await page.goto('/login');

    // Fill in credentials
    await page.fill('input[type="email"]', TEST_USER.email);
    await page.fill('input[type="password"]', TEST_USER.password);

    // Submit form
    await page.click('button[type="submit"]');

    // Wait for redirect to dashboard
    await page.waitForURL('/');

    // Verify session was created in database
    const session = await getSessionByUserId(testUserId);
    expect(session).not.toBeNull();
    expect(session?.userId).toBe(testUserId);
    expect(new Date(session!.expiresAt).getTime()).toBeGreaterThan(Date.now());
  });
});
```

**Step 2: Run test to verify it works**

```bash
cd /mnt/c/VelikiBukovec_web/apps/admin && pnpm test:e2e
```

Expected: PASS (if database and seed are configured)

**Step 3: Commit**

```bash
git add apps/admin/e2e/auth.spec.ts
git commit -m "$(cat <<'EOF'
test(admin): add login creates session E2E test

Verifies that successful login creates a session record in the database.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 5: Write Protected Route Redirect Test

**Files:**
- Modify: `apps/admin/e2e/auth.spec.ts`

**Step 1: Add protected route test**

Add to `apps/admin/e2e/auth.spec.ts` inside the describe block:

```typescript
  test('protected route redirects to login when not authenticated', async ({
    page,
  }) => {
    // Try to access dashboard directly without login
    await page.goto('/');

    // Should redirect to login page
    await page.waitForURL('/login');

    // Verify we're on login page
    expect(page.url()).toContain('/login');

    // Login form should be visible
    await expect(page.locator('input[type="email"]')).toBeVisible();
    await expect(page.locator('input[type="password"]')).toBeVisible();
  });
```

**Step 2: Run test to verify**

```bash
cd /mnt/c/VelikiBukovec_web/apps/admin && pnpm test:e2e
```

Expected: 2 tests PASS

**Step 3: Commit**

```bash
git add apps/admin/e2e/auth.spec.ts
git commit -m "$(cat <<'EOF'
test(admin): add protected route redirect E2E test

Verifies unauthenticated users are redirected to login.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 6: Write Logout Clears Session Test

**Files:**
- Modify: `apps/admin/e2e/auth.spec.ts`

**Step 1: Add logout test**

Add to `apps/admin/e2e/auth.spec.ts` inside the describe block:

```typescript
  test('logout clears session from database', async ({ page }) => {
    // First, login
    await page.goto('/login');
    await page.fill('input[type="email"]', TEST_USER.email);
    await page.fill('input[type="password"]', TEST_USER.password);
    await page.click('button[type="submit"]');
    await page.waitForURL('/');

    // Verify session exists
    let session = await getSessionByUserId(testUserId);
    expect(session).not.toBeNull();

    // Click logout button
    await page.click('button:has-text("Odjava")');

    // Wait for redirect to login
    await page.waitForURL('/login');

    // Verify session was cleared from database
    session = await getSessionByUserId(testUserId);
    expect(session).toBeNull();
  });
```

**Step 2: Run test to verify**

```bash
cd /mnt/c/VelikiBukovec_web/apps/admin && pnpm test:e2e
```

Expected: 3 tests PASS

**Step 3: Commit**

```bash
git add apps/admin/e2e/auth.spec.ts
git commit -m "$(cat <<'EOF'
test(admin): add logout clears session E2E test

Verifies that logout removes the session from database.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 7: Add test:e2e Script to Root and Turbo

**Files:**
- Modify: `package.json` (root)
- Modify: `turbo.json`

**Step 1: Add test:e2e to root package.json**

Add to root `package.json` scripts:

```json
"test:e2e": "turbo run test:e2e"
```

**Step 2: Add test:e2e task to turbo.json**

Add to `turbo.json` tasks:

```json
"test:e2e": {
  "dependsOn": ["^build"],
  "cache": false
}
```

**Step 3: Verify all previous gates still pass**

```bash
cd /mnt/c/VelikiBukovec_web && pnpm lint && pnpm type-check && pnpm test && pnpm build
```

Expected: All pass

**Step 4: Commit**

```bash
git add package.json turbo.json
git commit -m "$(cat <<'EOF'
chore: add test:e2e script to turbo pipeline

Gate command for Sprint 0.6: pnpm test:e2e

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 8: Run Full E2E Gate and Update Status

**Files:**
- Modify: `ROADMAP.md`
- Modify: `CHANGELOG.md`

**Step 1: Run the Sprint 0.6 gate**

```bash
cd /mnt/c/VelikiBukovec_web && pnpm test:e2e
```

Expected: All 3 E2E tests pass

**Step 2: Update ROADMAP.md**

Change Sprint 0.6 status from `â¬œ` to `âœ…`:

```markdown
| 0.6 âœ… | Integration verify | ðŸ”— | 0.2-0.5 | Full auth flow with DB works |
```

Update Phase 0 progress to `6/6`:

```markdown
**Status:** Completed | **Progress:** 6/6 | **Track:** A
```

Update Active Sprint to Phase 1.1:

```markdown
**Active Sprint:** 1.1 - Admin Layout Shell
```

**Step 3: Update CHANGELOG.md**

Add under Unreleased:

```markdown
- Sprint 0.6: Added Playwright E2E tests for auth flow (login, protected routes, logout)
```

Move Sprint 0.5 entry if needed and add:

```markdown
## Sprint 0.6 - Integration Verification (Completed)
- Playwright E2E testing configured
- Auth flow tests: login creates session, protected routes redirect, logout clears session
- Gate: pnpm test:e2e passes all tests
```

**Step 4: Commit**

```bash
git add ROADMAP.md CHANGELOG.md
git commit -m "$(cat <<'EOF'
docs: complete Sprint 0.6 - Integration Verification

Phase 0 complete! All foundation sprints finished:
- 0.1: Project scaffold
- 0.2: Database schema
- 0.3: Better Auth setup
- 0.4: UI foundation
- 0.5: CI/CD pipeline
- 0.6: Integration verification (E2E tests)

Next: Phase 1.1 - Admin Layout Shell

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Sprint 0.6 Acceptance Criteria Checklist

| Criteria | Verified By |
|----------|-------------|
| Admin app connects to database | E2E tests query DB directly via Prisma |
| Login creates session in database | `auth.spec.ts` - "login creates session" test |
| Protected routes redirect to login | `auth.spec.ts` - "protected route redirects" test |
| Logout clears session | `auth.spec.ts` - "logout clears session" test |
| All previous gates still pass | Task 7 Step 3 verification |

## Gate Command

```bash
pnpm test:e2e
```

Expected output: 3 tests passed in auth.spec.ts
