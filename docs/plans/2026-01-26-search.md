# Search (Basic) Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add global search with Cmd+K shortcut, PostgreSQL full-text search, and grouped results.

**Architecture:** Search modal triggered by header input (desktop) or icon (mobile). API queries SearchIndex table using tsvector. Results grouped by type with relevance scoring.

**Tech Stack:** Next.js App Router, PostgreSQL tsvector/tsquery, Radix Dialog, localStorage.

---

## Task 1: Database setup for full-text search

**Files:**
- Modify: `packages/database/prisma/schema.prisma`
- Create: `packages/database/prisma/migrations/add_search_index_constraint/migration.sql`

**Implementation:**
- Add unique constraint on SearchIndex (sourceType + sourceId)
- Schema already has search_vector tsvector column
- Create GIN index on search_vector via raw SQL migration

**Schema change:**
```prisma
model SearchIndex {
  // ... existing fields
  @@unique([sourceType, sourceId])
}
```

**Migration SQL:**
```sql
-- Create GIN index for full-text search
CREATE INDEX IF NOT EXISTS idx_search_index_vector
ON search_index USING gin(search_vector);

-- Create index on source lookup
CREATE UNIQUE INDEX IF NOT EXISTS idx_search_index_source
ON search_index(source_type, source_id);
```

---

## Task 2: Create search API route

**Files:**
- Create: `apps/web/app/api/search/route.ts`

**Implementation:**
- GET handler with query parameter `q`
- Validate query (min 2 chars)
- Query SearchIndex with plainto_tsquery
- Use ts_rank for relevance scoring
- Use ts_headline for highlighted snippets
- Group results by sourceType
- Limit to top 5 per type, 20 total
- Return grouped results with highlights

**Response type:**
```typescript
interface SearchResponse {
  results: {
    posts: SearchResult[];
    documents: SearchResult[];
    pages: SearchResult[];
    events: SearchResult[];
  };
  totalCount: number;
  query: string;
}

interface SearchResult {
  id: string;
  title: string;
  url: string;
  category?: string;
  date?: string;
  highlights: string;
}
```

---

## Task 3: Create search indexing utilities

**Files:**
- Create: `packages/database/src/search/index.ts`
- Create: `packages/database/src/search/indexer.ts`
- Modify: `packages/database/src/index.ts`

**Implementation:**
- `indexPost(post)` - Index a post into SearchIndex
- `indexDocument(document)` - Index a document
- `indexPage(page)` - Index a page
- `indexEvent(event)` - Index an event
- `removeFromIndex(sourceType, sourceId)` - Remove entry
- `stripHtml(html)` - Utility to strip HTML tags for content_text
- Each indexer updates search_vector via raw SQL

---

## Task 4: Integrate indexing into admin APIs

**Files:**
- Modify: `apps/admin/app/api/posts/route.ts`
- Modify: `apps/admin/app/api/posts/[id]/route.ts`
- Modify: `apps/admin/app/api/documents/route.ts`
- Modify: `apps/admin/app/api/documents/[id]/route.ts`
- Modify: `apps/admin/app/api/pages/route.ts`
- Modify: `apps/admin/app/api/pages/[id]/route.ts`
- Modify: `apps/admin/app/api/events/route.ts`
- Modify: `apps/admin/app/api/events/[id]/route.ts`

**Implementation:**
- On POST (create): Call appropriate indexer after saving
- On PUT/PATCH (update): Call indexer to update
- On DELETE: Call removeFromIndex
- Only index published posts (publishedAt not null)

---

## Task 5: Create useRecentSearches hook

**Files:**
- Create: `packages/ui/src/hooks/use-recent-searches.ts`
- Create: `packages/ui/src/hooks/use-recent-searches.test.ts`

**Implementation:**
- localStorage key: 'velikibukovec-recent-searches'
- Max 5 recent searches
- Functions: getRecentSearches, addRecentSearch, removeRecentSearch, clearRecentSearches
- Each entry: { query: string, timestamp: number }
- Sorted by timestamp descending (newest first)
- SSR-safe (check for window)

---

## Task 6: Create useSearch hook

**Files:**
- Create: `packages/ui/src/hooks/use-search.ts`
- Create: `packages/ui/src/hooks/use-search.test.ts`

**Implementation:**
- State: query, results, isLoading, error, selectedIndex
- Debounced fetch (150ms)
- Keyboard navigation: selectedIndex cycles through flat results
- Functions: search(query), clearResults, navigateUp, navigateDown, selectCurrent
- Integrates with useRecentSearches (add on select)

---

## Task 7: Create SearchResultItem component

**Files:**
- Create: `packages/ui/src/components/search-result-item.tsx`

**Implementation:**
- Props: result, isSelected, onClick, type
- Icon by type (Newspaper, FileText, File, Calendar)
- Title with dangerouslySetInnerHTML for highlights (<mark> tags)
- Excerpt/highlights text
- Category/date metadata
- Selected state styling (background highlight)
- Keyboard focus styles

---

## Task 8: Create SearchResults component

**Files:**
- Create: `packages/ui/src/components/search-results.tsx`

**Implementation:**
- Props: results (grouped), selectedIndex, onSelect, isLoading
- Group headers: "Vijesti", "Dokumenti", "Stranice", "Događanja"
- Only show groups with results
- Loading skeleton state
- Empty state: "Nema rezultata"
- Maps selectedIndex to correct item across groups

---

## Task 9: Create SearchModal component

**Files:**
- Create: `packages/ui/src/components/search-modal.tsx`
- Create: `packages/ui/src/components/search-modal.test.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**
- Uses Dialog primitive from Radix
- Props: isOpen, onClose
- Large search input with autofocus
- Keyboard shortcut hint (Cmd+K) on desktop
- Recent searches section when query empty
- SearchResults component for results
- Keyboard event handling (↑↓ Enter Esc)
- Mobile: full-screen variant (className based on breakpoint)
- Footer with keyboard hints

---

## Task 10: Create SearchTrigger component

**Files:**
- Create: `packages/ui/src/components/search-trigger.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**
- Props: onOpen
- Desktop (md+): Input-like button with search icon, "Pretraži..." placeholder, Cmd+K badge
- Mobile: Icon button only
- Uses Tailwind responsive classes
- Accessible: proper button role, aria-label

---

## Task 11: Add global keyboard shortcut handler

**Files:**
- Create: `packages/ui/src/hooks/use-search-shortcut.ts`
- Modify: `packages/ui/src/index.ts`

**Implementation:**
- useEffect with keydown listener
- Detects Cmd+K (Mac) or Ctrl+K (Windows)
- Prevents default browser behavior
- Calls provided onOpen callback
- Cleanup on unmount

---

## Task 12: Integrate search into public header

**Files:**
- Modify: `packages/ui/src/components/nav-menu.tsx` (or header component)
- Create: `apps/web/app/components/search-provider.tsx` (if needed)

**Implementation:**
- Add SearchTrigger to header
- Add SearchModal (rendered once at top level)
- Wire up useSearchShortcut
- State management for modal open/close
- Test on mobile and desktop layouts

---

## Task 13: Create backfill script for existing content

**Files:**
- Create: `packages/database/src/scripts/backfill-search-index.ts`
- Modify: `packages/database/package.json` (add script)

**Implementation:**
- Fetch all published posts, documents, pages, events
- Index each into SearchIndex
- Update search_vector for all entries
- Progress logging
- Run with: `pnpm --filter @repo/database run backfill-search`

---

## Task 14: Final verification and testing

**Steps:**
- Run database migration
- Run backfill script
- Run lint, type-check, tests
- Manual testing:
  - Cmd+K opens modal
  - Search returns grouped results
  - Keyboard navigation works
  - Recent searches persist
  - Mobile layout correct
- Update CHANGELOG.md
- Update ROADMAP.md (mark 2.10 complete)

---

## Summary

| Task | Component | Key Files |
|------|-----------|-----------|
| 1 | Database setup | `schema.prisma`, migration SQL |
| 2 | Search API | `apps/web/app/api/search/route.ts` |
| 3 | Indexing utilities | `packages/database/src/search/` |
| 4 | Admin API integration | `apps/admin/app/api/*/route.ts` |
| 5 | useRecentSearches | `packages/ui/src/hooks/use-recent-searches.ts` |
| 6 | useSearch | `packages/ui/src/hooks/use-search.ts` |
| 7 | SearchResultItem | `packages/ui/src/components/search-result-item.tsx` |
| 8 | SearchResults | `packages/ui/src/components/search-results.tsx` |
| 9 | SearchModal | `packages/ui/src/components/search-modal.tsx` |
| 10 | SearchTrigger | `packages/ui/src/components/search-trigger.tsx` |
| 11 | Keyboard shortcut | `packages/ui/src/hooks/use-search-shortcut.ts` |
| 12 | Header integration | `packages/ui/src/components/nav-menu.tsx` |
| 13 | Backfill script | `packages/database/src/scripts/backfill-search-index.ts` |
| 14 | Verification | CHANGELOG, ROADMAP |
