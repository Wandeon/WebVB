# Sprint 2.5 - Documents Section Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build the public documents page at `/dokumenti` with category sidebar, year filter, search, and downloadable PDF list.

**Architecture:** Server Component page fetching documents with URL-driven filtering. Desktop uses sticky sidebar for categories; mobile uses accordion. Client-side search filters displayed documents instantly.

**Tech Stack:** Next.js 15 App Router, React Server Components, Tailwind CSS, @repo/database repository, shadcn Accordion/Select primitives.

---

## Task 1: Add repository methods for documents page

**Files:**
- Modify: `packages/database/src/repositories/documents.ts`

**Implementation:**

Add these two methods to `documentsRepository`:

```typescript
/**
 * Get distinct years from documents for year filter dropdown
 */
async getDistinctYears(): Promise<number[]> {
  const results = await db.document.findMany({
    where: { year: { not: null } },
    select: { year: true },
    distinct: ['year'],
    orderBy: { year: 'desc' },
  });
  return results.map((r) => r.year!);
},

/**
 * Get document counts per category for sidebar badges
 */
async getCategoryCounts(): Promise<Record<string, number>> {
  const results = await db.document.groupBy({
    by: ['category'],
    _count: { id: true },
  });
  return Object.fromEntries(
    results.map((r) => [r.category, r._count.id])
  );
},
```

**Verify:** `pnpm type-check`

**Commit:** `feat(database): add getDistinctYears and getCategoryCounts for documents page`

---

## Task 2: Create DocumentCard component

**Files:**
- Create: `packages/ui/src/components/document-card.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
import { FileText, Download } from 'lucide-react';

import { Badge } from '../primitives/badge';
import { Button } from '../primitives/button';
import { cn } from '../lib/utils';

export interface DocumentCardProps {
  title: string;
  fileUrl: string;
  fileSize: number | null;
  createdAt: Date;
  className?: string;
}

function formatFileSize(bytes: number | null): string {
  if (!bytes) return '';
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${Math.round(bytes / 1024)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('hr-HR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(new Date(date));
}

export function DocumentCard({
  title,
  fileUrl,
  fileSize,
  createdAt,
  className,
}: DocumentCardProps) {
  return (
    <div
      className={cn(
        'flex items-center justify-between gap-4 rounded-lg border border-neutral-200 bg-white p-4 transition-colors hover:border-primary-300 hover:bg-primary-50/50',
        className
      )}
    >
      <div className="flex min-w-0 items-center gap-3">
        <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-red-100 text-red-600">
          <FileText className="h-5 w-5" />
        </div>
        <div className="min-w-0">
          <h3 className="truncate font-medium text-neutral-900">{title}</h3>
          <div className="flex items-center gap-2 text-sm text-neutral-500">
            <span>{formatDate(createdAt)}</span>
            {fileSize && (
              <>
                <span>•</span>
                <Badge variant="secondary" className="text-xs">
                  {formatFileSize(fileSize)}
                </Badge>
              </>
            )}
          </div>
        </div>
      </div>
      <Button
        variant="outline"
        size="sm"
        asChild
        className="shrink-0"
      >
        <a
          href={fileUrl}
          target="_blank"
          rel="noopener noreferrer"
          aria-label={`Preuzmi ${title}`}
        >
          <Download className="mr-2 h-4 w-4" />
          Preuzmi
        </a>
      </Button>
    </div>
  );
}
```

**Export:** Add `export * from './components/document-card';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add DocumentCard component for document listing`

---

## Task 3: Create DocumentSidebar component

**Files:**
- Create: `packages/ui/src/components/document-sidebar.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
'use client';

import Link from 'next/link';

import { cn } from '../lib/utils';

export interface DocumentSidebarProps {
  categories: { value: string; label: string }[];
  activeCategory: string | undefined;
  counts: Record<string, number>;
  className?: string;
}

export function DocumentSidebar({
  categories,
  activeCategory,
  counts,
  className,
}: DocumentSidebarProps) {
  return (
    <nav
      aria-label="Kategorije dokumenata"
      className={cn('', className)}
    >
      <h2 className="mb-4 text-sm font-semibold uppercase tracking-wider text-neutral-500">
        Kategorije
      </h2>
      <ul className="space-y-1">
        <li>
          <Link
            href="/dokumenti"
            className={cn(
              'flex items-center justify-between rounded-md px-3 py-2 text-sm transition-colors',
              !activeCategory
                ? 'bg-primary-100 font-medium text-primary-900'
                : 'text-neutral-700 hover:bg-neutral-100'
            )}
            aria-current={!activeCategory ? 'page' : undefined}
          >
            <span>Sve kategorije</span>
            <span className="text-xs text-neutral-500">
              {Object.values(counts).reduce((a, b) => a + b, 0)}
            </span>
          </Link>
        </li>
        {categories.map((cat) => (
          <li key={cat.value}>
            <Link
              href={`/dokumenti?kategorija=${cat.value}`}
              className={cn(
                'flex items-center justify-between rounded-md px-3 py-2 text-sm transition-colors',
                activeCategory === cat.value
                  ? 'bg-primary-100 font-medium text-primary-900'
                  : 'text-neutral-700 hover:bg-neutral-100'
              )}
              aria-current={activeCategory === cat.value ? 'page' : undefined}
            >
              <span>{cat.label}</span>
              <span className="text-xs text-neutral-500">
                {counts[cat.value] || 0}
              </span>
            </Link>
          </li>
        ))}
      </ul>
    </nav>
  );
}
```

**Export:** Add `export * from './components/document-sidebar';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add DocumentSidebar component for category navigation`

---

## Task 4: Create DocumentAccordion component

**Files:**
- Create: `packages/ui/src/components/document-accordion.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
'use client';

import Link from 'next/link';

import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '../primitives/accordion';
import { cn } from '../lib/utils';

export interface DocumentAccordionProps {
  categories: { value: string; label: string }[];
  activeCategory: string | undefined;
  counts: Record<string, number>;
  className?: string;
}

export function DocumentAccordion({
  categories,
  activeCategory,
  counts,
  className,
}: DocumentAccordionProps) {
  const totalCount = Object.values(counts).reduce((a, b) => a + b, 0);

  return (
    <Accordion
      type="single"
      collapsible
      defaultValue={activeCategory ? 'categories' : undefined}
      className={cn('', className)}
    >
      <AccordionItem value="categories" className="border-b-0">
        <AccordionTrigger className="rounded-lg bg-neutral-100 px-4 hover:bg-neutral-200 hover:no-underline">
          <span className="text-sm font-semibold">
            {activeCategory
              ? categories.find((c) => c.value === activeCategory)?.label
              : 'Sve kategorije'}
          </span>
        </AccordionTrigger>
        <AccordionContent className="pt-2">
          <nav aria-label="Kategorije dokumenata">
            <ul className="space-y-1">
              <li>
                <Link
                  href="/dokumenti"
                  className={cn(
                    'flex items-center justify-between rounded-md px-3 py-2 text-sm transition-colors',
                    !activeCategory
                      ? 'bg-primary-100 font-medium text-primary-900'
                      : 'text-neutral-700 hover:bg-neutral-100'
                  )}
                >
                  <span>Sve kategorije</span>
                  <span className="text-xs text-neutral-500">{totalCount}</span>
                </Link>
              </li>
              {categories.map((cat) => (
                <li key={cat.value}>
                  <Link
                    href={`/dokumenti?kategorija=${cat.value}`}
                    className={cn(
                      'flex items-center justify-between rounded-md px-3 py-2 text-sm transition-colors',
                      activeCategory === cat.value
                        ? 'bg-primary-100 font-medium text-primary-900'
                        : 'text-neutral-700 hover:bg-neutral-100'
                    )}
                  >
                    <span>{cat.label}</span>
                    <span className="text-xs text-neutral-500">
                      {counts[cat.value] || 0}
                    </span>
                  </Link>
                </li>
              ))}
            </ul>
          </nav>
        </AccordionContent>
      </AccordionItem>
    </Accordion>
  );
}
```

**Export:** Add `export * from './components/document-accordion';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add DocumentAccordion component for mobile category navigation`

---

## Task 5: Create YearFilter component

**Files:**
- Create: `packages/ui/src/components/year-filter.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { useCallback } from 'react';

import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '../primitives/select';
import { cn } from '../lib/utils';

export interface YearFilterProps {
  years: number[];
  className?: string;
}

export function YearFilter({ years, className }: YearFilterProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const currentYear = searchParams.get('godina');

  const handleYearChange = useCallback(
    (value: string) => {
      const params = new URLSearchParams(searchParams.toString());
      if (value === 'all') {
        params.delete('godina');
      } else {
        params.set('godina', value);
      }
      params.delete('stranica'); // Reset to page 1
      router.push(`/dokumenti?${params.toString()}`);
    },
    [router, searchParams]
  );

  return (
    <Select value={currentYear || 'all'} onValueChange={handleYearChange}>
      <SelectTrigger className={cn('w-[180px]', className)}>
        <SelectValue placeholder="Odaberi godinu" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="all">Sve godine</SelectItem>
        {years.map((year) => (
          <SelectItem key={year} value={year.toString()}>
            {year}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
}
```

**Export:** Add `export * from './components/year-filter';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add YearFilter dropdown component`

---

## Task 6: Create DocumentSearch component

**Files:**
- Create: `packages/ui/src/components/document-search.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
'use client';

import { Search, X } from 'lucide-react';
import { useCallback, useState } from 'react';

import { Input } from '../primitives/input';
import { Button } from '../primitives/button';
import { cn } from '../lib/utils';

export interface DocumentSearchProps {
  onSearch: (query: string) => void;
  className?: string;
}

export function DocumentSearch({ onSearch, className }: DocumentSearchProps) {
  const [query, setQuery] = useState('');

  const handleChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      const value = e.target.value;
      setQuery(value);
      onSearch(value);
    },
    [onSearch]
  );

  const handleClear = useCallback(() => {
    setQuery('');
    onSearch('');
  }, [onSearch]);

  return (
    <div className={cn('relative', className)}>
      <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-neutral-400" />
      <Input
        type="search"
        placeholder="Pretraži dokumente..."
        value={query}
        onChange={handleChange}
        className="pl-10 pr-10"
        aria-label="Pretraži dokumente"
      />
      {query && (
        <Button
          variant="ghost"
          size="sm"
          onClick={handleClear}
          className="absolute right-1 top-1/2 h-7 w-7 -translate-y-1/2 p-0"
          aria-label="Obriši pretragu"
        >
          <X className="h-4 w-4" />
        </Button>
      )}
    </div>
  );
}
```

**Export:** Add `export * from './components/document-search';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add DocumentSearch component with clear button`

---

## Task 7: Create documents page

**Files:**
- Create: `apps/web/app/dokumenti/page.tsx`

**Implementation:**

```tsx
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

import { documentsRepository } from '@repo/database';
import { DOCUMENT_CATEGORY_OPTIONS } from '@repo/shared';
import {
  DocumentAccordion,
  DocumentCard,
  DocumentSidebar,
  FadeIn,
  Pagination,
} from '@repo/ui';

import { DocumentsClient } from './documents-client';

import type { Metadata } from 'next';

export const revalidate = 60;

interface DocumentsPageProps {
  searchParams: Promise<{
    kategorija?: string;
    godina?: string;
    stranica?: string;
  }>;
}

export async function generateMetadata({
  searchParams,
}: DocumentsPageProps): Promise<Metadata> {
  const { kategorija } = await searchParams;
  const categoryLabel = kategorija
    ? DOCUMENT_CATEGORY_OPTIONS.find((c) => c.value === kategorija)?.label
    : null;

  return {
    title: categoryLabel ? `${categoryLabel} - Dokumenti` : 'Dokumenti',
    description:
      'Službeni dokumenti Općine Veliki Bukovec - sjednice, proračun, planovi, javna nabava i drugi javni dokumenti.',
    openGraph: {
      title: categoryLabel
        ? `${categoryLabel} - Dokumenti - Općina Veliki Bukovec`
        : 'Dokumenti - Općina Veliki Bukovec',
      description: 'Pristupite službenim dokumentima općine.',
      type: 'website',
    },
  };
}

export default async function DocumentsPage({
  searchParams,
}: DocumentsPageProps) {
  const params = await searchParams;
  const category = params.kategorija;
  const year = params.godina ? parseInt(params.godina, 10) : undefined;
  const page = params.stranica ? parseInt(params.stranica, 10) : 1;

  const [{ documents, pagination }, counts, years] = await Promise.all([
    documentsRepository.findAll({
      category,
      year: Number.isFinite(year) ? year : undefined,
      page: Number.isFinite(page) && page > 0 ? page : 1,
      limit: 20,
      sortBy: 'createdAt',
      sortOrder: 'desc',
    }),
    documentsRepository.getCategoryCounts(),
    documentsRepository.getDistinctYears(),
  ]);

  return (
    <>
      {/* Back link */}
      <div className="container mx-auto px-4 py-4">
        <Link
          href="/"
          className="inline-flex items-center gap-2 text-sm text-neutral-600 hover:text-primary-600"
        >
          <ArrowLeft className="h-4 w-4" />
          Povratak na početnu
        </Link>
      </div>

      {/* Header */}
      <div className="container mx-auto px-4 pb-6">
        <FadeIn>
          <h1 className="font-display text-3xl font-bold text-neutral-900 md:text-4xl">
            Dokumenti
          </h1>
          <p className="mt-2 text-neutral-600">
            Službeni dokumenti Općine Veliki Bukovec
          </p>
        </FadeIn>
      </div>

      {/* Main content */}
      <div className="container mx-auto px-4 pb-12">
        <div className="grid gap-8 lg:grid-cols-[250px,1fr]">
          {/* Sidebar - Desktop */}
          <FadeIn className="hidden lg:block">
            <div className="sticky top-8">
              <DocumentSidebar
                categories={DOCUMENT_CATEGORY_OPTIONS}
                activeCategory={category}
                counts={counts}
              />
            </div>
          </FadeIn>

          {/* Main content area */}
          <div>
            {/* Mobile accordion */}
            <div className="mb-6 lg:hidden">
              <DocumentAccordion
                categories={DOCUMENT_CATEGORY_OPTIONS}
                activeCategory={category}
                counts={counts}
              />
            </div>

            {/* Client wrapper for search and filtering */}
            <DocumentsClient
              documents={documents}
              years={years}
              pagination={pagination}
              category={category}
            />
          </div>
        </div>
      </div>
    </>
  );
}
```

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(web): add documents page with sidebar and accordion navigation`

---

## Task 8: Create DocumentsClient component

**Files:**
- Create: `apps/web/app/dokumenti/documents-client.tsx`

**Implementation:**

```tsx
'use client';

import { useMemo, useState } from 'react';

import type { DocumentWithUploader } from '@repo/database';
import {
  DocumentCard,
  DocumentSearch,
  FadeIn,
  Pagination,
  YearFilter,
} from '@repo/ui';

interface DocumentsClientProps {
  documents: DocumentWithUploader[];
  years: number[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
  category: string | undefined;
}

export function DocumentsClient({
  documents,
  years,
  pagination,
  category,
}: DocumentsClientProps) {
  const [searchQuery, setSearchQuery] = useState('');

  const filteredDocuments = useMemo(() => {
    if (!searchQuery.trim()) return documents;
    const query = searchQuery.toLowerCase();
    return documents.filter((doc) =>
      doc.title.toLowerCase().includes(query)
    );
  }, [documents, searchQuery]);

  const buildPageUrl = (page: number) => {
    const params = new URLSearchParams();
    if (category) params.set('kategorija', category);
    params.set('stranica', page.toString());
    return `/dokumenti?${params.toString()}`;
  };

  return (
    <>
      {/* Filters */}
      <div className="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <DocumentSearch onSearch={setSearchQuery} className="sm:max-w-xs" />
        <YearFilter years={years} />
      </div>

      {/* Results count */}
      <p className="mb-4 text-sm text-neutral-500">
        {searchQuery
          ? `${filteredDocuments.length} od ${documents.length} dokumenata`
          : `${pagination.total} dokumenata`}
      </p>

      {/* Document list */}
      {filteredDocuments.length > 0 ? (
        <div className="space-y-3">
          {filteredDocuments.map((doc, index) => (
            <FadeIn key={doc.id} delay={index * 0.03}>
              <DocumentCard
                title={doc.title}
                fileUrl={doc.fileUrl}
                fileSize={doc.fileSize}
                createdAt={doc.createdAt}
              />
            </FadeIn>
          ))}
        </div>
      ) : (
        <FadeIn>
          <div className="rounded-lg border border-neutral-200 bg-neutral-50 p-8 text-center">
            <p className="text-neutral-600">
              {searchQuery
                ? `Nema rezultata za "${searchQuery}".`
                : 'Nema dokumenata.'}
            </p>
          </div>
        </FadeIn>
      )}

      {/* Pagination - only show if not searching and more than 1 page */}
      {!searchQuery && pagination.totalPages > 1 && (
        <div className="mt-8">
          <Pagination
            currentPage={pagination.page}
            totalPages={pagination.totalPages}
            buildPageUrl={buildPageUrl}
          />
        </div>
      )}
    </>
  );
}
```

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(web): add DocumentsClient with search and year filtering`

---

## Task 9: Final verification and documentation

**Step 1:** Run full verification
```bash
pnpm type-check && pnpm lint && pnpm test
```

**Step 2:** Update CHANGELOG.md - add Sprint 2.5 section

**Step 3:** Update ROADMAP.md - mark Sprint 2.5 complete, update progress to 5/12

**Commit:** `docs: update documentation for Sprint 2.5 completion`

---

## Summary

| Task | Component | Files |
|------|-----------|-------|
| 1 | Repository methods | `packages/database/src/repositories/documents.ts` |
| 2 | DocumentCard | `packages/ui/src/components/document-card.tsx` |
| 3 | DocumentSidebar | `packages/ui/src/components/document-sidebar.tsx` |
| 4 | DocumentAccordion | `packages/ui/src/components/document-accordion.tsx` |
| 5 | YearFilter | `packages/ui/src/components/year-filter.tsx` |
| 6 | DocumentSearch | `packages/ui/src/components/document-search.tsx` |
| 7 | Documents page | `apps/web/app/dokumenti/page.tsx` |
| 8 | DocumentsClient | `apps/web/app/dokumenti/documents-client.tsx` |
| 9 | Documentation | `CHANGELOG.md`, `ROADMAP.md` |

**Gate:** Browse documents at `/dokumenti`, filter by category via sidebar, filter by year, search filters list, download PDF works.
