# Sprint 7.6-7.8: Performance, Accessibility & Security Polish

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Achieve Lighthouse > 90, WCAG AA compliance, and NIS2 security checklist pass.

**Architecture:** These three sprints can run in parallel. Each focuses on a different aspect of production readiness: performance optimization (7.6), accessibility compliance (7.7), and security hardening (7.8).

**Tech Stack:** Next.js 16 (static export), Caddy (security headers), Lighthouse CLI, axe-core, OWASP ZAP

---

## Pre-requisites

Before starting, ensure you have:
```bash
# Install Lighthouse CLI globally
npm install -g lighthouse

# Install axe-core for accessibility testing
pnpm add -D @axe-core/playwright
```

---

## Task 1: Run Baseline Lighthouse Audit

**Files:**
- Create: `scripts/audit/lighthouse-audit.sh`
- Output: `docs/audits/lighthouse-baseline-2026-01-31.json`

**Step 1: Create Lighthouse audit script**

```bash
#!/bin/bash
# scripts/audit/lighthouse-audit.sh
# Run Lighthouse audit against production site

URL="${1:-http://100.120.125.83}"
OUTPUT_DIR="docs/audits"
TIMESTAMP=$(date +%Y-%m-%d)

mkdir -p "$OUTPUT_DIR"

echo "Running Lighthouse audit on $URL..."

lighthouse "$URL" \
  --output=json,html \
  --output-path="$OUTPUT_DIR/lighthouse-$TIMESTAMP" \
  --chrome-flags="--headless --no-sandbox" \
  --preset=desktop \
  --only-categories=performance,accessibility,best-practices,seo

echo "Audit complete. Results in $OUTPUT_DIR/"
```

**Step 2: Run the baseline audit**

```bash
chmod +x scripts/audit/lighthouse-audit.sh
./scripts/audit/lighthouse-audit.sh http://100.120.125.83
```

**Step 3: Record baseline scores**

Open the HTML report and note current scores for:
- Performance: ___
- Accessibility: ___
- Best Practices: ___
- SEO: ___

**Step 4: Commit**

```bash
git add scripts/audit/lighthouse-audit.sh
git commit -m "chore(audit): add Lighthouse audit script"
```

---

## Task 2: Add Content Security Policy (CSP)

**Files:**
- Modify: VPS `/etc/caddy/Caddyfile`

**Step 1: SSH to VPS and update Caddyfile**

```bash
ssh deploy@100.120.125.83
sudo nano /etc/caddy/Caddyfile
```

**Step 2: Add CSP header to the security headers block**

Find the `header { }` block and update to:

```caddyfile
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://pub-a73068f5593840f6a7942e3ad511f2d4.r2.dev https://*.openstreetmap.org; connect-src 'self' https://nominatim.openstreetmap.org; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
        # HSTS (only enable after confirming HTTPS works)
        # Strict-Transport-Security "max-age=31536000; includeSubDomains"
    }
```

**Step 3: Reload Caddy**

```bash
sudo systemctl reload caddy
```

**Step 4: Verify CSP header**

```bash
curl -I http://100.120.125.83 | grep -i content-security
```

Expected: `Content-Security-Policy: default-src 'self'; ...`

---

## Task 3: Optimize Large JavaScript Bundles

**Files:**
- Modify: `apps/web/next.config.ts`

**Step 1: Add bundle analyzer (optional, for inspection)**

```bash
pnpm add -D @next/bundle-analyzer --filter=@repo/web
```

**Step 2: Enable experimental optimizations in next.config.ts**

```typescript
// apps/web/next.config.ts
import createMDX from '@next/mdx';
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  output: 'export',

  // Disable image optimization for static export
  images: {
    unoptimized: true,
  },

  // Transpile workspace packages
  transpilePackages: ['@repo/ui', '@repo/shared', '@repo/database'],

  // Strict mode for better debugging
  reactStrictMode: true,

  // Enable MDX pages
  pageExtensions: ['js', 'jsx', 'md', 'mdx', 'ts', 'tsx'],

  // Performance optimizations
  experimental: {
    optimizePackageImports: ['lucide-react', 'framer-motion', '@repo/ui'],
  },
};

const withMDX = createMDX({
  extension: /\.mdx?$/,
});

export default withMDX(nextConfig);
```

**Step 3: Rebuild and check bundle sizes**

```bash
pnpm build --filter=@repo/web --force
ls -lah apps/web/out/_next/static/chunks/ | sort -k5 -h | tail -10
```

**Step 4: Commit**

```bash
git add apps/web/next.config.ts
git commit -m "perf: optimize package imports for smaller bundles"
```

---

## Task 4: Add Lazy Loading for Below-the-Fold Images

**Files:**
- Modify: `apps/web/app/page.tsx` (homepage)

**Step 1: Audit current Image components**

Search for images without `loading="lazy"`:

```bash
grep -r "Image" apps/web/app/page.tsx | grep -v "loading"
```

**Step 2: Add loading="lazy" to non-critical images**

For images below the fold (news cards, events, etc.), ensure they have:

```tsx
<Image
  src={post.featuredImage}
  alt={post.title}
  width={400}
  height={300}
  loading="lazy"  // Add this
  className="..."
/>
```

Keep `priority` only on hero images (above the fold).

**Step 3: Verify no layout shifts**

Ensure all images have explicit `width` and `height` or use `fill` with a sized container.

**Step 4: Commit**

```bash
git add apps/web/app/page.tsx
git commit -m "perf: add lazy loading for below-fold images"
```

---

## Task 5: Add ARIA Landmarks to Layout

**Files:**
- Modify: `apps/web/app/layout.tsx`
- Modify: `apps/web/components/layout/header.tsx`
- Modify: `apps/web/components/layout/footer.tsx`

**Step 1: Add role="banner" to header**

In `header.tsx`, ensure the header has proper landmark:

```tsx
<header
  role="banner"
  className="sticky top-0 z-50 ..."
>
```

**Step 2: Add role="contentinfo" to footer**

The Footer component in `@repo/ui` should already have this. Verify:

```bash
grep -r "role=" packages/ui/src/components/footer.tsx
```

If missing, add `role="contentinfo"` to the footer element.

**Step 3: Verify main landmark exists**

In `layout.tsx`, confirm:

```tsx
<main id="main-content" role="main" className="flex-1">
```

**Step 4: Commit**

```bash
git add apps/web/app/layout.tsx apps/web/components/layout/header.tsx
git commit -m "a11y: add ARIA landmarks to layout"
```

---

## Task 6: Add Focus Indicators for Keyboard Navigation

**Files:**
- Modify: `apps/web/app/globals.css`

**Step 1: Add visible focus styles**

Add to `globals.css`:

```css
/* Visible focus indicators for keyboard navigation */
:focus-visible {
  outline: 2px solid var(--color-primary-600);
  outline-offset: 2px;
}

/* Remove default focus ring but keep for keyboard users */
:focus:not(:focus-visible) {
  outline: none;
}

/* High contrast focus for interactive elements */
a:focus-visible,
button:focus-visible,
[role="button"]:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 3px solid var(--color-primary-600);
  outline-offset: 2px;
  border-radius: 2px;
}
```

**Step 2: Test keyboard navigation**

1. Open the site in browser
2. Press Tab repeatedly
3. Verify each focusable element has visible outline
4. Test Enter/Space activation

**Step 3: Commit**

```bash
git add apps/web/app/globals.css
git commit -m "a11y: add visible focus indicators for keyboard navigation"
```

---

## Task 7: Add Skip Links Enhancement

**Files:**
- Modify: `apps/web/app/layout.tsx`

**Step 1: Enhance skip link**

The skip link already exists. Enhance it:

```tsx
<a
  href="#main-content"
  className="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-[100] focus:rounded-md focus:bg-primary-600 focus:px-4 focus:py-2 focus:text-white focus:shadow-lg focus:outline-none focus:ring-2 focus:ring-white"
>
  Preskoči na glavni sadržaj
</a>
```

**Step 2: Add additional skip links for complex pages (optional)**

For pages with navigation, add:

```tsx
<div className="sr-only focus-within:not-sr-only focus-within:fixed focus-within:top-4 focus-within:left-4 focus-within:z-[100] focus-within:flex focus-within:flex-col focus-within:gap-2">
  <a href="#main-content" className="...">Preskoči na glavni sadržaj</a>
  <a href="#footer" className="...">Preskoči na podnožje</a>
</div>
```

**Step 3: Commit**

```bash
git add apps/web/app/layout.tsx
git commit -m "a11y: enhance skip links visibility"
```

---

## Task 8: Add robots.txt Security Directives

**Files:**
- Modify: `apps/web/app/robots.ts`

**Step 1: Update robots.ts with security paths**

```typescript
// apps/web/app/robots.ts
import type { MetadataRoute } from 'next';

export default function robots(): MetadataRoute.Robots {
  return {
    rules: [
      {
        userAgent: '*',
        allow: '/',
        disallow: [
          '/api/',
          '/_next/',
          '/admin/',
          '/*.json$',
          '/*?*', // Block query params from indexing
        ],
      },
    ],
    sitemap: 'https://velikibukovec.hr/sitemap.xml',
  };
}
```

**Step 2: Verify output**

```bash
pnpm build --filter=@repo/web --force
cat apps/web/out/robots.txt
```

**Step 3: Commit**

```bash
git add apps/web/app/robots.ts
git commit -m "security: add restrictive robots.txt directives"
```

---

## Task 9: Create Security Headers Test

**Files:**
- Create: `scripts/audit/check-security-headers.sh`

**Step 1: Create security headers checker**

```bash
#!/bin/bash
# scripts/audit/check-security-headers.sh
# Verify security headers are present

URL="${1:-http://100.120.125.83}"

echo "Checking security headers for $URL"
echo "=================================="

HEADERS=$(curl -sI "$URL")

check_header() {
  local header=$1
  if echo "$HEADERS" | grep -qi "$header"; then
    echo "✅ $header: PRESENT"
  else
    echo "❌ $header: MISSING"
  fi
}

check_header "X-Content-Type-Options"
check_header "X-Frame-Options"
check_header "X-XSS-Protection"
check_header "Referrer-Policy"
check_header "Content-Security-Policy"
check_header "Permissions-Policy"

echo ""
echo "Full headers:"
echo "$HEADERS"
```

**Step 2: Run the check**

```bash
chmod +x scripts/audit/check-security-headers.sh
./scripts/audit/check-security-headers.sh
```

Expected: All headers show ✅ PRESENT

**Step 3: Commit**

```bash
git add scripts/audit/check-security-headers.sh
git commit -m "chore(audit): add security headers checker script"
```

---

## Task 10: Add Playwright Accessibility Tests

**Files:**
- Create: `apps/web/e2e/accessibility.spec.ts`

**Step 1: Install axe-core for Playwright**

```bash
pnpm add -D @axe-core/playwright --filter=@repo/web
```

**Step 2: Create accessibility test file**

```typescript
// apps/web/e2e/accessibility.spec.ts
import AxeBuilder from '@axe-core/playwright';
import { expect, test } from '@playwright/test';

const PAGES_TO_TEST = [
  { path: '/', name: 'Homepage' },
  { path: '/vijesti', name: 'News listing' },
  { path: '/dokumenti', name: 'Documents' },
  { path: '/dogadanja', name: 'Events' },
  { path: '/kontakt', name: 'Contact' },
  { path: '/opcina', name: 'Municipality' },
];

test.describe('Accessibility', () => {
  for (const page of PAGES_TO_TEST) {
    test(`${page.name} should have no critical accessibility violations`, async ({ page: browserPage }) => {
      await browserPage.goto(page.path);

      const results = await new AxeBuilder({ page: browserPage })
        .withTags(['wcag2a', 'wcag2aa', 'wcag21aa'])
        .analyze();

      // Filter for critical and serious issues only
      const criticalViolations = results.violations.filter(
        v => v.impact === 'critical' || v.impact === 'serious'
      );

      expect(criticalViolations).toEqual([]);
    });
  }
});
```

**Step 3: Run accessibility tests**

```bash
cd apps/web
pnpm exec playwright test e2e/accessibility.spec.ts
```

**Step 4: Commit**

```bash
git add apps/web/e2e/accessibility.spec.ts apps/web/package.json pnpm-lock.yaml
git commit -m "test(a11y): add Playwright accessibility tests with axe-core"
```

---

## Task 11: NIS2 Compliance Checklist Verification

**Files:**
- Create: `docs/audits/nis2-checklist-2026-01-31.md`

**Step 1: Create NIS2 compliance document**

```markdown
# NIS2 Compliance Checklist

> Verified: 2026-01-31
> Site: Općina Veliki Bukovec (velikibukovec.hr)

## Security Architecture

| Requirement | Status | Evidence |
|-------------|--------|----------|
| Static site (no server-side execution on public) | ✅ | `output: 'export'` in next.config.ts |
| Admin isolated on separate subdomain | ✅ | admin.velikibukovec.hr |
| No PHP/WordPress vulnerabilities | ✅ | Next.js + TypeScript stack |
| No SQL injection possible on public site | ✅ | Static HTML, no database queries |

## Access Control

| Requirement | Status | Evidence |
|-------------|--------|----------|
| Role-based authentication | ✅ | Better Auth with super_admin/admin/staff |
| Strong password requirements | ✅ | Min 12 chars, complexity rules |
| 2FA available | ✅ | TOTP in Better Auth |
| Session management | ✅ | 24h default, 30d remember me |
| Rate limiting on login | ✅ | Better Auth rate limit plugin |

## Encryption

| Requirement | Status | Evidence |
|-------------|--------|----------|
| TLS everywhere (HTTPS) | ✅ | Cloudflare SSL |
| Secure password hashing | ✅ | bcrypt via Better Auth |
| Database encryption at rest | ✅ | Netcup disk encryption |

## Security Headers

| Header | Status |
|--------|--------|
| X-Content-Type-Options: nosniff | ✅ |
| X-Frame-Options: DENY | ✅ |
| X-XSS-Protection: 1; mode=block | ✅ |
| Referrer-Policy: strict-origin-when-cross-origin | ✅ |
| Content-Security-Policy | ✅ |
| Permissions-Policy | ✅ |

## Backup & Recovery

| Requirement | Status | Evidence |
|-------------|--------|----------|
| Daily automated backups | ✅ | 3am cron to R2 |
| Off-site storage | ✅ | Cloudflare R2 |
| Backup retention | ✅ | 90 days |
| Tested restore procedure | ⚠️ | Schedule quarterly test |

## Monitoring & Logging

| Requirement | Status | Evidence |
|-------------|--------|----------|
| Error tracking | ✅ | Sentry SDK installed |
| Uptime monitoring | ✅ | UptimeRobot configured |
| Admin action audit logs | ✅ | Better Auth audit plugin |
| Log rotation | ✅ | logrotate configured |

## Infrastructure Security

| Requirement | Status | Evidence |
|-------------|--------|----------|
| Firewall enabled | ✅ | UFW on VPS |
| SSH key-only authentication | ✅ | Password auth disabled |
| Fail2ban active | ✅ | Protects SSH |
| Services bound to localhost | ✅ | PostgreSQL, Ollama on 127.0.0.1 |
| Tailscale VPN for admin access | ✅ | All internal access via VPN |

## Compliance Summary

- **Critical Issues:** 0
- **Warnings:** 1 (backup restore test pending)
- **Status:** COMPLIANT (with note)
```

**Step 2: Commit**

```bash
git add docs/audits/nis2-checklist-2026-01-31.md
git commit -m "docs(audit): add NIS2 compliance checklist"
```

---

## Task 12: Run Final Lighthouse Audit

**Step 1: Rebuild and deploy**

```bash
pnpm build --filter=@repo/web --force
ssh deploy@100.120.125.83 "rm -rf ~/apps/web-static/*"
scp -r apps/web/out/* deploy@100.120.125.83:~/apps/web-static/
```

**Step 2: Run Lighthouse audit**

```bash
./scripts/audit/lighthouse-audit.sh http://100.120.125.83
```

**Step 3: Compare scores**

| Metric | Baseline | Final | Target |
|--------|----------|-------|--------|
| Performance | ___ | ___ | > 90 |
| Accessibility | ___ | ___ | > 90 |
| Best Practices | ___ | ___ | > 90 |
| SEO | ___ | ___ | > 90 |

**Step 4: Update ROADMAP.md**

Mark sprints 7.6, 7.7, 7.8 as complete with final scores.

**Step 5: Commit all changes**

```bash
git add docs/audits/ ROADMAP.md
git commit -m "chore: complete sprint 7.6-7.8 performance, a11y, security audits

Performance: [score]
Accessibility: [score]
Best Practices: [score]
SEO: [score]

All NIS2 requirements verified."
```

---

## Verification Checklist

### Sprint 7.6: Performance
- [ ] Lighthouse Performance score > 90
- [ ] Bundle sizes optimized (no chunk > 300KB)
- [ ] Images lazy-loaded below fold
- [ ] CSP header configured

### Sprint 7.7: Accessibility
- [ ] Lighthouse Accessibility score > 90
- [ ] axe-core tests pass (no critical/serious violations)
- [ ] Keyboard navigation works
- [ ] Skip links functional
- [ ] ARIA landmarks present

### Sprint 7.8: Security
- [ ] All security headers present
- [ ] CSP blocks inline scripts (where possible)
- [ ] robots.txt blocks sensitive paths
- [ ] NIS2 checklist documented and verified
- [ ] No secrets in code

---

## Troubleshooting

### CSP Breaking the Site

If CSP breaks functionality:
1. Open browser DevTools Console
2. Look for CSP violation errors
3. Add the required source to the appropriate directive
4. Test again

Common additions:
- `script-src`: Add domains for any external scripts
- `img-src`: Add CDN domains for images
- `connect-src`: Add API endpoints

### Lighthouse Score Not Improving

1. Check for render-blocking resources
2. Verify images are WebP format
3. Check for unused CSS/JS
4. Consider code splitting large components

### axe-core Violations

Common fixes:
- Missing alt text: Add `alt=""` for decorative images
- Low contrast: Increase text/background contrast
- Missing form labels: Add `<label>` or `aria-label`
- Heading order: Ensure h1 → h2 → h3 hierarchy
