# Sprint 5.5: Newsletter Send Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Enable admins to build newsletters by adding posts/announcements/events, preview, and send to all confirmed subscribers.

**Architecture:** Draft-based shopping cart pattern. Admin adds items from content lists ‚Üí items stored in database draft ‚Üí compose page shows preview ‚Üí send dispatches emails in batches. AI placeholders for future content generation.

**Tech Stack:** Next.js API routes, Prisma, Nodemailer (batched), React state for reordering, lucide-react icons

---

## Task 1: Database Schema - NewsletterDraft Model

**Files:**
- Modify: `packages/database/prisma/schema.prisma`

**Implementation:**

Add after the `NewsletterSend` model (around line 318):

```prisma
model NewsletterDraft {
  id        String   @id @default("singleton")
  introText String?  @map("intro_text") @db.Text
  items     Json     @default("[]") // [{type: 'post'|'announcement'|'event', id: string, addedAt: string}]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("newsletter_drafts")
}
```

**Run migration:**

```bash
cd /home/wandeon/WebVB
pnpm db:push
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add packages/database/prisma/schema.prisma
git commit -m "feat(newsletter): add NewsletterDraft model for draft persistence"
```

---

## Task 2: Newsletter Draft Repository

**Files:**
- Create: `packages/database/src/repositories/newsletter-draft.ts`
- Modify: `packages/database/src/repositories/index.ts`

**Implementation:**

Create `packages/database/src/repositories/newsletter-draft.ts`:

```typescript
import { db } from '../client';

export type NewsletterItemType = 'post' | 'announcement' | 'event';

export interface NewsletterDraftItem {
  type: NewsletterItemType;
  id: string;
  addedAt: string;
}

export interface NewsletterDraftRecord {
  id: string;
  introText: string | null;
  items: NewsletterDraftItem[];
  createdAt: Date;
  updatedAt: Date;
}

const DRAFT_ID = 'singleton';

export const newsletterDraftRepository = {
  /**
   * Get the current draft (creates empty one if doesn't exist)
   */
  async get(): Promise<NewsletterDraftRecord> {
    const draft = await db.newsletterDraft.upsert({
      where: { id: DRAFT_ID },
      create: { id: DRAFT_ID, items: [] },
      update: {},
    });

    return {
      ...draft,
      items: (draft.items as NewsletterDraftItem[]) || [],
    };
  },

  /**
   * Add an item to the draft
   */
  async addItem(type: NewsletterItemType, itemId: string): Promise<NewsletterDraftRecord> {
    const draft = await this.get();

    // Check if already exists
    const exists = draft.items.some(item => item.type === type && item.id === itemId);
    if (exists) {
      return draft;
    }

    const newItem: NewsletterDraftItem = {
      type,
      id: itemId,
      addedAt: new Date().toISOString(),
    };

    const updated = await db.newsletterDraft.update({
      where: { id: DRAFT_ID },
      data: {
        items: [...draft.items, newItem],
      },
    });

    return {
      ...updated,
      items: updated.items as NewsletterDraftItem[],
    };
  },

  /**
   * Remove an item from the draft
   */
  async removeItem(type: NewsletterItemType, itemId: string): Promise<NewsletterDraftRecord> {
    const draft = await this.get();

    const filteredItems = draft.items.filter(
      item => !(item.type === type && item.id === itemId)
    );

    const updated = await db.newsletterDraft.update({
      where: { id: DRAFT_ID },
      data: {
        items: filteredItems,
      },
    });

    return {
      ...updated,
      items: updated.items as NewsletterDraftItem[],
    };
  },

  /**
   * Reorder items in the draft
   */
  async reorderItems(items: NewsletterDraftItem[]): Promise<NewsletterDraftRecord> {
    const updated = await db.newsletterDraft.update({
      where: { id: DRAFT_ID },
      data: { items },
    });

    return {
      ...updated,
      items: updated.items as NewsletterDraftItem[],
    };
  },

  /**
   * Update intro text
   */
  async updateIntro(introText: string | null): Promise<NewsletterDraftRecord> {
    const updated = await db.newsletterDraft.update({
      where: { id: DRAFT_ID },
      data: { introText },
    });

    return {
      ...updated,
      items: updated.items as NewsletterDraftItem[],
    };
  },

  /**
   * Clear the draft (after sending)
   */
  async clear(): Promise<void> {
    await db.newsletterDraft.update({
      where: { id: DRAFT_ID },
      data: {
        introText: null,
        items: [],
      },
    });
  },

  /**
   * Get item count for badge display
   */
  async getItemCount(): Promise<number> {
    const draft = await this.get();
    return draft.items.length;
  },
};
```

**Add to exports in `packages/database/src/repositories/index.ts`:**

```typescript
export {
  newsletterDraftRepository,
  type NewsletterItemType,
  type NewsletterDraftItem,
  type NewsletterDraftRecord,
} from './newsletter-draft';
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add packages/database/src/repositories/newsletter-draft.ts packages/database/src/repositories/index.ts
git commit -m "feat(newsletter): add newsletter draft repository"
```

---

## Task 3: Newsletter Send Repository

**Files:**
- Create: `packages/database/src/repositories/newsletter-send.ts`
- Modify: `packages/database/src/repositories/index.ts`

**Implementation:**

Create `packages/database/src/repositories/newsletter-send.ts`:

```typescript
import { db } from '../client';

export interface NewsletterSendRecord {
  id: string;
  subject: string;
  contentHtml: string;
  contentText: string;
  sentAt: Date;
  recipientCount: number | null;
  postsIncluded: { id: string; title: string }[] | null;
  eventsIncluded: { id: string; title: string }[] | null;
  isManual: boolean;
}

export interface CreateNewsletterSendData {
  subject: string;
  contentHtml: string;
  contentText: string;
  recipientCount: number;
  postsIncluded?: { id: string; title: string }[];
  eventsIncluded?: { id: string; title: string }[];
  isManual?: boolean;
}

export const newsletterSendRepository = {
  /**
   * Create a record of a sent newsletter
   */
  async create(data: CreateNewsletterSendData): Promise<NewsletterSendRecord> {
    const record = await db.newsletterSend.create({
      data: {
        subject: data.subject,
        contentHtml: data.contentHtml,
        contentText: data.contentText,
        recipientCount: data.recipientCount,
        postsIncluded: data.postsIncluded || null,
        eventsIncluded: data.eventsIncluded || null,
        isManual: data.isManual ?? true,
      },
    });

    return {
      ...record,
      postsIncluded: record.postsIncluded as { id: string; title: string }[] | null,
      eventsIncluded: record.eventsIncluded as { id: string; title: string }[] | null,
    };
  },

  /**
   * Get recent sends for history display
   */
  async findRecent(limit: number = 10): Promise<NewsletterSendRecord[]> {
    const records = await db.newsletterSend.findMany({
      orderBy: { sentAt: 'desc' },
      take: limit,
    });

    return records.map(record => ({
      ...record,
      postsIncluded: record.postsIncluded as { id: string; title: string }[] | null,
      eventsIncluded: record.eventsIncluded as { id: string; title: string }[] | null,
    }));
  },
};
```

**Add to exports in `packages/database/src/repositories/index.ts`:**

```typescript
export {
  newsletterSendRepository,
  type NewsletterSendRecord,
  type CreateNewsletterSendData,
} from './newsletter-send';
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add packages/database/src/repositories/newsletter-send.ts packages/database/src/repositories/index.ts
git commit -m "feat(newsletter): add newsletter send repository"
```

---

## Task 4: Newsletter Digest Email Template

**Files:**
- Create: `apps/admin/lib/email/templates/newsletter-digest.ts`

**Implementation:**

```typescript
/**
 * Newsletter digest email template
 * Beautiful HTML email with multiple content items
 */

interface NewsletterItem {
  type: 'post' | 'announcement' | 'event';
  id: string;
  title: string;
  excerpt: string | null;
  url: string;
  date?: string;
  location?: string;
}

interface NewsletterDigestData {
  introText: string | null;
  items: NewsletterItem[];
  unsubscribeUrl: string;
  siteUrl: string;
}

interface EmailTemplate {
  subject: string;
  html: string;
  text: string;
}

const TYPE_LABELS: Record<string, string> = {
  post: 'Vijest',
  announcement: 'Obavijest',
  event: 'Dogaƒëanje',
};

const TYPE_COLORS: Record<string, string> = {
  post: '#3b82f6',
  announcement: '#f59e0b',
  event: '#8b5cf6',
};

function escapeHtml(text: string): string {
  const htmlEscapes: Record<string, string> = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
  };
  return text.replace(/[&<>"']/g, (char) => htmlEscapes[char] || char);
}

export function newsletterDigestTemplate(data: NewsletterDigestData): EmailTemplate {
  const { introText, items, unsubscribeUrl, siteUrl } = data;

  const subject = `Newsletter - Opƒáina Veliki Bukovec`;

  const itemsHtml = items.map(item => `
    <tr>
      <td style="padding: 24px 0; border-bottom: 1px solid #e5e7eb;">
        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
          <tr>
            <td>
              <span style="display: inline-block; padding: 4px 12px; background-color: ${TYPE_COLORS[item.type]}; color: #ffffff; font-size: 12px; font-weight: 600; border-radius: 4px; margin-bottom: 8px;">
                ${TYPE_LABELS[item.type]}
              </span>
              <h2 style="margin: 8px 0 12px 0; font-size: 20px; font-weight: 600; color: #111827;">
                <a href="${escapeHtml(item.url)}" style="color: #111827; text-decoration: none;">
                  ${escapeHtml(item.title)}
                </a>
              </h2>
              ${item.type === 'event' && item.date ? `
                <p style="margin: 0 0 8px 0; font-size: 14px; color: #6b7280;">
                  üìÖ ${escapeHtml(item.date)}${item.location ? ` ¬∑ üìç ${escapeHtml(item.location)}` : ''}
                </p>
              ` : ''}
              ${item.excerpt ? `
                <p style="margin: 0 0 16px 0; font-size: 15px; color: #4b5563; line-height: 1.6;">
                  ${escapeHtml(item.excerpt)}
                </p>
              ` : ''}
              <a href="${escapeHtml(item.url)}" style="display: inline-block; color: #16a34a; font-size: 14px; font-weight: 600; text-decoration: none;">
                Proƒçitaj vi≈°e ‚Üí
              </a>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  `).join('');

  const html = `
<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${subject}</title>
  <!--[if mso]>
  <noscript>
    <xml>
      <o:OfficeDocumentSettings>
        <o:PixelsPerInch>96</o:PixelsPerInch>
      </o:OfficeDocumentSettings>
    </xml>
  </noscript>
  <![endif]-->
</head>
<body style="margin: 0; padding: 0; background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
  <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f3f4f6;">
    <tr>
      <td style="padding: 40px 20px;">
        <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="600" style="margin: 0 auto; max-width: 600px;">

          <!-- Header -->
          <tr>
            <td style="background-color: #16a34a; padding: 40px 32px; border-radius: 12px 12px 0 0; text-align: center;">
              <h1 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: #ffffff;">
                Opƒáina Veliki Bukovec
              </h1>
              <p style="margin: 0; font-size: 16px; color: rgba(255,255,255,0.9);">
                Newsletter
              </p>
            </td>
          </tr>

          <!-- Content -->
          <tr>
            <td style="background-color: #ffffff; padding: 32px;">

              ${introText ? `
              <!-- Intro -->
              <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                <tr>
                  <td style="padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
                    <p style="margin: 0; font-size: 16px; color: #374151; line-height: 1.7;">
                      ${escapeHtml(introText)}
                    </p>
                  </td>
                </tr>
              </table>
              ` : ''}

              <!-- Items -->
              <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                ${itemsHtml}
              </table>

              <!-- CTA -->
              <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%">
                <tr>
                  <td style="padding-top: 32px; text-align: center;">
                    <a href="${escapeHtml(siteUrl)}" style="display: inline-block; background-color: #16a34a; color: #ffffff; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600; font-size: 16px;">
                      Posjetite na≈°u stranicu
                    </a>
                  </td>
                </tr>
              </table>

            </td>
          </tr>

          <!-- Footer -->
          <tr>
            <td style="background-color: #f9fafb; padding: 24px 32px; border-radius: 0 0 12px 12px; border-top: 1px solid #e5e7eb; text-align: center;">
              <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">
                Srdaƒçan pozdrav,<br>
                <strong>Opƒáina Veliki Bukovec</strong>
              </p>
              <p style="margin: 0; font-size: 12px; color: #9ca3af;">
                <a href="${escapeHtml(unsubscribeUrl)}" style="color: #9ca3af; text-decoration: underline;">
                  Odjavi se s newslettera
                </a>
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
  `.trim();

  const itemsText = items.map(item => `
[${TYPE_LABELS[item.type]}] ${item.title}
${item.type === 'event' && item.date ? `üìÖ ${item.date}${item.location ? ` ¬∑ üìç ${item.location}` : ''}\n` : ''}${item.excerpt ? `${item.excerpt}\n` : ''}Proƒçitaj vi≈°e: ${item.url}
`).join('\n---\n');

  const text = `
OPƒÜINA VELIKI BUKOVEC - NEWSLETTER

${introText ? `${introText}\n\n---\n` : ''}
${itemsText}

---

Posjetite na≈°u stranicu: ${siteUrl}

---
Za odjavu s newslettera posjetite: ${unsubscribeUrl}
  `.trim();

  return { subject, html, text };
}
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/lib/email/templates/newsletter-digest.ts
git commit -m "feat(newsletter): add beautiful HTML newsletter digest template"
```

---

## Task 5: Newsletter Email Service - Send Batch

**Files:**
- Modify: `apps/admin/lib/email/service.ts`
- Modify: `apps/admin/lib/email/index.ts`

**Implementation:**

Add to `apps/admin/lib/email/service.ts` after the existing newsletter section:

First add the import at the top:
```typescript
import { newsletterDigestTemplate } from './templates/newsletter-digest';
```

Then add after `sendNewsletterConfirmation`:

```typescript
// =============================================================================
// Newsletter Digest Sending
// =============================================================================

export interface NewsletterDigestItem {
  type: 'post' | 'announcement' | 'event';
  id: string;
  title: string;
  excerpt: string | null;
  url: string;
  date?: string;
  location?: string;
}

export interface SendNewsletterDigestOptions {
  introText: string | null;
  items: NewsletterDigestItem[];
  subscribers: { id: string; email: string }[];
  siteUrl: string;
  onProgress?: (sent: number, total: number) => void;
}

export interface SendNewsletterDigestResult {
  success: boolean;
  sent: number;
  failed: number;
  subject: string;
  contentHtml: string;
  contentText: string;
}

/**
 * Send newsletter digest to all subscribers
 * Sends in batches with delay to avoid spam flags
 */
export async function sendNewsletterDigest(
  options: SendNewsletterDigestOptions
): Promise<SendNewsletterDigestResult> {
  const { introText, items, subscribers, siteUrl, onProgress } = options;

  if (!isEmailConfigured()) {
    contactLogger.warn('Email not configured, cannot send newsletter');
    throw new Error('Email is not configured');
  }

  const transporter = getEmailTransporter();
  const from = getSmtpFrom();

  if (!transporter || !from) {
    throw new Error('Email transporter not available');
  }

  let sent = 0;
  let failed = 0;
  let templateResult: { subject: string; html: string; text: string } | null = null;

  for (const subscriber of subscribers) {
    const unsubscribeUrl = `${siteUrl}/newsletter/odjava?id=${subscriber.id}`;

    const template = newsletterDigestTemplate({
      introText,
      items,
      unsubscribeUrl,
      siteUrl,
    });

    // Store template for return (same for all subscribers except unsubscribe URL)
    if (!templateResult) {
      templateResult = template;
    }

    try {
      await transporter.sendMail({
        from,
        to: subscriber.email,
        subject: template.subject,
        text: template.text,
        html: template.html,
      });

      sent++;
      contactLogger.info({ to: subscriber.email }, 'Newsletter digest sent');
    } catch (error) {
      failed++;
      contactLogger.error({ error, to: subscriber.email }, 'Failed to send newsletter digest');
    }

    onProgress?.(sent + failed, subscribers.length);

    // Small delay between emails to avoid spam flags (100ms)
    if (sent + failed < subscribers.length) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }

  return {
    success: failed === 0,
    sent,
    failed,
    subject: templateResult?.subject || 'Newsletter - Opƒáina Veliki Bukovec',
    contentHtml: templateResult?.html || '',
    contentText: templateResult?.text || '',
  };
}
```

**Add exports to `apps/admin/lib/email/index.ts`:**

```typescript
export {
  sendNewsletterDigest,
  type NewsletterDigestItem,
  type SendNewsletterDigestOptions,
  type SendNewsletterDigestResult,
} from './service';

export { newsletterDigestTemplate } from './templates/newsletter-digest';
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/lib/email/service.ts apps/admin/lib/email/index.ts
git commit -m "feat(newsletter): add batch newsletter sending with progress tracking"
```

---

## Task 6: Newsletter Draft API Routes

**Files:**
- Create: `apps/admin/app/api/newsletter/draft/route.ts`
- Create: `apps/admin/app/api/newsletter/draft/items/route.ts`

**Implementation:**

Create `apps/admin/app/api/newsletter/draft/route.ts`:

```typescript
import { newsletterDraftRepository } from '@repo/database';
import { NextResponse } from 'next/server';

import { requireAuth } from '@/lib/auth';

// GET /api/newsletter/draft - Get current draft
export async function GET() {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    const draft = await newsletterDraftRepository.get();
    return NextResponse.json({ success: true, data: draft });
  } catch (error) {
    console.error('Failed to get newsletter draft:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Failed to get draft' } },
      { status: 500 }
    );
  }
}

// PUT /api/newsletter/draft - Update intro text
export async function PUT(request: Request) {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    const body = await request.json() as { introText?: string | null };
    const draft = await newsletterDraftRepository.updateIntro(body.introText ?? null);
    return NextResponse.json({ success: true, data: draft });
  } catch (error) {
    console.error('Failed to update newsletter draft:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Failed to update draft' } },
      { status: 500 }
    );
  }
}

// DELETE /api/newsletter/draft - Clear draft
export async function DELETE() {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    await newsletterDraftRepository.clear();
    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Failed to clear newsletter draft:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Failed to clear draft' } },
      { status: 500 }
    );
  }
}
```

Create `apps/admin/app/api/newsletter/draft/items/route.ts`:

```typescript
import { newsletterDraftRepository } from '@repo/database';
import { NextResponse } from 'next/server';
import { z } from 'zod';

import { requireAuth } from '@/lib/auth';

import type { NewsletterItemType } from '@repo/database';

const addItemSchema = z.object({
  type: z.enum(['post', 'announcement', 'event']),
  id: z.string().min(1),
});

const removeItemSchema = z.object({
  type: z.enum(['post', 'announcement', 'event']),
  id: z.string().min(1),
});

const reorderSchema = z.object({
  items: z.array(z.object({
    type: z.enum(['post', 'announcement', 'event']),
    id: z.string(),
    addedAt: z.string(),
  })),
});

// POST /api/newsletter/draft/items - Add item to draft
export async function POST(request: Request) {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    const body = await request.json();
    const result = addItemSchema.safeParse(body);

    if (!result.success) {
      return NextResponse.json(
        { success: false, error: { code: 'VALIDATION_ERROR', message: 'Invalid input' } },
        { status: 400 }
      );
    }

    const draft = await newsletterDraftRepository.addItem(
      result.data.type as NewsletterItemType,
      result.data.id
    );

    return NextResponse.json({ success: true, data: draft });
  } catch (error) {
    console.error('Failed to add item to newsletter draft:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Failed to add item' } },
      { status: 500 }
    );
  }
}

// DELETE /api/newsletter/draft/items - Remove item from draft
export async function DELETE(request: Request) {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    const body = await request.json();
    const result = removeItemSchema.safeParse(body);

    if (!result.success) {
      return NextResponse.json(
        { success: false, error: { code: 'VALIDATION_ERROR', message: 'Invalid input' } },
        { status: 400 }
      );
    }

    const draft = await newsletterDraftRepository.removeItem(
      result.data.type as NewsletterItemType,
      result.data.id
    );

    return NextResponse.json({ success: true, data: draft });
  } catch (error) {
    console.error('Failed to remove item from newsletter draft:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Failed to remove item' } },
      { status: 500 }
    );
  }
}

// PUT /api/newsletter/draft/items - Reorder items
export async function PUT(request: Request) {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    const body = await request.json();
    const result = reorderSchema.safeParse(body);

    if (!result.success) {
      return NextResponse.json(
        { success: false, error: { code: 'VALIDATION_ERROR', message: 'Invalid input' } },
        { status: 400 }
      );
    }

    const draft = await newsletterDraftRepository.reorderItems(result.data.items);

    return NextResponse.json({ success: true, data: draft });
  } catch (error) {
    console.error('Failed to reorder newsletter draft items:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Failed to reorder items' } },
      { status: 500 }
    );
  }
}
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/app/api/newsletter/draft/
git commit -m "feat(newsletter): add draft API routes for CRUD operations"
```

---

## Task 7: Newsletter Send API Route

**Files:**
- Create: `apps/admin/app/api/newsletter/send/route.ts`

**Implementation:**

```typescript
import {
  newsletterDraftRepository,
  newsletterRepository,
  newsletterSendRepository,
  postsRepository,
  announcementsRepository,
  eventsRepository,
} from '@repo/database';
import { NextResponse } from 'next/server';

import { requireAuth } from '@/lib/auth';
import { sendNewsletterDigest } from '@/lib/email';

import type { NewsletterDigestItem } from '@/lib/email';

const PUBLIC_SITE_URL = process.env.PUBLIC_SITE_URL || 'https://velikibukovec.hr';

// POST /api/newsletter/send - Send the newsletter
export async function POST() {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    // Get draft
    const draft = await newsletterDraftRepository.get();

    if (draft.items.length === 0) {
      return NextResponse.json(
        { success: false, error: { code: 'EMPTY_DRAFT', message: 'Newsletter je prazan. Dodajte sadr≈æaj prije slanja.' } },
        { status: 400 }
      );
    }

    // Get all confirmed subscribers
    const subscribersResult = await newsletterRepository.findAllConfirmed({ limit: 10000 });
    const subscribers = subscribersResult.subscribers;

    if (subscribers.length === 0) {
      return NextResponse.json(
        { success: false, error: { code: 'NO_SUBSCRIBERS', message: 'Nema pretplatnika za slanje.' } },
        { status: 400 }
      );
    }

    // Fetch full item details
    const items: NewsletterDigestItem[] = [];
    const postsIncluded: { id: string; title: string }[] = [];
    const eventsIncluded: { id: string; title: string }[] = [];

    for (const draftItem of draft.items) {
      if (draftItem.type === 'post') {
        const post = await postsRepository.findById(draftItem.id);
        if (post) {
          items.push({
            type: 'post',
            id: post.id,
            title: post.title,
            excerpt: post.excerpt,
            url: `${PUBLIC_SITE_URL}/vijesti/${post.slug}`,
          });
          postsIncluded.push({ id: post.id, title: post.title });
        }
      } else if (draftItem.type === 'announcement') {
        const announcement = await announcementsRepository.findById(draftItem.id);
        if (announcement) {
          items.push({
            type: 'announcement',
            id: announcement.id,
            title: announcement.title,
            excerpt: announcement.excerpt,
            url: `${PUBLIC_SITE_URL}/obavijesti/${announcement.slug}`,
          });
          postsIncluded.push({ id: announcement.id, title: announcement.title });
        }
      } else if (draftItem.type === 'event') {
        const event = await eventsRepository.findById(draftItem.id);
        if (event) {
          const eventDate = new Date(event.eventDate).toLocaleDateString('hr-HR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
          });
          items.push({
            type: 'event',
            id: event.id,
            title: event.title,
            excerpt: event.description,
            url: `${PUBLIC_SITE_URL}/dogadanja/${event.id}`,
            date: eventDate,
            location: event.location || undefined,
          });
          eventsIncluded.push({ id: event.id, title: event.title });
        }
      }
    }

    if (items.length === 0) {
      return NextResponse.json(
        { success: false, error: { code: 'NO_VALID_ITEMS', message: 'Sadr≈æaj nije pronaƒëen. Mo≈æda je obrisan.' } },
        { status: 400 }
      );
    }

    // Send newsletter
    const result = await sendNewsletterDigest({
      introText: draft.introText,
      items,
      subscribers: subscribers.map(s => ({ id: s.id, email: s.email })),
      siteUrl: PUBLIC_SITE_URL,
    });

    // Record the send
    await newsletterSendRepository.create({
      subject: result.subject,
      contentHtml: result.contentHtml,
      contentText: result.contentText,
      recipientCount: result.sent,
      postsIncluded: postsIncluded.length > 0 ? postsIncluded : undefined,
      eventsIncluded: eventsIncluded.length > 0 ? eventsIncluded : undefined,
      isManual: true,
    });

    // Clear the draft
    await newsletterDraftRepository.clear();

    return NextResponse.json({
      success: true,
      data: {
        sent: result.sent,
        failed: result.failed,
        message: `Newsletter uspje≈°no poslan ${result.sent} pretplatnika.`,
      },
    });
  } catch (error) {
    console.error('Failed to send newsletter:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Gre≈°ka pri slanju newslettera.' } },
      { status: 500 }
    );
  }
}
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/app/api/newsletter/send/route.ts
git commit -m "feat(newsletter): add send API route with batch processing"
```

---

## Task 8: Newsletter Item Count API (for badge)

**Files:**
- Create: `apps/admin/app/api/newsletter/count/route.ts`

**Implementation:**

```typescript
import { newsletterDraftRepository } from '@repo/database';
import { NextResponse } from 'next/server';

import { requireAuth } from '@/lib/auth';

// GET /api/newsletter/count - Get draft item count for sidebar badge
export async function GET() {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    const count = await newsletterDraftRepository.getItemCount();
    return NextResponse.json({ success: true, data: { count } });
  } catch (error) {
    console.error('Failed to get newsletter draft count:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Failed to get count' } },
      { status: 500 }
    );
  }
}
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/app/api/newsletter/count/route.ts
git commit -m "feat(newsletter): add draft item count API for sidebar badge"
```

---

## Task 9: Add Newsletter to Sidebar Navigation

**Files:**
- Modify: `apps/admin/config/navigation.ts`

**Implementation:**

Add `Mail` icon import at the top:
```typescript
import {
  Bell,
  CalendarDays,
  FileText,
  Image,
  Inbox,
  LayoutDashboard,
  Mail,
  MessageSquare,
  Settings,
  Users,
} from 'lucide-react';
```

Add newsletter item to the "Komunikacija" section (after Prijave problema):
```typescript
{
  title: 'Komunikacija',
  items: [
    {
      title: 'Poruke',
      href: '/messages',
      icon: icon(Inbox),
    },
    {
      title: 'Prijave problema',
      href: '/reports',
      icon: icon(MessageSquare),
    },
    {
      title: 'Newsletter',
      href: '/newsletter',
      icon: icon(Mail),
    },
  ],
},
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/config/navigation.ts
git commit -m "feat(newsletter): add newsletter to admin sidebar navigation"
```

---

## Task 10: Newsletter Compose Page

**Files:**
- Create: `apps/admin/app/(dashboard)/newsletter/page.tsx`
- Create: `apps/admin/app/(dashboard)/newsletter/newsletter-compose.tsx`

**Implementation:**

Create `apps/admin/app/(dashboard)/newsletter/page.tsx`:

```typescript
import { Suspense } from 'react';

import { NewsletterCompose } from './newsletter-compose';

export const metadata = {
  title: 'Newsletter | Admin',
};

export default function NewsletterPage() {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="font-display text-2xl font-bold text-neutral-900">Newsletter</h1>
        <p className="mt-1 text-neutral-600">
          Sastavi i po≈°alji newsletter pretplatnicima
        </p>
      </div>

      <Suspense fallback={<div className="animate-pulse h-96 bg-neutral-100 rounded-lg" />}>
        <NewsletterCompose />
      </Suspense>
    </div>
  );
}
```

Create `apps/admin/app/(dashboard)/newsletter/newsletter-compose.tsx`:

```typescript
'use client';

import {
  Badge,
  Button,
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
  Textarea,
  toast,
} from '@repo/ui';
import {
  AlertCircle,
  Calendar,
  FileText,
  GripVertical,
  Loader2,
  Megaphone,
  Send,
  Sparkles,
  Trash2,
} from 'lucide-react';
import { useCallback, useEffect, useState } from 'react';

import type { NewsletterDraftItem, NewsletterDraftRecord } from '@repo/database';

interface DraftItemWithDetails extends NewsletterDraftItem {
  title?: string;
  excerpt?: string;
}

interface SubscriberCount {
  count: number;
}

const TYPE_ICONS = {
  post: FileText,
  announcement: Megaphone,
  event: Calendar,
};

const TYPE_LABELS = {
  post: 'Vijest',
  announcement: 'Obavijest',
  event: 'Dogaƒëanje',
};

const TYPE_COLORS = {
  post: 'bg-blue-100 text-blue-800',
  announcement: 'bg-amber-100 text-amber-800',
  event: 'bg-purple-100 text-purple-800',
};

export function NewsletterCompose() {
  const [draft, setDraft] = useState<NewsletterDraftRecord | null>(null);
  const [items, setItems] = useState<DraftItemWithDetails[]>([]);
  const [introText, setIntroText] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [isSending, setIsSending] = useState(false);
  const [subscriberCount, setSubscriberCount] = useState(0);

  // Fetch draft and subscriber count
  const fetchData = useCallback(async () => {
    try {
      const [draftRes, countRes] = await Promise.all([
        fetch('/api/newsletter/draft'),
        fetch('/api/newsletter/subscribers/count'),
      ]);

      if (draftRes.ok) {
        const draftData = await draftRes.json();
        setDraft(draftData.data);
        setIntroText(draftData.data.introText || '');

        // Fetch item details
        const itemsWithDetails = await Promise.all(
          (draftData.data.items as NewsletterDraftItem[]).map(async (item) => {
            const endpoint = item.type === 'post'
              ? `/api/posts/${item.id}`
              : item.type === 'announcement'
              ? `/api/announcements/${item.id}`
              : `/api/events/${item.id}`;

            try {
              const res = await fetch(endpoint);
              if (res.ok) {
                const data = await res.json();
                return {
                  ...item,
                  title: data.data.title,
                  excerpt: data.data.excerpt || data.data.description,
                };
              }
            } catch {
              // Item might have been deleted
            }
            return { ...item, title: 'Nije pronaƒëeno', excerpt: null };
          })
        );
        setItems(itemsWithDetails);
      }

      if (countRes.ok) {
        const countData = await countRes.json();
        setSubscriberCount(countData.data.count);
      }
    } catch (error) {
      console.error('Failed to fetch data:', error);
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    void fetchData();
  }, [fetchData]);

  // Update intro text
  const handleIntroChange = useCallback(async (value: string) => {
    setIntroText(value);

    try {
      await fetch('/api/newsletter/draft', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ introText: value || null }),
      });
    } catch (error) {
      console.error('Failed to update intro:', error);
    }
  }, []);

  // Remove item
  const handleRemoveItem = useCallback(async (type: string, id: string) => {
    try {
      const res = await fetch('/api/newsletter/draft/items', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type, id }),
      });

      if (res.ok) {
        setItems(prev => prev.filter(item => !(item.type === type && item.id === id)));
        toast({ title: 'Uklonjeno', description: 'Stavka je uklonjena iz newslettera.' });
      }
    } catch (error) {
      console.error('Failed to remove item:', error);
      toast({ title: 'Gre≈°ka', description: 'Nije moguƒáe ukloniti stavku.', variant: 'destructive' });
    }
  }, []);

  // Send newsletter
  const handleSend = useCallback(async () => {
    if (items.length === 0) {
      toast({ title: 'Gre≈°ka', description: 'Dodajte sadr≈æaj prije slanja.', variant: 'destructive' });
      return;
    }

    if (subscriberCount === 0) {
      toast({ title: 'Gre≈°ka', description: 'Nema pretplatnika za slanje.', variant: 'destructive' });
      return;
    }

    setIsSending(true);

    try {
      const res = await fetch('/api/newsletter/send', {
        method: 'POST',
      });

      const data = await res.json();

      if (res.ok && data.success) {
        toast({ title: 'Uspjeh!', description: data.data.message });
        setItems([]);
        setIntroText('');
        void fetchData();
      } else {
        toast({
          title: 'Gre≈°ka',
          description: data.error?.message || 'Slanje nije uspjelo.',
          variant: 'destructive'
        });
      }
    } catch (error) {
      console.error('Failed to send:', error);
      toast({ title: 'Gre≈°ka', description: 'Slanje nije uspjelo.', variant: 'destructive' });
    } finally {
      setIsSending(false);
    }
  }, [items.length, subscriberCount, fetchData]);

  // Clear draft
  const handleClear = useCallback(async () => {
    try {
      await fetch('/api/newsletter/draft', { method: 'DELETE' });
      setItems([]);
      setIntroText('');
      toast({ title: 'Oƒçi≈°ƒáeno', description: 'Newsletter je oƒçi≈°ƒáen.' });
    } catch (error) {
      console.error('Failed to clear:', error);
    }
  }, []);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="h-8 w-8 animate-spin text-primary-600" />
      </div>
    );
  }

  return (
    <div className="grid gap-6 lg:grid-cols-3">
      {/* Main content */}
      <div className="lg:col-span-2 space-y-6">
        {/* Intro text */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              Uvodni tekst
              <Button
                variant="ghost"
                size="sm"
                disabled
                title="AI generiranje - dolazi uskoro"
                className="ml-auto"
              >
                <Sparkles className="h-4 w-4 mr-1" />
                Generiraj
              </Button>
            </CardTitle>
            <CardDescription>
              Opcionalni uvodni paragraf na poƒçetku newslettera
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Textarea
              value={introText}
              onChange={(e) => void handleIntroChange(e.target.value)}
              placeholder="Po≈°tovani sugraƒëani, donosimo vam najnovije vijesti iz na≈°e opƒáine..."
              rows={4}
            />
          </CardContent>
        </Card>

        {/* Items */}
        <Card>
          <CardHeader>
            <CardTitle>Sadr≈æaj newslettera</CardTitle>
            <CardDescription>
              {items.length === 0
                ? 'Dodajte sadr≈æaj klikom na "Dodaj u newsletter" na objavama, obavijestima ili dogaƒëanjima'
                : `${items.length} stavki u newsletteru`
              }
            </CardDescription>
          </CardHeader>
          <CardContent>
            {items.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-center">
                <AlertCircle className="h-12 w-12 text-neutral-300 mb-4" />
                <p className="text-neutral-500">Newsletter je prazan</p>
                <p className="text-sm text-neutral-400 mt-1">
                  Idite na Objave, Obavijesti ili Dogaƒëanja i kliknite "Dodaj u newsletter"
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {items.map((item, index) => {
                  const Icon = TYPE_ICONS[item.type];
                  return (
                    <div
                      key={`${item.type}-${item.id}`}
                      className="flex items-start gap-3 rounded-lg border border-neutral-200 p-4"
                    >
                      <GripVertical className="h-5 w-5 text-neutral-400 mt-0.5 cursor-grab" />
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <Badge className={TYPE_COLORS[item.type]}>
                            <Icon className="h-3 w-3 mr-1" />
                            {TYPE_LABELS[item.type]}
                          </Badge>
                        </div>
                        <h4 className="font-medium text-neutral-900 truncate">
                          {item.title || 'Uƒçitavanje...'}
                        </h4>
                        {item.excerpt && (
                          <p className="text-sm text-neutral-500 line-clamp-2 mt-1">
                            {item.excerpt}
                          </p>
                        )}
                      </div>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => void handleRemoveItem(item.type, item.id)}
                        className="text-neutral-400 hover:text-red-600"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  );
                })}
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Sidebar */}
      <div className="space-y-6">
        {/* Send card */}
        <Card>
          <CardHeader>
            <CardTitle>Po≈°alji newsletter</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex items-center justify-between text-sm">
              <span className="text-neutral-600">Pretplatnici:</span>
              <span className="font-medium">{subscriberCount}</span>
            </div>
            <div className="flex items-center justify-between text-sm">
              <span className="text-neutral-600">Stavki:</span>
              <span className="font-medium">{items.length}</span>
            </div>

            <Button
              className="w-full"
              disabled={items.length === 0 || subscriberCount === 0 || isSending}
              onClick={() => void handleSend()}
            >
              {isSending ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  ≈†aljem...
                </>
              ) : (
                <>
                  <Send className="h-4 w-4 mr-2" />
                  Po≈°alji {subscriberCount} pretplatnika
                </>
              )}
            </Button>

            {items.length > 0 && (
              <Button variant="outline" className="w-full" onClick={() => void handleClear()}>
                Oƒçisti newsletter
              </Button>
            )}
          </CardContent>
        </Card>

        {/* AI placeholder */}
        <Card className="border-dashed">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-neutral-400">
              <Sparkles className="h-5 w-5" />
              AI Asistent
            </CardTitle>
            <CardDescription>
              Dolazi uskoro - automatsko generiranje uvoda i sa≈æetaka
            </CardDescription>
          </CardHeader>
        </Card>
      </div>
    </div>
  );
}
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/app/\(dashboard\)/newsletter/
git commit -m "feat(newsletter): add newsletter compose page with preview"
```

---

## Task 11: Subscriber Count API

**Files:**
- Create: `apps/admin/app/api/newsletter/subscribers/count/route.ts`

**Implementation:**

```typescript
import { newsletterRepository } from '@repo/database';
import { NextResponse } from 'next/server';

import { requireAuth } from '@/lib/auth';

// GET /api/newsletter/subscribers/count - Get confirmed subscriber count
export async function GET() {
  const session = await requireAuth();
  if (!session) {
    return NextResponse.json(
      { success: false, error: { code: 'UNAUTHORIZED', message: 'Unauthorized' } },
      { status: 401 }
    );
  }

  try {
    const count = await newsletterRepository.count({ confirmed: true });
    return NextResponse.json({ success: true, data: { count } });
  } catch (error) {
    console.error('Failed to get subscriber count:', error);
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Failed to get count' } },
      { status: 500 }
    );
  }
}
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/app/api/newsletter/subscribers/
git commit -m "feat(newsletter): add subscriber count API"
```

---

## Task 12: Add "Add to Newsletter" Button to Posts

**Files:**
- Modify: `apps/admin/components/posts/columns.tsx`

**Implementation:**

Add `Mail` icon to imports:
```typescript
import { Mail, MoreHorizontal, Pencil, Trash2 } from 'lucide-react';
```

Update `GetColumnsOptions` interface:
```typescript
interface GetColumnsOptions {
  onDelete: (post: Post) => void;
  onAddToNewsletter: (post: Post) => void;
}
```

Update function signature:
```typescript
export function getColumns({ onDelete, onAddToNewsletter }: GetColumnsOptions): ColumnDef<Post>[] {
```

Add menu item after Edit in the DropdownMenuContent (before the separator):
```typescript
<DropdownMenuItem onClick={() => onAddToNewsletter(post)}>
  <Mail className="mr-2 h-4 w-4" aria-hidden="true" />
  Dodaj u newsletter
</DropdownMenuItem>
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/components/posts/columns.tsx
git commit -m "feat(newsletter): add 'Add to newsletter' button to posts list"
```

---

## Task 13: Wire Posts List to Newsletter API

**Files:**
- Modify: `apps/admin/app/(dashboard)/posts/posts-list.tsx`

**Implementation:**

Add newsletter handler after delete handler:

```typescript
// Add to newsletter
const handleAddToNewsletter = useCallback(async (post: Post) => {
  try {
    const response = await fetch('/api/newsletter/draft/items', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'post', id: post.id }),
    });

    if (!response.ok) {
      throw new Error('Failed to add to newsletter');
    }

    toast({
      title: 'Dodano u newsletter',
      description: `"${post.title}" je dodano u newsletter.`,
    });
  } catch {
    toast({
      title: 'Gre≈°ka',
      description: 'Nije moguƒáe dodati u newsletter.',
      variant: 'destructive',
    });
  }
}, []);
```

Update columns useMemo to pass the handler:
```typescript
const columns = useMemo(
  () => getColumns({ onDelete: handleDelete, onAddToNewsletter: handleAddToNewsletter }),
  [handleDelete, handleAddToNewsletter]
);
```

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/app/\(dashboard\)/posts/posts-list.tsx
git commit -m "feat(newsletter): wire posts list to newsletter draft API"
```

---

## Task 14: Add "Add to Newsletter" to Announcements

**Files:**
- Modify: `apps/admin/components/announcements/columns.tsx`
- Modify: `apps/admin/app/(dashboard)/announcements/announcements-list.tsx`

**Implementation:**

Same pattern as posts - add `Mail` icon, update interface, add handler.

In `columns.tsx`:
- Import `Mail` icon
- Add `onAddToNewsletter` to `GetColumnsOptions`
- Add menu item

In `announcements-list.tsx`:
- Add `handleAddToNewsletter` callback with `type: 'announcement'`
- Pass to `getColumns`

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/components/announcements/columns.tsx apps/admin/app/\(dashboard\)/announcements/announcements-list.tsx
git commit -m "feat(newsletter): add 'Add to newsletter' button to announcements"
```

---

## Task 15: Add "Add to Newsletter" to Events

**Files:**
- Modify: `apps/admin/components/events/columns.tsx`
- Modify: `apps/admin/app/(dashboard)/events/events-list.tsx`

**Implementation:**

Same pattern as posts and announcements.

In `columns.tsx`:
- Import `Mail` icon
- Add `onAddToNewsletter` to `GetColumnsOptions`
- Add menu item

In `events-list.tsx`:
- Add `handleAddToNewsletter` callback with `type: 'event'`
- Pass to `getColumns`

**Verify:** `pnpm type-check`

**Commit:**
```bash
git add apps/admin/components/events/columns.tsx apps/admin/app/\(dashboard\)/events/events-list.tsx
git commit -m "feat(newsletter): add 'Add to newsletter' button to events"
```

---

## Task 16: Final Verification

**Run all checks:**

```bash
pnpm type-check
pnpm lint
pnpm build
```

**Manual test flow:**
1. Go to Posts list, click "Add to newsletter" on a post
2. Go to Announcements list, add one
3. Go to Events list, add one
4. Go to Newsletter page - verify all 3 items appear
5. Add intro text
6. Click "Po≈°alji" - verify confirmation
7. Check email inbox (if configured)
8. Verify newsletter history in database

---

## Summary

| Task | Description |
|------|-------------|
| 1 | Database schema - NewsletterDraft model |
| 2 | Newsletter draft repository |
| 3 | Newsletter send repository |
| 4 | Newsletter digest email template |
| 5 | Newsletter email service - send batch |
| 6 | Newsletter draft API routes |
| 7 | Newsletter send API route |
| 8 | Newsletter item count API |
| 9 | Add newsletter to sidebar navigation |
| 10 | Newsletter compose page |
| 11 | Subscriber count API |
| 12 | Add "Add to Newsletter" to posts |
| 13 | Wire posts list to newsletter API |
| 14 | Add "Add to Newsletter" to announcements |
| 15 | Add "Add to Newsletter" to events |
| 16 | Final verification |
