# Sprint 0.5: CI/CD Pipeline Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Set up GitHub Actions CI pipeline and Cloudflare Pages deployment for automated quality checks and preview deployments.

**Architecture:** GitHub Actions workflow triggers on PR (lint, type-check, test) and on merge to main (build). Cloudflare Pages connects to GitHub for automatic preview deploys on PR and production deploys on main merge.

**Tech Stack:** GitHub Actions, Cloudflare Pages, pnpm, Turborepo, Node.js 20

---

## Task 1: Create GitHub Actions CI Workflow

**Files:**
- Create: `.github/workflows/ci.yml`

**Step 1: Create the workflows directory**

Run: `mkdir -p .github/workflows`
Expected: Directory created

**Step 2: Create the CI workflow file**

```yaml
name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  ci:
    name: Lint, Type Check, Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type Check
        run: pnpm type-check

      - name: Test
        run: pnpm test

  build:
    name: Build Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: ci

    env:
      # Minimal env vars for build (no runtime secrets needed)
      DATABASE_URL: "postgresql://localhost:5432/placeholder"
      BETTER_AUTH_SECRET: "build-time-placeholder-secret-32chars"
      BETTER_AUTH_URL: "http://localhost:3001"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build
```

**Step 3: Verify workflow syntax**

Run: `cd /mnt/c/VelikiBukovec_web && cat .github/workflows/ci.yml`
Expected: File contents displayed

**Step 4: Commit**

```bash
git add .github/workflows/ci.yml
git commit -m "ci: add GitHub Actions workflow for lint, type-check, test, build

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

---

## Task 2: Document Environment Variables for CI

**Files:**
- Modify: `docs/CI-CD.md` (create if not exists)

**Step 1: Create CI/CD documentation**

```markdown
# CI/CD Pipeline Documentation

## GitHub Actions

### Workflow: `.github/workflows/ci.yml`

**Triggers:**
- **Pull Request to main:** Runs lint, type-check, test
- **Push to main:** Runs lint, type-check, test, then build

### Required Secrets (Optional)

| Secret | Purpose | Required |
|--------|---------|----------|
| `TURBO_TOKEN` | Turborepo remote cache authentication | No (speeds up CI) |

### Required Variables (Optional)

| Variable | Purpose | Required |
|----------|---------|----------|
| `TURBO_TEAM` | Turborepo team name for remote cache | No (speeds up CI) |

### Build Environment Variables

These are set directly in the workflow for build-time only (not runtime secrets):

| Variable | Value | Purpose |
|----------|-------|---------|
| `DATABASE_URL` | Placeholder | Prisma schema validation |
| `BETTER_AUTH_SECRET` | Placeholder | Better Auth config validation |
| `BETTER_AUTH_URL` | `http://localhost:3001` | Better Auth config validation |

**Note:** Runtime secrets (real database URL, auth secrets) are configured in deployment environments (Cloudflare Pages, VPS), not in CI.

## Cloudflare Pages

### Setup Instructions

1. Go to Cloudflare Dashboard > Pages
2. Click "Create a project" > "Connect to Git"
3. Select the `WebVB` repository
4. Configure build settings:
   - **Framework preset:** Next.js
   - **Build command:** `pnpm build --filter @repo/web`
   - **Build output directory:** `apps/web/.next`
   - **Root directory:** `/`

### Environment Variables (Cloudflare Pages)

For preview deployments, add these in Cloudflare Pages settings:

| Variable | Preview | Production |
|----------|---------|------------|
| `NODE_VERSION` | `20` | `20` |
| `PNPM_VERSION` | `9` | `9` |

**Note:** The web app is static-export, so it doesn't need runtime secrets.

### Preview Deployments

- Every PR creates a preview deployment at `<branch>.<project>.pages.dev`
- Merges to main deploy to production URL

## Local Development

Run the full CI check locally:

```bash
pnpm lint && pnpm type-check && pnpm test && pnpm build
```
```

**Step 2: Commit documentation**

```bash
git add docs/CI-CD.md
git commit -m "docs: add CI/CD pipeline documentation

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

---

## Task 3: Add Branch Protection Rules Documentation

**Files:**
- Modify: `docs/CI-CD.md`

**Step 1: Add branch protection section to CI-CD.md**

Append to the file:

```markdown

## Branch Protection (Recommended)

After CI is working, enable branch protection on `main`:

1. Go to GitHub repo > Settings > Branches
2. Add rule for `main`:
   - [x] Require a pull request before merging
   - [x] Require status checks to pass before merging
     - Select: `Lint, Type Check, Test`
   - [x] Require branches to be up to date before merging
   - [x] Do not allow bypassing the above settings

This ensures all code merged to main passes CI checks.
```

**Step 2: Commit**

```bash
git add docs/CI-CD.md
git commit -m "docs: add branch protection recommendations

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

---

## Task 4: Create Test PR to Verify CI

**Step 1: Create a test branch**

```bash
git checkout -b test/verify-ci-pipeline
```

**Step 2: Make a trivial change**

Add a comment to CHANGELOG.md under Unreleased:

```markdown
- CI/CD pipeline configured with GitHub Actions
```

**Step 3: Commit and push**

```bash
git add CHANGELOG.md
git commit -m "chore: add CI/CD changelog entry for verification

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
git push -u origin test/verify-ci-pipeline
```

**Step 4: Create PR**

```bash
gh pr create --title "test: verify CI pipeline" --body "Test PR to verify GitHub Actions CI workflow runs correctly.

## Checklist
- [ ] CI job triggers
- [ ] Lint passes
- [ ] Type-check passes
- [ ] Test passes

This PR can be merged after CI passes to also verify the build job."
```

**Step 5: Verify CI runs**

Run: `gh pr checks`
Expected: Shows CI job running or passed

**Step 6: Merge PR after CI passes**

```bash
gh pr merge --merge --delete-branch
```

---

## Task 5: Update ROADMAP Status

**Files:**
- Modify: `ROADMAP.md`

**Step 1: Mark Sprint 0.5 as completed**

Change line:
```
| 0.5 â¬œ | CI/CD pipeline | ðŸ”€ | 0.1 | PR triggers lint + type-check + test |
```
To:
```
| 0.5 âœ… | CI/CD pipeline | ðŸ”€ | 0.1 | PR triggers lint + type-check + test |
```

**Step 2: Update Active Sprint**

Change:
```
**Active Sprint:** 0.5 - CI/CD Pipeline
```
To:
```
**Active Sprint:** 0.6 - Integration Verification
```

**Step 3: Update progress count**

Change:
```
**Overall Progress:** 4/71 sprints
```
To:
```
**Overall Progress:** 5/71 sprints
```

**Step 4: Add changelog entry**

Add to Change Log table:
```
| 2026-01-24 | Sprint 0.5 completed: CI/CD pipeline with GitHub Actions |
```

**Step 5: Commit**

```bash
git add ROADMAP.md
git commit -m "docs: mark Sprint 0.5 CI/CD as complete

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

---

## Task 6: Cloudflare Pages Setup (Manual/Verification)

This task requires manual setup in Cloudflare Dashboard but can be verified.

**Step 1: Verify Cloudflare Pages connection (if already set up)**

Check if preview deploy URLs exist for recent PRs.

**Step 2: Document actual Cloudflare Pages URL**

Once connected, update `docs/CI-CD.md` with the actual preview URL pattern.

**Step 3: Verify preview deployment**

After connecting, any new PR should show a "View deployment" link in the PR checks.

---

## Gate Verification

Run these commands to verify sprint completion:

```bash
# 1. Verify CI workflow exists
cat .github/workflows/ci.yml

# 2. Verify local checks pass (same as CI)
pnpm lint && pnpm type-check && pnpm test && pnpm build

# 3. Verify CI runs on GitHub
gh run list --limit 5

# 4. Verify documentation exists
cat docs/CI-CD.md
```

**Gate Criteria:**
- [x] `.github/workflows/ci.yml` created
- [x] On PR: lint, type-check, test runs
- [x] On merge to main: build check runs
- [ ] Cloudflare Pages connected (preview deploys) - requires manual setup
- [x] Environment variables documented

---

## Notes for Implementer

1. **Turborepo Remote Cache (Optional):** If you want faster CI, set up Turborepo remote caching:
   - Create account at vercel.com
   - Run `npx turbo login` and `npx turbo link`
   - Add `TURBO_TOKEN` secret and `TURBO_TEAM` variable to GitHub

2. **Cloudflare Pages:** This requires manual setup in Cloudflare Dashboard. The web app uses static export, so it's straightforward to deploy.

3. **Build Environment:** The workflow includes placeholder env vars for build-time validation. Real secrets are only needed at runtime in production.

4. **Concurrency:** The workflow cancels in-progress runs when new commits are pushed to the same PR, saving CI minutes.
