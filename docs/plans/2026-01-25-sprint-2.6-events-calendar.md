# Sprint 2.6 - Events Calendar Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build public events calendar page at `/dogadanja` with FullCalendar month view, event list with tabs, and detailed event pages with "Add to Calendar" functionality.

**Architecture:** Server Component pages with client-side calendar. Main page fetches events based on active tab (upcoming/past) and current month. Detail page shows full event info with Google Calendar link and ICS download. URL state for tab and month navigation.

**Tech Stack:** Next.js 15 App Router, @fullcalendar/react, React Server Components, Tailwind CSS, @repo/database repository.

---

## Task 1: Install FullCalendar dependencies

**Files:**
- Modify: `packages/ui/package.json`

**Step 1: Install FullCalendar packages**

Run:
```bash
cd /mnt/c/VelikiBukovec_web && pnpm add -F @repo/ui @fullcalendar/core @fullcalendar/react @fullcalendar/daygrid
```

**Step 2: Verify installation**

Run: `pnpm install`
Expected: No errors, packages in node_modules

**Step 3: Commit**

```bash
git add packages/ui/package.json pnpm-lock.yaml
git commit -m "chore(ui): add FullCalendar dependencies"
```

---

## Task 2: Add repository methods for events page

**Files:**
- Modify: `packages/database/src/repositories/events.ts`

**Implementation:**

Add these methods to `eventsRepository`:

```typescript
/**
 * Get events for a specific month (for calendar display)
 */
async getEventsByMonth(year: number, month: number): Promise<Event[]> {
  const startDate = new Date(year, month - 1, 1);
  const endDate = new Date(year, month, 0, 23, 59, 59, 999);

  return db.event.findMany({
    where: {
      eventDate: {
        gte: startDate,
        lte: endDate,
      },
    },
    orderBy: { eventDate: 'asc' },
  });
},

/**
 * Get past events with pagination
 */
async getPastEvents(options: { page?: number; limit?: number } = {}): Promise<FindAllEventsResult> {
  const { page = 1, limit = 20 } = options;
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const where: Prisma.EventWhereInput = {
    eventDate: { lt: today },
  };

  const [total, events] = await Promise.all([
    db.event.count({ where }),
    db.event.findMany({
      where,
      orderBy: { eventDate: 'desc' },
      skip: (page - 1) * limit,
      take: limit,
    }),
  ]);

  return {
    events,
    pagination: {
      page,
      limit,
      total,
      totalPages: Math.ceil(total / limit),
    },
  };
},
```

**Verify:** `pnpm type-check`

**Commit:** `feat(database): add getEventsByMonth and getPastEvents for events page`

---

## Task 3: Create EventTabs component

**Files:**
- Create: `packages/ui/src/components/event-tabs.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
'use client';

import Link from 'next/link';
import { useSearchParams } from 'next/navigation';

import { cn } from '../lib/utils';

export interface EventTabsProps {
  className?: string;
}

export function EventTabs({ className }: EventTabsProps) {
  const searchParams = useSearchParams();
  const activeTab = searchParams.get('tab') || 'upcoming';

  const tabs = [
    { value: 'upcoming', label: 'Nadolazeći' },
    { value: 'past', label: 'Prošli' },
  ];

  const buildTabUrl = (tab: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (tab === 'upcoming') {
      params.delete('tab');
    } else {
      params.set('tab', tab);
    }
    params.delete('stranica'); // Reset pagination
    return `/dogadanja?${params.toString()}`;
  };

  return (
    <div className={cn('flex gap-2', className)}>
      {tabs.map((tab) => (
        <Link
          key={tab.value}
          href={buildTabUrl(tab.value)}
          className={cn(
            'rounded-lg px-4 py-2 text-sm font-medium transition-colors',
            activeTab === tab.value
              ? 'bg-primary-600 text-white'
              : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
          )}
          aria-current={activeTab === tab.value ? 'page' : undefined}
        >
          {tab.label}
        </Link>
      ))}
    </div>
  );
}
```

**Export:** Add `export * from './components/event-tabs';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add EventTabs component for upcoming/past toggle`

---

## Task 4: Create EventCalendar component

**Files:**
- Create: `packages/ui/src/components/event-calendar.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
'use client';

import FullCalendar from '@fullcalendar/react';
import dayGridPlugin from '@fullcalendar/daygrid';
import { useRouter } from 'next/navigation';

import { cn } from '../lib/utils';

export interface CalendarEvent {
  id: string;
  title: string;
  date: Date;
}

export interface EventCalendarProps {
  events: CalendarEvent[];
  initialDate?: Date;
  className?: string;
}

function getFirstWord(title: string): string {
  return title.split(' ')[0] || title;
}

export function EventCalendar({
  events,
  initialDate,
  className,
}: EventCalendarProps) {
  const router = useRouter();

  const calendarEvents = events.map((event) => ({
    id: event.id,
    title: getFirstWord(event.title),
    date: new Date(event.date).toISOString().split('T')[0],
    url: `/dogadanja/${event.id}`,
  }));

  return (
    <div className={cn('event-calendar', className)}>
      <style jsx global>{`
        .event-calendar .fc {
          --fc-border-color: rgb(229 231 235);
          --fc-today-bg-color: rgb(254 249 235);
          --fc-event-bg-color: rgb(22 101 52);
          --fc-event-border-color: rgb(22 101 52);
          --fc-event-text-color: white;
          font-family: inherit;
        }
        .event-calendar .fc-toolbar-title {
          font-size: 1.125rem;
          font-weight: 600;
          text-transform: capitalize;
        }
        .event-calendar .fc-button-primary {
          background-color: rgb(22 101 52);
          border-color: rgb(22 101 52);
        }
        .event-calendar .fc-button-primary:hover {
          background-color: rgb(21 128 61);
          border-color: rgb(21 128 61);
        }
        .event-calendar .fc-button-primary:disabled {
          background-color: rgb(156 163 175);
          border-color: rgb(156 163 175);
        }
        .event-calendar .fc-daygrid-event {
          font-size: 0.75rem;
          padding: 2px 4px;
          border-radius: 4px;
        }
        .event-calendar .fc-day-today {
          background-color: rgb(254 249 235) !important;
        }
        .event-calendar .fc-col-header-cell-cushion,
        .event-calendar .fc-daygrid-day-number {
          color: rgb(64 64 64);
        }
      `}</style>
      <FullCalendar
        plugins={[dayGridPlugin]}
        initialView="dayGridMonth"
        locale="hr"
        firstDay={1}
        headerToolbar={{
          left: 'prev',
          center: 'title',
          right: 'next',
        }}
        initialDate={initialDate}
        events={calendarEvents}
        eventClick={(info) => {
          info.jsEvent.preventDefault();
          if (info.event.url) {
            router.push(info.event.url);
          }
        }}
        height="auto"
      />
    </div>
  );
}
```

**Export:** Add `export * from './components/event-calendar';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add EventCalendar component with FullCalendar`

---

## Task 5: Create AddToCalendar component

**Files:**
- Create: `packages/ui/src/components/add-to-calendar.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
'use client';

import { Calendar, Download } from 'lucide-react';

import { Button } from '../primitives/button';
import { cn } from '../lib/utils';

export interface AddToCalendarProps {
  title: string;
  description: string | null;
  startDate: Date;
  endDate: Date | null;
  location: string | null;
  className?: string;
}

function formatDateForGoogle(date: Date): string {
  return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
}

function generateICS(props: AddToCalendarProps): string {
  const { title, description, startDate, endDate, location } = props;
  const start = formatDateForGoogle(startDate);
  const end = formatDateForGoogle(endDate || new Date(startDate.getTime() + 60 * 60 * 1000));

  return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Opcina Veliki Bukovec//Events//HR
BEGIN:VEVENT
DTSTART:${start}
DTEND:${end}
SUMMARY:${title}
DESCRIPTION:${description || ''}
LOCATION:${location || ''}
END:VEVENT
END:VCALENDAR`;
}

export function AddToCalendar({
  title,
  description,
  startDate,
  endDate,
  location,
  className,
}: AddToCalendarProps) {
  const start = formatDateForGoogle(startDate);
  const end = formatDateForGoogle(endDate || new Date(startDate.getTime() + 60 * 60 * 1000));

  const googleUrl = new URL('https://calendar.google.com/calendar/render');
  googleUrl.searchParams.set('action', 'TEMPLATE');
  googleUrl.searchParams.set('text', title);
  googleUrl.searchParams.set('dates', `${start}/${end}`);
  if (description) googleUrl.searchParams.set('details', description);
  if (location) googleUrl.searchParams.set('location', location);

  const handleDownloadICS = () => {
    const icsContent = generateICS({ title, description, startDate, endDate, location, className });
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${title.toLowerCase().replace(/\s+/g, '-')}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  return (
    <div className={cn('flex flex-col gap-2 sm:flex-row', className)}>
      <Button variant="outline" size="sm" asChild>
        <a
          href={googleUrl.toString()}
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Dodaj u Google Calendar"
        >
          <Calendar className="mr-2 h-4 w-4" />
          Google Calendar
        </a>
      </Button>
      <Button variant="outline" size="sm" onClick={handleDownloadICS}>
        <Download className="mr-2 h-4 w-4" />
        Preuzmi ICS
      </Button>
    </div>
  );
}
```

**Export:** Add `export * from './components/add-to-calendar';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add AddToCalendar component with Google and ICS`

---

## Task 6: Create EventHero component

**Files:**
- Create: `packages/ui/src/components/event-hero.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
import { cn } from '../lib/utils';

export interface EventHeroProps {
  title: string;
  posterImage: string;
  className?: string;
}

export function EventHero({ title, posterImage, className }: EventHeroProps) {
  return (
    <div className={cn('relative h-64 w-full overflow-hidden rounded-lg md:h-80', className)}>
      <img
        src={posterImage}
        alt={title}
        className="h-full w-full object-cover"
      />
      <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent" />
    </div>
  );
}
```

**Export:** Add `export * from './components/event-hero';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add EventHero component for event detail page`

---

## Task 7: Create events listing page

**Files:**
- Create: `apps/web/app/dogadanja/page.tsx`

**Implementation:**

```tsx
import { eventsRepository } from '@repo/database';
import {
  EventCalendar,
  EventCard,
  EventTabs,
  FadeIn,
} from '@repo/ui';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

import type { Metadata } from 'next';

export const revalidate = 60;

export const metadata: Metadata = {
  title: 'Događanja',
  description: 'Kalendar događanja i aktivnosti u Općini Veliki Bukovec.',
  openGraph: {
    title: 'Događanja - Općina Veliki Bukovec',
    description: 'Kalendar događanja i aktivnosti u Općini Veliki Bukovec.',
    type: 'website',
  },
};

interface EventsPageProps {
  searchParams: Promise<{
    tab?: string;
    mjesec?: string;
    stranica?: string;
  }>;
}

export default async function EventsPage({ searchParams }: EventsPageProps) {
  const params = await searchParams;
  const tab = params.tab || 'upcoming';
  const page = params.stranica ? parseInt(params.stranica, 10) : 1;

  // Parse month or default to current
  const now = new Date();
  let calendarYear = now.getFullYear();
  let calendarMonth = now.getMonth() + 1;

  if (params.mjesec) {
    const [y, m] = params.mjesec.split('-').map(Number);
    if (y && m && m >= 1 && m <= 12) {
      calendarYear = y;
      calendarMonth = m;
    }
  }

  // Fetch data
  const [eventsResult, calendarEvents] = await Promise.all([
    tab === 'upcoming'
      ? eventsRepository.findAll({ upcoming: true, page, limit: 10, sortBy: 'eventDate', sortOrder: 'asc' })
      : eventsRepository.getPastEvents({ page, limit: 10 }),
    eventsRepository.getEventsByMonth(calendarYear, calendarMonth),
  ]);

  const { events, pagination } = eventsResult;

  return (
    <>
      {/* Back link */}
      <div className="container mx-auto px-4 py-4">
        <Link
          href="/"
          className="inline-flex items-center gap-2 text-sm text-neutral-600 hover:text-primary-600"
        >
          <ArrowLeft className="h-4 w-4" />
          Povratak na početnu
        </Link>
      </div>

      {/* Header */}
      <div className="container mx-auto px-4 pb-6">
        <FadeIn>
          <h1 className="font-display text-3xl font-bold text-neutral-900 md:text-4xl">
            Događanja
          </h1>
          <p className="mt-2 text-neutral-600">
            Kalendar događanja Općine Veliki Bukovec
          </p>
        </FadeIn>
      </div>

      {/* Main content */}
      <div className="container mx-auto px-4 pb-12">
        {/* Tabs */}
        <FadeIn>
          <EventTabs className="mb-6" />
        </FadeIn>

        {/* Calendar */}
        <FadeIn delay={0.1}>
          <EventCalendar
            events={calendarEvents.map((e) => ({
              id: e.id,
              title: e.title,
              date: e.eventDate,
            }))}
            initialDate={new Date(calendarYear, calendarMonth - 1, 1)}
            className="mb-8 rounded-lg border border-neutral-200 bg-white p-4"
          />
        </FadeIn>

        {/* Events list */}
        <FadeIn delay={0.2}>
          <h2 className="mb-4 text-lg font-semibold text-neutral-900">
            {tab === 'upcoming' ? 'Nadolazeći događaji' : 'Prošli događaji'}
          </h2>
          {events.length > 0 ? (
            <div className="space-y-3">
              {events.map((event, index) => (
                <FadeIn key={event.id} delay={0.1 + index * 0.03}>
                  <EventCard
                    id={event.id}
                    title={event.title}
                    description={event.description}
                    eventDate={event.eventDate}
                    location={event.location}
                    posterImage={event.posterImage}
                  />
                </FadeIn>
              ))}
            </div>
          ) : (
            <div className="rounded-lg border border-neutral-200 bg-neutral-50 p-8 text-center">
              <p className="text-neutral-600">
                {tab === 'upcoming'
                  ? 'Trenutno nema nadolazećih događanja.'
                  : 'Nema prošlih događanja.'}
              </p>
            </div>
          )}
        </FadeIn>

        {/* Pagination placeholder - add if needed */}
        {pagination.totalPages > 1 && (
          <div className="mt-8 text-center text-sm text-neutral-500">
            Stranica {pagination.page} od {pagination.totalPages}
          </div>
        )}
      </div>
    </>
  );
}
```

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(web): add events listing page with calendar and tabs`

---

## Task 8: Create event detail page

**Files:**
- Create: `apps/web/app/dogadanja/[id]/page.tsx`

**Implementation:**

```tsx
import { eventsRepository } from '@repo/database';
import {
  AddToCalendar,
  EventHero,
  FadeIn,
} from '@repo/ui';
import { ArrowLeft, CalendarDays, MapPin } from 'lucide-react';
import Link from 'next/link';
import { notFound } from 'next/navigation';

import type { Metadata } from 'next';

export const revalidate = 60;

interface EventDetailPageProps {
  params: Promise<{ id: string }>;
}

export async function generateMetadata({
  params,
}: EventDetailPageProps): Promise<Metadata> {
  const { id } = await params;
  const event = await eventsRepository.findById(id);

  if (!event) {
    return { title: 'Događanje nije pronađeno' };
  }

  const description = event.description
    ? event.description.slice(0, 160)
    : 'Događanje u Općini Veliki Bukovec';

  return {
    title: event.title,
    description,
    openGraph: {
      title: `${event.title} - Događanja - Općina Veliki Bukovec`,
      description,
      type: 'article',
      ...(event.posterImage && { images: [event.posterImage] }),
    },
  };
}

export default async function EventDetailPage({
  params,
}: EventDetailPageProps) {
  const { id } = await params;
  const event = await eventsRepository.findById(id);

  if (!event) {
    notFound();
  }

  const eventDate = new Date(event.eventDate);
  const day = eventDate.getDate();
  const month = new Intl.DateTimeFormat('hr-HR', { month: 'short' }).format(eventDate);

  const formattedDate = new Intl.DateTimeFormat('hr-HR', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(eventDate);

  const formattedTime = event.eventTime
    ? new Intl.DateTimeFormat('hr-HR', {
        hour: '2-digit',
        minute: '2-digit',
      }).format(new Date(event.eventTime))
    : null;

  const googleMapsUrl = event.location
    ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}`
    : null;

  return (
    <>
      {/* Back link */}
      <div className="container mx-auto px-4 py-4">
        <Link
          href="/dogadanja"
          className="inline-flex items-center gap-2 text-sm text-neutral-600 hover:text-primary-600"
        >
          <ArrowLeft className="h-4 w-4" />
          Povratak na događanja
        </Link>
      </div>

      {/* Hero image */}
      {event.posterImage && (
        <div className="container mx-auto px-4 pb-6">
          <FadeIn>
            <EventHero title={event.title} posterImage={event.posterImage} />
          </FadeIn>
        </div>
      )}

      {/* Content */}
      <div className="container mx-auto px-4 pb-12">
        <div className="max-w-3xl">
          {/* Title with date badge */}
          <FadeIn>
            <div className="mb-6 flex items-start gap-4">
              <div className="flex h-16 w-16 flex-shrink-0 flex-col items-center justify-center rounded-lg bg-primary-50 text-primary-700">
                <span className="text-2xl font-bold leading-none">{day}</span>
                <span className="text-xs uppercase">{month}</span>
              </div>
              <h1 className="font-display text-2xl font-bold text-neutral-900 md:text-3xl">
                {event.title}
              </h1>
            </div>
          </FadeIn>

          {/* Date and location */}
          <FadeIn delay={0.1}>
            <div className="mb-6 space-y-2 text-neutral-600">
              <div className="flex items-center gap-2">
                <CalendarDays className="h-5 w-5 text-neutral-400" />
                <span>
                  {formattedDate}
                  {formattedTime && ` u ${formattedTime}`}
                </span>
              </div>
              {event.location && (
                <div className="flex items-center gap-2">
                  <MapPin className="h-5 w-5 text-neutral-400" />
                  <span>{event.location}</span>
                  {googleMapsUrl && (
                    <a
                      href={googleMapsUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-sm text-primary-600 hover:underline"
                    >
                      Prikaži na karti →
                    </a>
                  )}
                </div>
              )}
            </div>
          </FadeIn>

          {/* Add to calendar */}
          <FadeIn delay={0.2}>
            <div className="mb-8 rounded-lg border border-neutral-200 bg-neutral-50 p-4">
              <p className="mb-3 text-sm font-medium text-neutral-700">
                Dodaj u kalendar
              </p>
              <AddToCalendar
                title={event.title}
                description={event.description}
                startDate={eventDate}
                endDate={event.endDate}
                location={event.location}
              />
            </div>
          </FadeIn>

          {/* Description */}
          {event.description && (
            <FadeIn delay={0.3}>
              <div className="prose prose-neutral max-w-none">
                <h2>Opis događanja</h2>
                <div dangerouslySetInnerHTML={{ __html: event.description }} />
              </div>
            </FadeIn>
          )}
        </div>
      </div>
    </>
  );
}
```

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(web): add event detail page with Add to Calendar`

---

## Task 9: Final verification and documentation

**Step 1:** Run full verification
```bash
pnpm type-check && pnpm lint
```

**Step 2:** Update CHANGELOG.md - add Sprint 2.6 section

**Step 3:** Update ROADMAP.md - mark Sprint 2.6 complete, update progress to 27/71

**Commit:** `docs: update documentation for Sprint 2.6 completion`

---

## Summary

| Task | Component | Files |
|------|-----------|-------|
| 1 | Dependencies | `packages/ui/package.json` |
| 2 | Repository methods | `packages/database/src/repositories/events.ts` |
| 3 | EventTabs | `packages/ui/src/components/event-tabs.tsx` |
| 4 | EventCalendar | `packages/ui/src/components/event-calendar.tsx` |
| 5 | AddToCalendar | `packages/ui/src/components/add-to-calendar.tsx` |
| 6 | EventHero | `packages/ui/src/components/event-hero.tsx` |
| 7 | Events page | `apps/web/app/dogadanja/page.tsx` |
| 8 | Event detail page | `apps/web/app/dogadanja/[id]/page.tsx` |
| 9 | Documentation | `CHANGELOG.md`, `ROADMAP.md` |

**Gate:** Browse events at `/dogadanja`, switch tabs, click calendar event, see details, add to Google Calendar, download ICS.
