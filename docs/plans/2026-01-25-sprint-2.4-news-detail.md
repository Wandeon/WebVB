# Sprint 2.4 - News Detail Page Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build the news detail page at `/vijesti/[slug]` with hero, article content, share buttons, related posts, and SEO metadata.

**Architecture:** Server Component page fetching post by slug, with client-side share buttons. Reuses PostCard for related posts. Dynamic metadata generation.

**Tech Stack:** Next.js 15 App Router, React Server Components, Tailwind Typography, @repo/database repository.

---

## Task 1: Add getRelatedPosts repository method

**Files:**
- Modify: `packages/database/src/repositories/posts.ts`

**Implementation:**

Add this method to `postsRepository`:

```typescript
/**
 * Get related posts from same category, excluding current post
 */
async getRelatedPosts(
  excludeId: string,
  category: string,
  limit: number = 3
): Promise<PostWithAuthor[]> {
  return db.post.findMany({
    where: {
      id: { not: excludeId },
      category,
      publishedAt: { not: null },
    },
    include: { author: { select: authorSelect } },
    orderBy: { publishedAt: 'desc' },
    take: limit,
  });
},
```

**Verify:** `pnpm type-check`

**Commit:** `feat(database): add getRelatedPosts method for related articles`

---

## Task 2: Create ArticleHero component

**Files:**
- Create: `packages/ui/src/components/article-hero.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
import { Badge } from '../primitives/badge';
import { cn } from '../lib/utils';

export interface ArticleHeroProps {
  title: string;
  category: string;
  categoryLabel: string;
  publishedAt: Date;
  featuredImage: string | null;
  className?: string;
}

export function ArticleHero({
  title,
  category,
  categoryLabel,
  publishedAt,
  featuredImage,
  className,
}: ArticleHeroProps) {
  const formattedDate = new Intl.DateTimeFormat('hr-HR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(new Date(publishedAt));

  return (
    <div
      className={cn(
        'relative flex min-h-[300px] items-end bg-primary-900 md:min-h-[400px]',
        className
      )}
    >
      {featuredImage && (
        <img
          src={featuredImage}
          alt=""
          className="absolute inset-0 h-full w-full object-cover"
        />
      )}
      <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent" />
      <div className="relative z-10 w-full px-4 pb-8 pt-16 md:pb-12">
        <div className="container mx-auto">
          <div className="mb-4 flex items-center gap-3">
            <Badge variant="secondary">{categoryLabel}</Badge>
            <span className="text-sm text-white/80">{formattedDate}</span>
          </div>
          <h1 className="font-display text-3xl font-bold text-white md:text-4xl lg:text-5xl">
            {title}
          </h1>
        </div>
      </div>
    </div>
  );
}
```

**Export:** Add `export * from './components/article-hero';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add ArticleHero component for news detail`

---

## Task 3: Create ArticleContent component

**Files:**
- Create: `packages/ui/src/components/article-content.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
import { cn } from '../lib/utils';

export interface ArticleContentProps {
  content: string;
  className?: string;
}

export function ArticleContent({ content, className }: ArticleContentProps) {
  return (
    <article
      className={cn(
        'prose prose-neutral max-w-none',
        'prose-headings:font-display prose-headings:font-semibold',
        'prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline',
        'prose-img:rounded-lg',
        className
      )}
      dangerouslySetInnerHTML={{ __html: content }}
    />
  );
}
```

**Export:** Add `export * from './components/article-content';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add ArticleContent component with prose styling`

---

## Task 4: Create ShareButtons component

**Files:**
- Create: `packages/ui/src/components/share-buttons.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
'use client';

import { Facebook, Link2, Check } from 'lucide-react';
import { useState } from 'react';

import { Button } from '../primitives/button';
import { cn } from '../lib/utils';

export interface ShareButtonsProps {
  url: string;
  title: string;
  className?: string;
}

export function ShareButtons({ url, title, className }: ShareButtonsProps) {
  const [copied, setCopied] = useState(false);

  const handleFacebookShare = () => {
    const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    window.open(shareUrl, 'facebook-share', 'width=580,height=296');
  };

  const handleCopyLink = async () => {
    try {
      await navigator.clipboard.writeText(url);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = url;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  return (
    <div className={cn('flex items-center gap-2', className)}>
      <span className="text-sm text-neutral-500">Podijeli:</span>
      <Button
        variant="outline"
        size="sm"
        onClick={handleFacebookShare}
        aria-label="Podijeli na Facebook"
      >
        <Facebook className="h-4 w-4" />
      </Button>
      <Button
        variant="outline"
        size="sm"
        onClick={() => void handleCopyLink()}
        aria-label={copied ? 'Kopirano' : 'Kopiraj poveznicu'}
      >
        {copied ? (
          <>
            <Check className="h-4 w-4" />
            <span className="ml-1">Kopirano!</span>
          </>
        ) : (
          <Link2 className="h-4 w-4" />
        )}
      </Button>
    </div>
  );
}
```

**Export:** Add `export * from './components/share-buttons';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add ShareButtons component for social sharing`

---

## Task 5: Create RelatedPosts component

**Files:**
- Create: `packages/ui/src/components/related-posts.tsx`
- Modify: `packages/ui/src/index.ts`

**Implementation:**

```tsx
import { PostCard } from './post-card';
import { cn } from '../lib/utils';

export interface RelatedPost {
  title: string;
  excerpt: string | null;
  slug: string;
  category: string;
  categoryLabel: string;
  featuredImage: string | null;
  publishedAt: Date | null;
}

export interface RelatedPostsProps {
  posts: RelatedPost[];
  className?: string;
}

export function RelatedPosts({ posts, className }: RelatedPostsProps) {
  if (posts.length === 0) return null;

  return (
    <aside className={cn('', className)}>
      <h2 className="mb-4 font-display text-lg font-semibold text-neutral-900">
        Povezane vijesti
      </h2>
      <div className="space-y-4">
        {posts.map((post) => (
          <PostCard
            key={post.slug}
            title={post.title}
            excerpt={post.excerpt}
            slug={post.slug}
            category={post.categoryLabel}
            featuredImage={post.featuredImage}
            publishedAt={post.publishedAt}
          />
        ))}
      </div>
    </aside>
  );
}
```

**Export:** Add `export * from './components/related-posts';` to index.ts

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(ui): add RelatedPosts sidebar component`

---

## Task 6: Create news detail page

**Files:**
- Create: `apps/web/app/vijesti/[slug]/page.tsx`

**Implementation:**

```tsx
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';
import { notFound } from 'next/navigation';

import { postsRepository, type PostWithAuthor } from '@repo/database';
import { POST_CATEGORIES } from '@repo/shared';
import {
  ArticleContent,
  ArticleHero,
  FadeIn,
  RelatedPosts,
  ShareButtons,
} from '@repo/ui';

import type { Metadata } from 'next';

export const revalidate = 60;

interface NewsDetailPageProps {
  params: Promise<{ slug: string }>;
}

function stripHtml(html: string): string {
  return html.replace(/<[^>]*>/g, '').trim();
}

function truncate(text: string, length: number): string {
  if (text.length <= length) return text;
  return text.slice(0, length).trim() + '...';
}

export async function generateMetadata({
  params,
}: NewsDetailPageProps): Promise<Metadata> {
  const { slug } = await params;
  const post = await postsRepository.findBySlug(slug);

  if (!post || !post.publishedAt) {
    return { title: 'Vijest nije pronaÄ‘ena' };
  }

  const description = post.excerpt || truncate(stripHtml(post.content), 160);

  return {
    title: post.title,
    description,
    openGraph: {
      title: post.title,
      description,
      type: 'article',
      publishedTime: post.publishedAt.toISOString(),
      images: post.featuredImage ? [post.featuredImage] : [],
    },
  };
}

export async function generateStaticParams() {
  const { posts } = await postsRepository.findPublished({ limit: 100 });
  return posts.map((post) => ({ slug: post.slug }));
}

export default async function NewsDetailPage({ params }: NewsDetailPageProps) {
  const { slug } = await params;
  const post = await postsRepository.findBySlug(slug);

  if (!post || !post.publishedAt) {
    notFound();
  }

  const relatedPosts = await postsRepository.getRelatedPosts(
    post.id,
    post.category,
    3
  );

  const categoryLabel =
    POST_CATEGORIES[post.category as keyof typeof POST_CATEGORIES] ||
    post.category;

  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://velikibukovec.hr';
  const articleUrl = `${baseUrl}/vijesti/${post.slug}`;

  return (
    <>
      {/* Back link */}
      <div className="container mx-auto px-4 py-4">
        <Link
          href="/vijesti"
          className="inline-flex items-center gap-2 text-sm text-neutral-600 hover:text-primary-600"
        >
          <ArrowLeft className="h-4 w-4" />
          Povratak na vijesti
        </Link>
      </div>

      {/* Hero */}
      <FadeIn>
        <ArticleHero
          title={post.title}
          category={post.category}
          categoryLabel={categoryLabel}
          publishedAt={post.publishedAt}
          featuredImage={post.featuredImage}
        />
      </FadeIn>

      {/* Content */}
      <div className="container mx-auto px-4 py-8 md:py-12">
        <div className="grid gap-8 lg:grid-cols-[1fr,300px]">
          {/* Main content */}
          <div>
            <FadeIn>
              <ArticleContent content={post.content} />
            </FadeIn>

            <FadeIn>
              <div className="mt-8 border-t border-neutral-200 pt-6">
                <ShareButtons url={articleUrl} title={post.title} />
              </div>
            </FadeIn>
          </div>

          {/* Sidebar */}
          {relatedPosts.length > 0 && (
            <FadeIn direction="right">
              <RelatedPosts
                posts={relatedPosts.map((p: PostWithAuthor) => ({
                  title: p.title,
                  excerpt: p.excerpt,
                  slug: p.slug,
                  category: p.category,
                  categoryLabel:
                    POST_CATEGORIES[p.category as keyof typeof POST_CATEGORIES] ||
                    p.category,
                  featuredImage: p.featuredImage,
                  publishedAt: p.publishedAt,
                }))}
                className="lg:sticky lg:top-8"
              />
            </FadeIn>
          )}
        </div>
      </div>
    </>
  );
}
```

**Verify:** `pnpm type-check && pnpm lint`

**Commit:** `feat(web): add news detail page with hero, content, sharing, related posts`

---

## Task 7: Final verification and documentation

**Step 1:** Run full verification
```bash
pnpm type-check && pnpm lint && pnpm test
```

**Step 2:** Update CHANGELOG.md - add Sprint 2.4 section

**Step 3:** Update ROADMAP.md - mark Sprint 2.4 complete, update progress to 4/12

**Commit:** `docs: update documentation for Sprint 2.4 completion`

---

## Summary

| Task | Component | Files |
|------|-----------|-------|
| 1 | Repository | `packages/database/src/repositories/posts.ts` |
| 2 | ArticleHero | `packages/ui/src/components/article-hero.tsx` |
| 3 | ArticleContent | `packages/ui/src/components/article-content.tsx` |
| 4 | ShareButtons | `packages/ui/src/components/share-buttons.tsx` |
| 5 | RelatedPosts | `packages/ui/src/components/related-posts.tsx` |
| 6 | Detail page | `apps/web/app/vijesti/[slug]/page.tsx` |
| 7 | Documentation | `CHANGELOG.md`, `ROADMAP.md` |

**Gate:** Open article at `/vijesti/[slug]`, layout looks professional, OG tags correct.
