# Sprint 2.3 - News Listing Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a complete news listing page at `/vijesti` with featured post hero, filterable grid, category pills, pagination, and URL state persistence.

**Architecture:** Server-side rendered page using existing `postsRepository.findAll()` with search params for filtering. Client-side category filter pills update URL. Reuses `PostCard` and `HeroSection` components from Sprint 2.2.

**Tech Stack:** Next.js 15 App Router, React Server Components, `@repo/database` repository, `@repo/ui` components, `nuqs` for URL state (or native searchParams), Tailwind CSS.

---

## Task 1: Add repository method for public posts listing

**Files:**
- Modify: `packages/database/src/repositories/posts.ts`

**Step 1: Add findPublished method to postsRepository**

Add a new method specifically for public-facing posts that only returns published posts:

```typescript
export interface FindPublishedPostsOptions {
  page?: number;
  limit?: number;
  category?: string;
}

export interface FindPublishedPostsResult {
  posts: PostWithAuthor[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

Then add the method:

```typescript
/**
 * Find published posts for public listing (excludes drafts)
 */
async findPublished(options: FindPublishedPostsOptions = {}): Promise<FindPublishedPostsResult> {
  const { page = 1, limit = 12, category } = options;

  const where: Prisma.PostWhereInput = {
    publishedAt: { not: null },
  };

  if (category) {
    where.category = category;
  }

  const [total, posts] = await Promise.all([
    db.post.count({ where }),
    db.post.findMany({
      where,
      include: { author: { select: authorSelect } },
      orderBy: { publishedAt: 'desc' },
      skip: (page - 1) * limit,
      take: limit,
    }),
  ]);

  return {
    posts,
    pagination: {
      page,
      limit,
      total,
      totalPages: Math.ceil(total / limit),
    },
  };
},
```

**Step 2: Export new types from repository index**

Ensure `FindPublishedPostsOptions` and `FindPublishedPostsResult` are exported.

**Step 3: Run type-check**

Run: `pnpm type-check`
Expected: PASS

**Step 4: Commit**

```bash
git add packages/database/src/repositories/posts.ts
git commit -m "feat(database): add findPublished method for public news listing"
```

---

## Task 2: Create CategoryFilter client component

**Files:**
- Create: `packages/ui/src/components/category-filter.tsx`
- Modify: `packages/ui/src/index.ts`

**Step 1: Create the CategoryFilter component**

```tsx
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { useCallback } from 'react';

import { cn } from '../lib/utils';

export interface CategoryFilterProps {
  categories: { value: string; label: string }[];
  allLabel?: string;
  className?: string;
}

export function CategoryFilter({
  categories,
  allLabel = 'Sve',
  className,
}: CategoryFilterProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const currentCategory = searchParams.get('kategorija');

  const handleCategoryChange = useCallback(
    (category: string | null) => {
      const params = new URLSearchParams(searchParams.toString());
      if (category) {
        params.set('kategorija', category);
      } else {
        params.delete('kategorija');
      }
      // Reset to page 1 when changing category
      params.delete('stranica');
      router.push(`?${params.toString()}`, { scroll: false });
    },
    [router, searchParams]
  );

  return (
    <div className={cn('flex flex-wrap gap-2', className)}>
      <button
        onClick={() => handleCategoryChange(null)}
        className={cn(
          'rounded-full px-4 py-2 text-sm font-medium transition-colors',
          !currentCategory
            ? 'bg-primary-600 text-white'
            : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
        )}
      >
        {allLabel}
      </button>
      {categories.map((cat) => (
        <button
          key={cat.value}
          onClick={() => handleCategoryChange(cat.value)}
          className={cn(
            'rounded-full px-4 py-2 text-sm font-medium transition-colors',
            currentCategory === cat.value
              ? 'bg-primary-600 text-white'
              : 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
          )}
        >
          {cat.label}
        </button>
      ))}
    </div>
  );
}
```

**Step 2: Export from index**

Add to `packages/ui/src/index.ts`:

```typescript
export * from './components/category-filter';
```

**Step 3: Run type-check and lint**

Run: `pnpm type-check && pnpm lint`
Expected: PASS

**Step 4: Commit**

```bash
git add packages/ui/src/components/category-filter.tsx packages/ui/src/index.ts
git commit -m "feat(ui): add CategoryFilter component with URL state"
```

---

## Task 3: Create Pagination component

**Files:**
- Create: `packages/ui/src/components/pagination.tsx`
- Modify: `packages/ui/src/index.ts`

**Step 1: Create the Pagination component**

```tsx
'use client';

import { ChevronLeft, ChevronRight } from 'lucide-react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';

import { cn } from '../lib/utils';

export interface PaginationProps {
  currentPage: number;
  totalPages: number;
  baseUrl?: string;
  pageParam?: string;
  className?: string;
}

export function Pagination({
  currentPage,
  totalPages,
  baseUrl = '',
  pageParam = 'stranica',
  className,
}: PaginationProps) {
  const searchParams = useSearchParams();

  if (totalPages <= 1) return null;

  const createPageUrl = (page: number) => {
    const params = new URLSearchParams(searchParams.toString());
    if (page === 1) {
      params.delete(pageParam);
    } else {
      params.set(pageParam, page.toString());
    }
    const queryString = params.toString();
    return `${baseUrl}${queryString ? `?${queryString}` : ''}`;
  };

  // Generate page numbers to display
  const getPageNumbers = () => {
    const pages: (number | 'ellipsis')[] = [];
    const showEllipsis = totalPages > 7;

    if (!showEllipsis) {
      for (let i = 1; i <= totalPages; i++) {
        pages.push(i);
      }
    } else {
      // Always show first page
      pages.push(1);

      if (currentPage > 3) {
        pages.push('ellipsis');
      }

      // Show pages around current
      const start = Math.max(2, currentPage - 1);
      const end = Math.min(totalPages - 1, currentPage + 1);

      for (let i = start; i <= end; i++) {
        pages.push(i);
      }

      if (currentPage < totalPages - 2) {
        pages.push('ellipsis');
      }

      // Always show last page
      pages.push(totalPages);
    }

    return pages;
  };

  const pageNumbers = getPageNumbers();

  return (
    <nav
      aria-label="Navigacija stranicama"
      className={cn('flex items-center justify-center gap-1', className)}
    >
      {/* Previous button */}
      {currentPage > 1 ? (
        <Link
          href={createPageUrl(currentPage - 1)}
          className="flex h-10 w-10 items-center justify-center rounded-lg text-neutral-600 transition-colors hover:bg-neutral-100"
          aria-label="Prethodna stranica"
        >
          <ChevronLeft className="h-5 w-5" />
        </Link>
      ) : (
        <span className="flex h-10 w-10 items-center justify-center text-neutral-300">
          <ChevronLeft className="h-5 w-5" />
        </span>
      )}

      {/* Page numbers */}
      {pageNumbers.map((page, index) =>
        page === 'ellipsis' ? (
          <span
            key={`ellipsis-${index}`}
            className="flex h-10 w-10 items-center justify-center text-neutral-400"
          >
            ...
          </span>
        ) : (
          <Link
            key={page}
            href={createPageUrl(page)}
            className={cn(
              'flex h-10 w-10 items-center justify-center rounded-lg text-sm font-medium transition-colors',
              page === currentPage
                ? 'bg-primary-600 text-white'
                : 'text-neutral-600 hover:bg-neutral-100'
            )}
            aria-current={page === currentPage ? 'page' : undefined}
          >
            {page}
          </Link>
        )
      )}

      {/* Next button */}
      {currentPage < totalPages ? (
        <Link
          href={createPageUrl(currentPage + 1)}
          className="flex h-10 w-10 items-center justify-center rounded-lg text-neutral-600 transition-colors hover:bg-neutral-100"
          aria-label="Sljedeća stranica"
        >
          <ChevronRight className="h-5 w-5" />
        </Link>
      ) : (
        <span className="flex h-10 w-10 items-center justify-center text-neutral-300">
          <ChevronRight className="h-5 w-5" />
        </span>
      )}
    </nav>
  );
}
```

**Step 2: Export from index**

Add to `packages/ui/src/index.ts`:

```typescript
export * from './components/pagination';
```

**Step 3: Run type-check and lint**

Run: `pnpm type-check && pnpm lint`
Expected: PASS

**Step 4: Commit**

```bash
git add packages/ui/src/components/pagination.tsx packages/ui/src/index.ts
git commit -m "feat(ui): add Pagination component with URL state"
```

---

## Task 4: Create PostCardSkeleton component

**Files:**
- Create: `packages/ui/src/components/post-card-skeleton.tsx`
- Modify: `packages/ui/src/index.ts`

**Step 1: Create the skeleton component**

```tsx
import { cn } from '../lib/utils';

export interface PostCardSkeletonProps {
  className?: string;
}

export function PostCardSkeleton({ className }: PostCardSkeletonProps) {
  return (
    <div
      className={cn(
        'overflow-hidden rounded-lg border border-neutral-200 bg-white shadow-sm',
        className
      )}
    >
      {/* Image placeholder */}
      <div className="aspect-video animate-pulse bg-neutral-200" />
      <div className="p-4">
        {/* Badge and date */}
        <div className="mb-2 flex items-center gap-2">
          <div className="h-5 w-20 animate-pulse rounded-full bg-neutral-200" />
          <div className="h-4 w-24 animate-pulse rounded bg-neutral-200" />
        </div>
        {/* Title */}
        <div className="h-6 w-full animate-pulse rounded bg-neutral-200" />
        <div className="mt-1 h-6 w-3/4 animate-pulse rounded bg-neutral-200" />
        {/* Excerpt */}
        <div className="mt-2 h-4 w-full animate-pulse rounded bg-neutral-200" />
        <div className="mt-1 h-4 w-5/6 animate-pulse rounded bg-neutral-200" />
      </div>
    </div>
  );
}
```

**Step 2: Export from index**

Add to `packages/ui/src/index.ts`:

```typescript
export * from './components/post-card-skeleton';
```

**Step 3: Run type-check and lint**

Run: `pnpm type-check && pnpm lint`
Expected: PASS

**Step 4: Commit**

```bash
git add packages/ui/src/components/post-card-skeleton.tsx packages/ui/src/index.ts
git commit -m "feat(ui): add PostCardSkeleton for loading states"
```

---

## Task 5: Create news listing page

**Files:**
- Create: `apps/web/app/vijesti/page.tsx`

**Step 1: Create the news listing page**

```tsx
import { Suspense } from 'react';

import { postsRepository, type PostWithAuthor } from '@repo/database';
import { POST_CATEGORIES, POST_CATEGORY_OPTIONS } from '@repo/shared';
import {
  CategoryFilter,
  FadeIn,
  HeroSection,
  Pagination,
  PostCard,
  PostCardSkeleton,
  SectionHeader,
} from '@repo/ui';

export const revalidate = 60;

interface NewsPageProps {
  searchParams: Promise<{
    kategorija?: string;
    stranica?: string;
  }>;
}

async function NewsContent({
  category,
  page,
}: {
  category?: string;
  page: number;
}) {
  const { posts, pagination } = await postsRepository.findPublished({
    page,
    limit: 12,
    category,
  });

  // Get featured post (first post if on page 1 with no filters)
  const featuredPost =
    page === 1 && !category ? await postsRepository.getFeaturedPost() : null;

  // Filter out featured post from grid if showing it
  const gridPosts = featuredPost
    ? posts.filter((p) => p.id !== featuredPost.id)
    : posts;

  return (
    <>
      {/* Featured Hero (only on page 1 with no category filter) */}
      {featuredPost && (
        <FadeIn>
          <HeroSection post={featuredPost} />
        </FadeIn>
      )}

      {/* Posts Grid */}
      {gridPosts.length > 0 ? (
        <>
          <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {gridPosts.map((post: PostWithAuthor, index: number) => (
              <FadeIn key={post.id} delay={index * 0.05}>
                <PostCard
                  title={post.title}
                  excerpt={post.excerpt}
                  slug={post.slug}
                  category={
                    POST_CATEGORIES[
                      post.category as keyof typeof POST_CATEGORIES
                    ] || post.category
                  }
                  featuredImage={post.featuredImage}
                  publishedAt={post.publishedAt}
                />
              </FadeIn>
            ))}
          </div>

          {/* Pagination */}
          <FadeIn>
            <Pagination
              currentPage={pagination.page}
              totalPages={pagination.totalPages}
              className="mt-12"
            />
          </FadeIn>
        </>
      ) : (
        <FadeIn>
          <div className="rounded-lg bg-neutral-100 py-12 text-center">
            <p className="text-neutral-600">
              {category
                ? 'Nema vijesti u odabranoj kategoriji.'
                : 'Trenutno nema objavljenih vijesti.'}
            </p>
          </div>
        </FadeIn>
      )}
    </>
  );
}

function NewsContentSkeleton() {
  return (
    <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      {Array.from({ length: 12 }).map((_, i) => (
        <PostCardSkeleton key={i} />
      ))}
    </div>
  );
}

export default async function NewsPage({ searchParams }: NewsPageProps) {
  const params = await searchParams;
  const category = params.kategorija;
  const page = Math.max(1, parseInt(params.stranica || '1', 10));

  return (
    <div className="py-8 md:py-12">
      <div className="container mx-auto px-4">
        {/* Page Header */}
        <FadeIn>
          <SectionHeader
            title="Vijesti"
            description="Pratite sve novosti i događanja iz Općine Veliki Bukovec"
          />
        </FadeIn>

        {/* Category Filter */}
        <FadeIn>
          <Suspense fallback={null}>
            <CategoryFilter
              categories={POST_CATEGORY_OPTIONS}
              allLabel="Sve vijesti"
              className="mb-8"
            />
          </Suspense>
        </FadeIn>

        {/* News Content */}
        <Suspense fallback={<NewsContentSkeleton />}>
          <NewsContent category={category} page={page} />
        </Suspense>
      </div>
    </div>
  );
}
```

**Step 2: Run type-check and lint**

Run: `pnpm type-check && pnpm lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/app/vijesti/page.tsx
git commit -m "feat(web): add news listing page with filtering and pagination"
```

---

## Task 6: Add metadata for news page

**Files:**
- Create: `apps/web/app/vijesti/layout.tsx`

**Step 1: Create layout with metadata**

```tsx
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Vijesti',
  description:
    'Pratite sve novosti, obavijesti i događanja iz Općine Veliki Bukovec. Budite u tijeku s lokalnim aktualnostima.',
  openGraph: {
    title: 'Vijesti | Općina Veliki Bukovec',
    description:
      'Pratite sve novosti, obavijesti i događanja iz Općine Veliki Bukovec.',
  },
};

export default function NewsLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return children;
}
```

**Step 2: Run type-check**

Run: `pnpm type-check`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/app/vijesti/layout.tsx
git commit -m "feat(web): add metadata for news listing page"
```

---

## Task 7: Export POST_CATEGORY_OPTIONS from shared package

**Files:**
- Modify: `packages/shared/src/index.ts` (if not already exported)

**Step 1: Verify export exists**

Check if `POST_CATEGORY_OPTIONS` is exported from `packages/shared/src/index.ts`. If not, add:

```typescript
export { POST_CATEGORIES, POST_CATEGORY_OPTIONS, type PostCategory } from './constants/categories';
```

**Step 2: Run type-check**

Run: `pnpm type-check`
Expected: PASS

**Step 3: Commit (if changes made)**

```bash
git add packages/shared/src/index.ts
git commit -m "fix(shared): export POST_CATEGORY_OPTIONS"
```

---

## Task 8: Final verification and lint fixes

**Step 1: Run full type-check**

Run: `pnpm type-check`
Expected: PASS

**Step 2: Run lint with fix**

Run: `pnpm lint --fix`
Expected: PASS (or auto-fixed)

**Step 3: Run lint without fix to verify**

Run: `pnpm lint`
Expected: PASS

**Step 4: Test the page locally (manual)**

Run: `pnpm dev` in apps/web
Navigate to: `http://localhost:3000/vijesti`

Verify:
- [ ] Page loads with posts grid
- [ ] Category filter pills work
- [ ] URL updates when clicking categories
- [ ] Pagination works (if enough posts)
- [ ] Empty state shows when no posts
- [ ] Featured hero shows on page 1 without category filter

**Step 5: Commit any fixes**

```bash
git add -A
git commit -m "fix(web): resolve lint and type errors for news listing"
```

---

## Task 9: Update documentation

**Files:**
- Modify: `CHANGELOG.md`
- Modify: `ROADMAP.md`

**Step 1: Update CHANGELOG.md**

Add under `## Unreleased` or create new section:

```markdown
## Sprint 2.3 - News Listing (Completed)

### Added
- News listing page at `/vijesti`
- CategoryFilter component with URL state persistence
- Pagination component with ellipsis for many pages
- PostCardSkeleton for loading states
- findPublished repository method for public posts
- Category filtering via URL params (`?kategorija=...`)
- Page navigation via URL params (`?stranica=...`)
- Featured post hero on first page
- Empty state handling for no posts
- Gate: Browse news, filter by category, paginate
```

**Step 2: Update ROADMAP.md**

- Change `2.3 ⬜` to `2.3 ✅`
- Update Phase 2 progress from `2/12` to `3/12`
- Update Active Sprint to `2.4 - News Detail Page`
- Add recent update entry
- Add change log entry

**Step 3: Commit**

```bash
git add CHANGELOG.md ROADMAP.md
git commit -m "docs: update documentation for Sprint 2.3 completion"
```

---

## Summary

| Task | Component | Files |
|------|-----------|-------|
| 1 | Repository method | `packages/database/src/repositories/posts.ts` |
| 2 | CategoryFilter | `packages/ui/src/components/category-filter.tsx` |
| 3 | Pagination | `packages/ui/src/components/pagination.tsx` |
| 4 | PostCardSkeleton | `packages/ui/src/components/post-card-skeleton.tsx` |
| 5 | News page | `apps/web/app/vijesti/page.tsx` |
| 6 | News metadata | `apps/web/app/vijesti/layout.tsx` |
| 7 | Shared exports | `packages/shared/src/index.ts` |
| 8 | Verification | All files |
| 9 | Documentation | `CHANGELOG.md`, `ROADMAP.md` |

**Gate:** Can browse news at `/vijesti`, filter by category, and paginate through results.
