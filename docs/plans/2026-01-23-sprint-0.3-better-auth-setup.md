# Sprint 0.3: Better Auth Setup Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Set up Better Auth for the admin app with email/password authentication, Google OAuth, session management, and protected routes.

**Architecture:** Better Auth handles all authentication via `/api/auth/*` routes. The auth configuration lives in `apps/admin/lib/auth.ts` and uses the Prisma adapter with the existing database schema. Protected routes use middleware + a React context provider for client-side auth state.

**Tech Stack:** Better Auth 1.x, Next.js 16 App Router, Prisma adapter, React 19

---

## Prerequisites

Before starting, ensure you have:
1. PostgreSQL running with the schema from Sprint 0.2 pushed (`pnpm db:push`)
2. `.env.local` created from `.env.example` with valid `DATABASE_URL`
3. Generate a secret: `openssl rand -base64 32` for `BETTER_AUTH_SECRET`

---

## Task 1: Install Better Auth Dependencies

**Files:**
- Modify: `apps/admin/package.json`

**Step 1: Install Better Auth in admin app**

```bash
cd /mnt/c/VelikiBukovec_web
pnpm --filter @repo/admin add better-auth
```

**Step 2: Verify installation**

Run: `pnpm --filter @repo/admin list better-auth`
Expected: Shows better-auth version (1.x.x)

**Step 3: Commit**

```bash
git add apps/admin/package.json pnpm-lock.yaml
git commit -m "chore(admin): install better-auth"
```

---

## Task 2: Create Auth Configuration

**Files:**
- Create: `apps/admin/lib/auth.ts`

**Step 1: Create the auth configuration file**

Create `apps/admin/lib/auth.ts`:

```typescript
import { betterAuth } from 'better-auth';
import { prismaAdapter } from 'better-auth/adapters/prisma';
import { db } from '@repo/database';

export const auth = betterAuth({
  baseURL: process.env.BETTER_AUTH_URL,
  secret: process.env.BETTER_AUTH_SECRET,

  database: prismaAdapter(db, {
    provider: 'postgresql',
  }),

  emailAndPassword: {
    enabled: true,
    requireEmailVerification: false, // Disable for now, enable in production
  },

  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID || '',
      clientSecret: process.env.GOOGLE_CLIENT_SECRET || '',
      enabled: !!(process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET),
    },
  },

  session: {
    expiresIn: 60 * 60 * 24 * 7, // 7 days
    updateAge: 60 * 60 * 24, // Update session every 24 hours
    cookieCache: {
      enabled: true,
      maxAge: 60 * 5, // 5 minutes
    },
  },

  user: {
    additionalFields: {
      role: {
        type: 'string',
        required: false,
        defaultValue: 'staff',
        input: false, // Don't allow setting via signup
      },
    },
  },

  account: {
    accountLinking: {
      enabled: true,
      trustedProviders: ['google'],
    },
  },
});

export type Session = typeof auth.$Infer.Session;
export type User = typeof auth.$Infer.Session.user;
```

**Step 2: Commit**

```bash
git add apps/admin/lib/auth.ts
git commit -m "feat(admin): add Better Auth configuration"
```

---

## Task 3: Create Auth API Route Handler

**Files:**
- Create: `apps/admin/app/api/auth/[...all]/route.ts`

**Step 1: Create the API route directory**

```bash
mkdir -p /mnt/c/VelikiBukovec_web/apps/admin/app/api/auth/[...all]
```

**Step 2: Create the route handler**

Create `apps/admin/app/api/auth/[...all]/route.ts`:

```typescript
import { toNextJsHandler } from 'better-auth/next-js';
import { auth } from '@/lib/auth';

export const { GET, POST } = toNextJsHandler(auth);
```

**Step 3: Commit**

```bash
git add apps/admin/app/api/auth
git commit -m "feat(admin): add Better Auth API route handler"
```

---

## Task 4: Create Auth Client

**Files:**
- Create: `apps/admin/lib/auth-client.ts`

**Step 1: Create the client-side auth helper**

Create `apps/admin/lib/auth-client.ts`:

```typescript
import { createAuthClient } from 'better-auth/react';

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001',
});

export const {
  signIn,
  signUp,
  signOut,
  useSession,
  getSession,
} = authClient;
```

**Step 2: Commit**

```bash
git add apps/admin/lib/auth-client.ts
git commit -m "feat(admin): add Better Auth client"
```

---

## Task 5: Create Session Provider Component

**Files:**
- Create: `apps/admin/components/providers/session-provider.tsx`

**Step 1: Create providers directory**

```bash
mkdir -p /mnt/c/VelikiBukovec_web/apps/admin/components/providers
```

**Step 2: Create the session provider**

Create `apps/admin/components/providers/session-provider.tsx`:

```typescript
'use client';

import { createContext, useContext, type ReactNode } from 'react';
import { useSession } from '@/lib/auth-client';
import type { Session, User } from '@/lib/auth';

interface SessionContextValue {
  session: Session | null;
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
}

const SessionContext = createContext<SessionContextValue>({
  session: null,
  user: null,
  isLoading: true,
  isAuthenticated: false,
});

export function SessionProvider({ children }: { children: ReactNode }) {
  const { data: sessionData, isPending } = useSession();

  const value: SessionContextValue = {
    session: sessionData?.session ?? null,
    user: sessionData?.user ?? null,
    isLoading: isPending,
    isAuthenticated: !!sessionData?.session,
  };

  return (
    <SessionContext.Provider value={value}>
      {children}
    </SessionContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(SessionContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within a SessionProvider');
  }
  return context;
}
```

**Step 3: Commit**

```bash
git add apps/admin/components/providers
git commit -m "feat(admin): add session provider component"
```

---

## Task 6: Create Protected Route Wrapper

**Files:**
- Create: `apps/admin/components/auth/protected-route.tsx`

**Step 1: Create auth components directory**

```bash
mkdir -p /mnt/c/VelikiBukovec_web/apps/admin/components/auth
```

**Step 2: Create the protected route component**

Create `apps/admin/components/auth/protected-route.tsx`:

```typescript
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/components/providers/session-provider';

interface ProtectedRouteProps {
  children: React.ReactNode;
  requiredRole?: 'super_admin' | 'admin' | 'staff';
}

export function ProtectedRoute({ children, requiredRole }: ProtectedRouteProps) {
  const router = useRouter();
  const { isAuthenticated, isLoading, user } = useAuth();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/login');
    }
  }, [isAuthenticated, isLoading, router]);

  useEffect(() => {
    if (!isLoading && isAuthenticated && requiredRole && user) {
      const roleHierarchy = { super_admin: 3, admin: 2, staff: 1 };
      const userLevel = roleHierarchy[user.role as keyof typeof roleHierarchy] || 0;
      const requiredLevel = roleHierarchy[requiredRole] || 0;

      if (userLevel < requiredLevel) {
        router.push('/unauthorized');
      }
    }
  }, [isAuthenticated, isLoading, requiredRole, user, router]);

  if (isLoading) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>
        <p>Učitavanje...</p>
      </div>
    );
  }

  if (!isAuthenticated) {
    return null;
  }

  return <>{children}</>;
}
```

**Step 3: Commit**

```bash
git add apps/admin/components/auth
git commit -m "feat(admin): add protected route component"
```

---

## Task 7: Create Login Page

**Files:**
- Create: `apps/admin/app/login/page.tsx`

**Step 1: Create login directory**

```bash
mkdir -p /mnt/c/VelikiBukovec_web/apps/admin/app/login
```

**Step 2: Create the login page**

Create `apps/admin/app/login/page.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { signIn } from '@/lib/auth-client';
import { Button } from '@repo/ui';

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleEmailLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);

    try {
      const result = await signIn.email({
        email,
        password,
      });

      if (result.error) {
        setError(result.error.message || 'Prijava nije uspjela');
      } else {
        router.push('/');
      }
    } catch {
      setError('Došlo je do greške. Pokušajte ponovo.');
    } finally {
      setIsLoading(false);
    }
  };

  const handleGoogleLogin = async () => {
    setError('');
    setIsLoading(true);

    try {
      await signIn.social({
        provider: 'google',
        callbackURL: '/',
      });
    } catch {
      setError('Google prijava nije uspjela');
      setIsLoading(false);
    }
  };

  return (
    <main style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      minHeight: '100vh',
      padding: '2rem',
    }}>
      <div style={{
        width: '100%',
        maxWidth: '400px',
        padding: '2rem',
        border: '1px solid #e5e7eb',
        borderRadius: '8px',
      }}>
        <h1 style={{ marginBottom: '1.5rem', textAlign: 'center' }}>
          Prijava u administraciju
        </h1>

        {error && (
          <div style={{
            padding: '0.75rem',
            marginBottom: '1rem',
            backgroundColor: '#fee2e2',
            color: '#991b1b',
            borderRadius: '4px',
          }}>
            {error}
          </div>
        )}

        <form onSubmit={handleEmailLogin}>
          <div style={{ marginBottom: '1rem' }}>
            <label htmlFor="email" style={{ display: 'block', marginBottom: '0.25rem' }}>
              Email
            </label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              style={{
                width: '100%',
                padding: '0.5rem',
                border: '1px solid #d1d5db',
                borderRadius: '4px',
              }}
            />
          </div>

          <div style={{ marginBottom: '1.5rem' }}>
            <label htmlFor="password" style={{ display: 'block', marginBottom: '0.25rem' }}>
              Lozinka
            </label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              style={{
                width: '100%',
                padding: '0.5rem',
                border: '1px solid #d1d5db',
                borderRadius: '4px',
              }}
            />
          </div>

          <Button
            type="submit"
            variant="primary"
            disabled={isLoading}
            style={{ width: '100%', marginBottom: '1rem' }}
          >
            {isLoading ? 'Prijava...' : 'Prijavi se'}
          </Button>
        </form>

        <div style={{
          display: 'flex',
          alignItems: 'center',
          margin: '1rem 0',
          gap: '0.5rem',
        }}>
          <hr style={{ flex: 1 }} />
          <span style={{ color: '#6b7280', fontSize: '0.875rem' }}>ili</span>
          <hr style={{ flex: 1 }} />
        </div>

        <Button
          type="button"
          variant="secondary"
          onClick={handleGoogleLogin}
          disabled={isLoading}
          style={{ width: '100%' }}
        >
          Prijavi se s Google računom
        </Button>
      </div>
    </main>
  );
}
```

**Step 3: Commit**

```bash
git add apps/admin/app/login
git commit -m "feat(admin): add login page"
```

---

## Task 8: Update Root Layout with Session Provider

**Files:**
- Modify: `apps/admin/app/layout.tsx`

**Step 1: Update the root layout to include SessionProvider**

Replace `apps/admin/app/layout.tsx`:

```typescript
import type { Metadata } from 'next';
import type { ReactNode } from 'react';
import { SessionProvider } from '@/components/providers/session-provider';

import './globals.css';

export const metadata: Metadata = {
  title: 'Admin | Veliki Bukovec',
  description: 'Administratorsko sučelje za Općinu Veliki Bukovec',
};

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="hr">
      <body>
        <SessionProvider>
          {children}
        </SessionProvider>
      </body>
    </html>
  );
}
```

**Step 2: Commit**

```bash
git add apps/admin/app/layout.tsx
git commit -m "feat(admin): wrap app with session provider"
```

---

## Task 9: Update Home Page with Protected Route and Logout

**Files:**
- Modify: `apps/admin/app/page.tsx`

**Step 1: Update the home page with auth**

Replace `apps/admin/app/page.tsx`:

```typescript
'use client';

import { APP_NAME } from '@repo/shared';
import { Button } from '@repo/ui';
import { ProtectedRoute } from '@/components/auth/protected-route';
import { useAuth } from '@/components/providers/session-provider';
import { signOut } from '@/lib/auth-client';
import { useRouter } from 'next/navigation';

function DashboardContent() {
  const { user } = useAuth();
  const router = useRouter();

  const handleLogout = async () => {
    await signOut();
    router.push('/login');
  };

  return (
    <main style={{ padding: '2rem', maxWidth: '800px', margin: '0 auto' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
        <h1>{APP_NAME} - Admin</h1>
        <Button variant="secondary" onClick={handleLogout}>
          Odjava
        </Button>
      </div>

      <div style={{
        padding: '1.5rem',
        backgroundColor: '#f3f4f6',
        borderRadius: '8px',
        marginBottom: '1rem',
      }}>
        <h2 style={{ marginBottom: '0.5rem' }}>Dobrodošli!</h2>
        <p>Prijavljeni ste kao: <strong>{user?.email}</strong></p>
        <p>Uloga: <strong>{user?.role || 'staff'}</strong></p>
      </div>

      <p>Administratorske funkcije bit će dodane u sljedećim sprintovima.</p>
    </main>
  );
}

export default function AdminHomePage() {
  return (
    <ProtectedRoute>
      <DashboardContent />
    </ProtectedRoute>
  );
}
```

**Step 2: Commit**

```bash
git add apps/admin/app/page.tsx
git commit -m "feat(admin): add protected dashboard with logout"
```

---

## Task 10: Add Path Alias to tsconfig

**Files:**
- Modify: `apps/admin/tsconfig.json`

**Step 1: Add @ path alias**

Replace `apps/admin/tsconfig.json`:

```json
{
  "extends": "@repo/typescript-config/nextjs.json",
  "compilerOptions": {
    "plugins": [{ "name": "next" }],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", ".next/types/**/*.ts", "**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
```

**Step 2: Commit**

```bash
git add apps/admin/tsconfig.json
git commit -m "chore(admin): add @ path alias to tsconfig"
```

---

## Task 11: Update Environment Variables

**Files:**
- Modify: `.env.example`

**Step 1: Add NEXT_PUBLIC_APP_URL to .env.example**

Add after the existing auth section in `.env.example`:

```bash
# Auth (Better Auth - Sprint 0.3)
BETTER_AUTH_SECRET="generate-with-openssl-rand-base64-32"
BETTER_AUTH_URL="http://localhost:3001"
NEXT_PUBLIC_APP_URL="http://localhost:3001"
```

**Step 2: Commit**

```bash
git add .env.example
git commit -m "docs: add NEXT_PUBLIC_APP_URL to env example"
```

---

## Task 12: Create Component Exports Index

**Files:**
- Create: `apps/admin/components/auth/index.ts`
- Create: `apps/admin/components/providers/index.ts`

**Step 1: Create auth components index**

Create `apps/admin/components/auth/index.ts`:

```typescript
export { ProtectedRoute } from './protected-route';
```

**Step 2: Create providers index**

Create `apps/admin/components/providers/index.ts`:

```typescript
export { SessionProvider, useAuth } from './session-provider';
```

**Step 3: Commit**

```bash
git add apps/admin/components/auth/index.ts apps/admin/components/providers/index.ts
git commit -m "chore(admin): add component index exports"
```

---

## Task 13: Verify Type-Check and Lint

**Step 1: Run type-check**

```bash
cd /mnt/c/VelikiBukovec_web
pnpm type-check
```

Expected: All packages pass.

**Step 2: Run lint**

```bash
pnpm lint
```

Expected: All packages pass.

**Step 3: Fix any issues**

If there are ESLint errors, fix them before proceeding.

---

## Task 14: Test Authentication Flow

**Step 1: Ensure database is ready**

```bash
pnpm --filter @repo/database db:push
pnpm --filter @repo/database db:seed
```

**Step 2: Start the admin app**

```bash
pnpm --filter @repo/admin dev
```

**Step 3: Test login flow**

1. Open http://localhost:3001
2. Should redirect to /login
3. Try logging in with test credentials (you'll need to create a user with password)

**Step 4: Create a test user with password (if needed)**

You can use the Better Auth CLI or Prisma Studio to create a test user, or run this in a temporary script:

```typescript
// Create in packages/database/scripts/create-test-user.ts
import { db } from '../src/client';
import { hash } from 'better-auth/crypto';

async function createTestUser() {
  const hashedPassword = await hash('<TEST_PASSWORD>');

  await db.user.upsert({
    where: { email: 'test@velikibukovec.hr' },
    update: {},
    create: {
      email: 'test@velikibukovec.hr',
      name: 'Test User',
      role: 'admin',
      emailVerified: true,
      accounts: {
        create: {
          accountId: 'test@velikibukovec.hr',
          providerId: 'credential',
          password: hashedPassword,
        },
      },
    },
  });

  console.log('Test user created: test@example.com / <TEST_PASSWORD>');
}

createTestUser().then(() => process.exit(0));
```

---

## Task 15: Update Documentation

**Files:**
- Modify: `ROADMAP.md`
- Modify: `CHANGELOG.md`

**Step 1: Update ROADMAP.md**

Change Sprint 0.3 status to completed:
- `0.3 ✅` instead of `0.3 ⬜`
- Update "Active Sprint" to 0.4
- Update progress to 3/71

**Step 2: Update CHANGELOG.md**

Add to Unreleased or create Sprint 0.3 section:

```markdown
## Sprint 0.3 - Better Auth Setup (Completed)
- Better Auth installed and configured
- Email/password authentication
- Google OAuth configured (requires credentials)
- Session provider and protected routes
- Login page with Croatian labels
- Logout functionality
- Gate: Login with email/password, session persists on refresh
```

**Step 3: Commit**

```bash
git add ROADMAP.md CHANGELOG.md
git commit -m "docs: mark Sprint 0.3 as complete"
```

---

## Task 16: Final Commit and Push

**Step 1: Verify everything passes**

```bash
pnpm build
pnpm lint
pnpm type-check
```

**Step 2: Push**

```bash
git push
```

---

## Sprint 0.3 Gate Verification

**Checklist:**
- [ ] Better Auth installed in admin app
- [ ] `/api/auth/*` routes respond (test: `curl http://localhost:3001/api/auth/session`)
- [ ] Login page renders at `/login`
- [ ] Email/password login works
- [ ] Google OAuth configured (button shows, works if credentials provided)
- [ ] Session persists on page refresh
- [ ] Protected routes redirect to login when not authenticated
- [ ] Logout clears session
- [ ] `pnpm type-check` passes
- [ ] `pnpm lint` passes
- [ ] `pnpm build` passes

**Gate Test:**
1. Start app: `pnpm --filter @repo/admin dev`
2. Go to http://localhost:3001 - should redirect to /login
3. Login with email/password
4. See dashboard with user info
5. Refresh page - still logged in
6. Click logout - redirected to login

---

## Summary

| Task | Files | Purpose |
|------|-------|---------|
| 1 | package.json | Install Better Auth |
| 2 | lib/auth.ts | Auth configuration |
| 3 | api/auth/[...all]/route.ts | API route handler |
| 4 | lib/auth-client.ts | Client-side auth |
| 5 | components/providers/session-provider.tsx | Session context |
| 6 | components/auth/protected-route.tsx | Route protection |
| 7 | app/login/page.tsx | Login page |
| 8 | app/layout.tsx | Add SessionProvider |
| 9 | app/page.tsx | Protected dashboard |
| 10 | tsconfig.json | Path alias |
| 11 | .env.example | Environment docs |
| 12 | components/*/index.ts | Export indexes |
| 13 | - | Verify type-check/lint |
| 14 | - | Test auth flow |
| 15 | ROADMAP, CHANGELOG | Documentation |
| 16 | - | Final push |

**Total commits:** ~14
**New files:** ~10
**Modified files:** ~5
