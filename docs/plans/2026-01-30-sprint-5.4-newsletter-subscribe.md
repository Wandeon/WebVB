# Sprint 5.4: Newsletter Subscribe Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement double opt-in newsletter subscription with confirmation emails.

**Architecture:** Public API endpoints handle subscribe/confirm/unsubscribe flows. Repository pattern for database operations. Fire-and-forget emails using existing Nodemailer infrastructure. Confirmation pages in public web app.

**Tech Stack:** Next.js API routes, Prisma, Zod validation, Nodemailer, crypto.randomUUID

---

## Task 1: Newsletter Repository

**Files:**
- Create: `packages/database/src/repositories/newsletter.ts`
- Modify: `packages/database/src/repositories/index.ts`

**Implementation:**

```typescript
// packages/database/src/repositories/newsletter.ts
import { db } from '../client';

export interface NewsletterSubscriberRecord {
  id: string;
  email: string;
  confirmed: boolean;
  confirmationToken: string | null;
  confirmedAt: Date | null;
  unsubscribedAt: Date | null;
  createdAt: Date;
}

export interface CreateSubscriberData {
  email: string;
  confirmationToken: string;
}

export interface FindAllSubscribersOptions {
  confirmed?: boolean;
  page?: number | undefined;
  limit?: number | undefined;
}

export interface FindAllSubscribersResult {
  subscribers: NewsletterSubscriberRecord[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}

export const newsletterRepository = {
  /**
   * Create a new unconfirmed subscriber
   */
  async create(data: CreateSubscriberData): Promise<NewsletterSubscriberRecord> {
    return await db.newsletterSubscriber.create({
      data: {
        email: data.email,
        confirmationToken: data.confirmationToken,
        confirmed: false,
      },
    });
  },

  /**
   * Find subscriber by email
   */
  async findByEmail(email: string): Promise<NewsletterSubscriberRecord | null> {
    return await db.newsletterSubscriber.findUnique({
      where: { email },
    });
  },

  /**
   * Find subscriber by confirmation token
   */
  async findByToken(token: string): Promise<NewsletterSubscriberRecord | null> {
    return await db.newsletterSubscriber.findFirst({
      where: { confirmationToken: token },
    });
  },

  /**
   * Confirm a subscriber - sets confirmed=true, confirmedAt, clears token
   */
  async confirm(id: string): Promise<NewsletterSubscriberRecord> {
    return await db.newsletterSubscriber.update({
      where: { id },
      data: {
        confirmed: true,
        confirmedAt: new Date(),
        confirmationToken: null,
      },
    });
  },

  /**
   * Unsubscribe - sets unsubscribedAt
   */
  async unsubscribe(id: string): Promise<NewsletterSubscriberRecord> {
    return await db.newsletterSubscriber.update({
      where: { id },
      data: {
        unsubscribedAt: new Date(),
        confirmed: false,
      },
    });
  },

  /**
   * Update confirmation token (for resend)
   */
  async updateToken(id: string, token: string): Promise<NewsletterSubscriberRecord> {
    return await db.newsletterSubscriber.update({
      where: { id },
      data: {
        confirmationToken: token,
      },
    });
  },

  /**
   * Find all confirmed subscribers (for sending newsletters)
   */
  async findAllConfirmed(
    options: FindAllSubscribersOptions = {}
  ): Promise<FindAllSubscribersResult> {
    const { page = 1, limit = 100 } = options;

    const where = {
      confirmed: true,
      unsubscribedAt: null,
    };

    const [total, subscribers] = await Promise.all([
      db.newsletterSubscriber.count({ where }),
      db.newsletterSubscriber.findMany({
        where,
        orderBy: { createdAt: 'desc' },
        skip: (page - 1) * limit,
        take: limit,
      }),
    ]);

    return {
      subscribers,
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit),
      },
    };
  },

  /**
   * Count subscribers with optional filtering
   */
  async count(options: { confirmed?: boolean } = {}): Promise<number> {
    const where: { confirmed?: boolean; unsubscribedAt?: null } = {};

    if (options.confirmed !== undefined) {
      where.confirmed = options.confirmed;
      if (options.confirmed) {
        where.unsubscribedAt = null;
      }
    }

    return db.newsletterSubscriber.count({ where });
  },
};
```

**Add to exports:**

```typescript
// packages/database/src/repositories/index.ts - add at end
export {
  newsletterRepository,
  type NewsletterSubscriberRecord,
  type CreateSubscriberData,
  type FindAllSubscribersOptions,
  type FindAllSubscribersResult,
} from './newsletter';
```

**Verify:** `pnpm type-check`

---

## Task 2: Validation Schema

**Files:**
- Modify: `packages/shared/src/validations/contact.ts`
- Modify: `packages/shared/src/index.ts`

**Implementation:**

Add to end of `packages/shared/src/validations/contact.ts`:

```typescript
export const newsletterSubscribeSchema = z.object({
  email: z.string().email('Unesite ispravnu email adresu'),
  honeypot: z.string().max(0).optional(),
});

export type NewsletterSubscribeData = z.infer<typeof newsletterSubscribeSchema>;
```

Add to `packages/shared/src/index.ts` exports (in the contact exports block):

```typescript
export {
  contactFormSchema,
  problemReportSchema,
  newsletterSubscribeSchema,
  PROBLEM_TYPES,
  problemTypeValues,
  type ContactFormData,
  type ProblemReportData,
  type NewsletterSubscribeData,
} from './validations/contact';
```

**Verify:** `pnpm type-check`

---

## Task 3: Newsletter Email Templates

**Files:**
- Create: `apps/admin/lib/email/templates/newsletter-confirmation.ts`

**Implementation:**

```typescript
// apps/admin/lib/email/templates/newsletter-confirmation.ts
/**
 * Newsletter confirmation email template
 * Sent to users after they subscribe to verify their email
 */

interface NewsletterConfirmationData {
  confirmUrl: string;
}

interface EmailTemplate {
  subject: string;
  html: string;
  text: string;
}

/**
 * Generates a confirmation email for newsletter subscription
 * All text is in Croatian language
 */
export function newsletterConfirmationTemplate(
  data: NewsletterConfirmationData
): EmailTemplate {
  const { confirmUrl } = data;

  const subject = 'Potvrdite pretplatu na newsletter - Općina Veliki Bukovec';

  const html = `
<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${subject}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #1f2937;
      background-color: #f3f4f6;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    .email-wrapper {
      background-color: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .header {
      background-color: #16a34a;
      color: #ffffff;
      padding: 32px 24px;
      text-align: center;
    }
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    .content {
      padding: 32px 24px;
    }
    .greeting {
      font-size: 18px;
      font-weight: 600;
      color: #16a34a;
      margin-bottom: 16px;
    }
    .message-text {
      color: #4b5563;
      margin-bottom: 24px;
    }
    .button-wrapper {
      text-align: center;
      margin: 32px 0;
    }
    .button {
      display: inline-block;
      background-color: #16a34a;
      color: #ffffff !important;
      text-decoration: none;
      padding: 14px 32px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 16px;
    }
    .link-fallback {
      margin-top: 24px;
      padding: 16px;
      background-color: #f8fafc;
      border-radius: 6px;
      font-size: 14px;
      color: #64748b;
    }
    .link-fallback a {
      color: #16a34a;
      word-break: break-all;
    }
    .footer {
      background-color: #f8fafc;
      padding: 24px;
      text-align: center;
      border-top: 1px solid #e2e8f0;
    }
    .footer-text {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 8px;
    }
    .footer-note {
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="email-wrapper">
      <div class="header">
        <h1>Općina Veliki Bukovec</h1>
        <p>Potvrda pretplate na newsletter</p>
      </div>

      <div class="content">
        <p class="greeting">Poštovani,</p>

        <p class="message-text">
          Zaprimili smo vašu prijavu za newsletter Općine Veliki Bukovec.
          Da bismo potvrdili vašu email adresu, molimo kliknite na gumb ispod.
        </p>

        <div class="button-wrapper">
          <a href="${escapeHtml(confirmUrl)}" class="button">Potvrdi pretplatu</a>
        </div>

        <p class="message-text">
          Nakon potvrde, primat ćete redovite obavijesti o vijestima,
          događanjima i važnim dokumentima iz naše općine.
        </p>

        <div class="link-fallback">
          Ako gumb ne radi, kopirajte i zalijepite ovaj link u preglednik:<br>
          <a href="${escapeHtml(confirmUrl)}">${escapeHtml(confirmUrl)}</a>
        </div>
      </div>

      <div class="footer">
        <p class="footer-text">
          Srdačan pozdrav,<br>
          Općina Veliki Bukovec
        </p>
        <p class="footer-note">
          Ako niste zatražili ovu pretplatu, slobodno ignorirajte ovaj email.
        </p>
      </div>
    </div>
  </div>
</body>
</html>
  `.trim();

  const text = `
Općina Veliki Bukovec
Potvrda pretplate na newsletter

Poštovani,

Zaprimili smo vašu prijavu za newsletter Općine Veliki Bukovec.
Da bismo potvrdili vašu email adresu, molimo posjetite sljedeći link:

${confirmUrl}

Nakon potvrde, primat ćete redovite obavijesti o vijestima,
događanjima i važnim dokumentima iz naše općine.

Srdačan pozdrav,
Općina Veliki Bukovec

---
Ako niste zatražili ovu pretplatu, slobodno ignorirajte ovaj email.
  `.trim();

  return { subject, html, text };
}

/**
 * Escapes HTML special characters to prevent XSS attacks
 */
function escapeHtml(text: string): string {
  const htmlEscapes: Record<string, string> = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
  };

  return text.replace(/[&<>"']/g, (char) => htmlEscapes[char] || char);
}
```

**Verify:** `pnpm type-check`

---

## Task 4: Newsletter Email Service

**Files:**
- Modify: `apps/admin/lib/email/service.ts`
- Modify: `apps/admin/lib/email/index.ts`

**Implementation:**

Add to `apps/admin/lib/email/service.ts` after the problem report section:

```typescript
// =============================================================================
// Newsletter Emails
// =============================================================================

import { newsletterConfirmationTemplate } from './templates/newsletter-confirmation';

/**
 * Send confirmation email for newsletter subscription
 * Fire-and-forget: errors are logged but don't throw
 */
export function sendNewsletterConfirmation(email: string, confirmUrl: string): void {
  if (!isEmailConfigured()) {
    contactLogger.warn('Email not configured, skipping newsletter confirmation');
    return;
  }

  const transporter = getEmailTransporter();
  const from = getSmtpFrom();

  if (!transporter || !from) {
    contactLogger.warn('Email transporter not available, skipping newsletter confirmation');
    return;
  }

  const template = newsletterConfirmationTemplate({ confirmUrl });

  transporter
    .sendMail({
      from,
      to: email,
      subject: template.subject,
      text: template.text,
      html: template.html,
    })
    .then(() => {
      contactLogger.info({ to: email }, 'Newsletter confirmation email sent');
    })
    .catch((error: unknown) => {
      contactLogger.error({ error, to: email }, 'Failed to send newsletter confirmation email');
    });
}
```

Add to `apps/admin/lib/email/index.ts`:

```typescript
// Email service - Newsletter
export { sendNewsletterConfirmation } from './service';

// Templates
export { newsletterConfirmationTemplate } from './templates/newsletter-confirmation';
```

**Verify:** `pnpm type-check`

---

## Task 5: Subscribe API Endpoint

**Files:**
- Create: `apps/admin/app/api/public/newsletter/subscribe/route.ts`

**Implementation:**

```typescript
// apps/admin/app/api/public/newsletter/subscribe/route.ts
import { newsletterRepository } from '@repo/database';
import { newsletterSubscribeSchema } from '@repo/shared';
import { randomUUID } from 'crypto';
import { NextResponse } from 'next/server';

import { corsResponse, getCorsHeaders } from '@/lib/cors';
import { sendNewsletterConfirmation } from '@/lib/email';
import { contactLogger } from '@/lib/logger';
import { checkRateLimit, getClientIp } from '@/lib/rate-limit';

const RATE_LIMIT = 5;
const RATE_WINDOW = 60 * 60 * 1000; // 1 hour
const PUBLIC_SITE_URL = process.env.PUBLIC_SITE_URL || 'https://velikibukovec.hr';

export function OPTIONS(request: Request) {
  return corsResponse(request);
}

export async function POST(request: Request) {
  const corsHeaders = getCorsHeaders(request);

  try {
    const ip = getClientIp(request);

    const rateCheck = checkRateLimit(ip, RATE_LIMIT, RATE_WINDOW);
    if (!rateCheck.allowed) {
      return NextResponse.json(
        { success: false, error: { code: 'RATE_LIMIT', message: 'Previše zahtjeva. Pokušajte ponovno za sat vremena.' } },
        { status: 429, headers: { ...corsHeaders, 'Retry-After': String(Math.ceil((rateCheck.resetAt - Date.now()) / 1000)) } }
      );
    }

    const body: unknown = await request.json();
    const result = newsletterSubscribeSchema.safeParse(body);

    if (!result.success) {
      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'VALIDATION_ERROR',
            message: 'Neispravna email adresa',
            details: result.error.flatten().fieldErrors,
          },
        },
        { status: 400, headers: corsHeaders }
      );
    }

    if (result.data.honeypot) {
      return NextResponse.json({ success: true }, { headers: corsHeaders }); // Silent rejection for bots
    }

    const email = result.data.email.toLowerCase().trim();

    // Check if already subscribed
    const existing = await newsletterRepository.findByEmail(email);

    if (existing) {
      if (existing.confirmed && !existing.unsubscribedAt) {
        // Already confirmed and active
        return NextResponse.json(
          {
            success: false,
            error: {
              code: 'ALREADY_SUBSCRIBED',
              message: 'Ova email adresa je već pretplaćena na newsletter.',
            },
          },
          { status: 400, headers: corsHeaders }
        );
      }

      if (existing.unsubscribedAt) {
        // Was unsubscribed, resubscribe with new token
        const token = randomUUID();
        await newsletterRepository.updateToken(existing.id, token);

        const confirmUrl = `${PUBLIC_SITE_URL}/newsletter/potvrda?token=${token}`;
        sendNewsletterConfirmation(email, confirmUrl);

        contactLogger.info({ email }, 'Newsletter resubscription initiated');

        return NextResponse.json(
          {
            success: true,
            data: {
              message: 'Hvala na prijavi! Provjerite svoj email za potvrdu pretplate.',
            },
          },
          { headers: corsHeaders }
        );
      }

      // Exists but not confirmed - resend confirmation
      const token = randomUUID();
      await newsletterRepository.updateToken(existing.id, token);

      const confirmUrl = `${PUBLIC_SITE_URL}/newsletter/potvrda?token=${token}`;
      sendNewsletterConfirmation(email, confirmUrl);

      contactLogger.info({ email }, 'Newsletter confirmation resent');

      return NextResponse.json(
        {
          success: true,
          data: {
            message: 'Hvala na prijavi! Provjerite svoj email za potvrdu pretplate.',
          },
        },
        { headers: corsHeaders }
      );
    }

    // New subscriber
    const token = randomUUID();
    await newsletterRepository.create({ email, confirmationToken: token });

    const confirmUrl = `${PUBLIC_SITE_URL}/newsletter/potvrda?token=${token}`;
    sendNewsletterConfirmation(email, confirmUrl);

    contactLogger.info({ email }, 'New newsletter subscription initiated');

    return NextResponse.json(
      {
        success: true,
        data: {
          message: 'Hvala na prijavi! Provjerite svoj email za potvrdu pretplate.',
        },
      },
      { headers: corsHeaders }
    );
  } catch (error) {
    contactLogger.error({ error }, 'Newsletter subscription error');
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Došlo je do greške. Pokušajte ponovno.' } },
      { status: 500, headers: corsHeaders }
    );
  }
}
```

**Verify:** `pnpm type-check`

---

## Task 6: Confirm API Endpoint

**Files:**
- Create: `apps/admin/app/api/public/newsletter/confirm/route.ts`

**Implementation:**

```typescript
// apps/admin/app/api/public/newsletter/confirm/route.ts
import { newsletterRepository } from '@repo/database';
import { NextResponse } from 'next/server';

import { corsResponse, getCorsHeaders } from '@/lib/cors';
import { contactLogger } from '@/lib/logger';

import type { NextRequest } from 'next/server';

export function OPTIONS(request: Request) {
  return corsResponse(request);
}

export async function GET(request: NextRequest) {
  const corsHeaders = getCorsHeaders(request);

  try {
    const { searchParams } = new URL(request.url);
    const token = searchParams.get('token');

    if (!token) {
      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'MISSING_TOKEN',
            message: 'Token za potvrdu nije naveden.',
          },
        },
        { status: 400, headers: corsHeaders }
      );
    }

    const subscriber = await newsletterRepository.findByToken(token);

    if (!subscriber) {
      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'INVALID_TOKEN',
            message: 'Nevažeći ili istekli token za potvrdu.',
          },
        },
        { status: 400, headers: corsHeaders }
      );
    }

    if (subscriber.confirmed) {
      return NextResponse.json(
        {
          success: true,
          data: {
            message: 'Vaša pretplata je već potvrđena.',
            alreadyConfirmed: true,
          },
        },
        { headers: corsHeaders }
      );
    }

    await newsletterRepository.confirm(subscriber.id);

    contactLogger.info({ email: subscriber.email }, 'Newsletter subscription confirmed');

    return NextResponse.json(
      {
        success: true,
        data: {
          message: 'Vaša pretplata je uspješno potvrđena! Hvala vam.',
        },
      },
      { headers: corsHeaders }
    );
  } catch (error) {
    contactLogger.error({ error }, 'Newsletter confirmation error');
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Došlo je do greške. Pokušajte ponovno.' } },
      { status: 500, headers: corsHeaders }
    );
  }
}
```

**Verify:** `pnpm type-check`

---

## Task 7: Unsubscribe API Endpoint

**Files:**
- Create: `apps/admin/app/api/public/newsletter/unsubscribe/route.ts`

**Implementation:**

```typescript
// apps/admin/app/api/public/newsletter/unsubscribe/route.ts
import { newsletterRepository } from '@repo/database';
import { NextResponse } from 'next/server';

import { corsResponse, getCorsHeaders } from '@/lib/cors';
import { contactLogger } from '@/lib/logger';

import type { NextRequest } from 'next/server';

export function OPTIONS(request: Request) {
  return corsResponse(request);
}

export async function GET(request: NextRequest) {
  const corsHeaders = getCorsHeaders(request);

  try {
    const { searchParams } = new URL(request.url);
    const id = searchParams.get('id');

    if (!id) {
      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'MISSING_ID',
            message: 'ID pretplatnika nije naveden.',
          },
        },
        { status: 400, headers: corsHeaders }
      );
    }

    // Find subscriber by ID
    const subscriber = await newsletterRepository.findByEmail(''); // We need findById

    // Actually, let's use a different approach - find by token or use email hash
    // For simplicity, we'll expect the subscriber ID directly

    try {
      const result = await newsletterRepository.unsubscribe(id);

      contactLogger.info({ email: result.email }, 'Newsletter unsubscribed');

      return NextResponse.json(
        {
          success: true,
          data: {
            message: 'Uspješno ste se odjavili s newslettera.',
          },
        },
        { headers: corsHeaders }
      );
    } catch {
      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'NOT_FOUND',
            message: 'Pretplatnik nije pronađen.',
          },
        },
        { status: 404, headers: corsHeaders }
      );
    }
  } catch (error) {
    contactLogger.error({ error }, 'Newsletter unsubscribe error');
    return NextResponse.json(
      { success: false, error: { code: 'SERVER_ERROR', message: 'Došlo je do greške. Pokušajte ponovno.' } },
      { status: 500, headers: corsHeaders }
    );
  }
}
```

**Verify:** `pnpm type-check`

---

## Task 8: Public Confirmation Page

**Files:**
- Create: `apps/web/app/newsletter/potvrda/page.tsx`

**Implementation:**

```typescript
// apps/web/app/newsletter/potvrda/page.tsx
import { Metadata } from 'next';

import { ConfirmationClient } from './confirmation-client';

export const metadata: Metadata = {
  title: 'Potvrda pretplate - Newsletter | Općina Veliki Bukovec',
  description: 'Potvrdite svoju pretplatu na newsletter Općine Veliki Bukovec.',
};

export default function NewsletterConfirmationPage() {
  return <ConfirmationClient />;
}
```

```typescript
// apps/web/app/newsletter/potvrda/confirmation-client.tsx
'use client';

import { CheckCircle, Loader2, XCircle } from 'lucide-react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import { useEffect, useState } from 'react';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

interface ConfirmResponse {
  success: boolean;
  data?: {
    message: string;
    alreadyConfirmed?: boolean;
  };
  error?: {
    code: string;
    message: string;
  };
}

export function ConfirmationClient() {
  const searchParams = useSearchParams();
  const token = searchParams.get('token');

  const [status, setStatus] = useState<'loading' | 'success' | 'error'>('loading');
  const [message, setMessage] = useState('');

  useEffect(() => {
    if (!token) {
      setStatus('error');
      setMessage('Nevažeći link za potvrdu.');
      return;
    }

    const confirmSubscription = async () => {
      try {
        const response = await fetch(
          `${API_URL}/api/public/newsletter/confirm?token=${encodeURIComponent(token)}`
        );
        const data = (await response.json()) as ConfirmResponse;

        if (data.success && data.data) {
          setStatus('success');
          setMessage(data.data.message);
        } else if (data.error) {
          setStatus('error');
          setMessage(data.error.message);
        }
      } catch {
        setStatus('error');
        setMessage('Došlo je do greške. Pokušajte ponovno.');
      }
    };

    void confirmSubscription();
  }, [token]);

  return (
    <main className="flex min-h-[60vh] items-center justify-center px-4 py-16">
      <div className="mx-auto max-w-md text-center">
        {status === 'loading' && (
          <>
            <Loader2 className="mx-auto h-16 w-16 animate-spin text-primary-600" />
            <h1 className="mt-6 font-display text-2xl font-bold text-neutral-900">
              Potvrđujem pretplatu...
            </h1>
            <p className="mt-2 text-neutral-600">
              Molimo pričekajte.
            </p>
          </>
        )}

        {status === 'success' && (
          <>
            <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
              <CheckCircle className="h-10 w-10 text-green-600" />
            </div>
            <h1 className="mt-6 font-display text-2xl font-bold text-neutral-900">
              Pretplata potvrđena!
            </h1>
            <p className="mt-2 text-neutral-600">
              {message}
            </p>
            <Link
              href="/"
              className="mt-6 inline-block rounded-lg bg-primary-600 px-6 py-3 font-medium text-white hover:bg-primary-700"
            >
              Povratak na naslovnicu
            </Link>
          </>
        )}

        {status === 'error' && (
          <>
            <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
              <XCircle className="h-10 w-10 text-red-600" />
            </div>
            <h1 className="mt-6 font-display text-2xl font-bold text-neutral-900">
              Greška pri potvrdi
            </h1>
            <p className="mt-2 text-neutral-600">
              {message}
            </p>
            <Link
              href="/"
              className="mt-6 inline-block rounded-lg bg-primary-600 px-6 py-3 font-medium text-white hover:bg-primary-700"
            >
              Povratak na naslovnicu
            </Link>
          </>
        )}
      </div>
    </main>
  );
}
```

**Verify:** `pnpm type-check`

---

## Task 9: Public Unsubscribe Page

**Files:**
- Create: `apps/web/app/newsletter/odjava/page.tsx`

**Implementation:**

```typescript
// apps/web/app/newsletter/odjava/page.tsx
import { Metadata } from 'next';

import { UnsubscribeClient } from './unsubscribe-client';

export const metadata: Metadata = {
  title: 'Odjava s newslettera | Općina Veliki Bukovec',
  description: 'Odjavite se s newslettera Općine Veliki Bukovec.',
};

export default function NewsletterUnsubscribePage() {
  return <UnsubscribeClient />;
}
```

```typescript
// apps/web/app/newsletter/odjava/unsubscribe-client.tsx
'use client';

import { CheckCircle, Loader2, XCircle } from 'lucide-react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import { useEffect, useState } from 'react';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

interface UnsubscribeResponse {
  success: boolean;
  data?: {
    message: string;
  };
  error?: {
    code: string;
    message: string;
  };
}

export function UnsubscribeClient() {
  const searchParams = useSearchParams();
  const id = searchParams.get('id');

  const [status, setStatus] = useState<'loading' | 'success' | 'error'>('loading');
  const [message, setMessage] = useState('');

  useEffect(() => {
    if (!id) {
      setStatus('error');
      setMessage('Nevažeći link za odjavu.');
      return;
    }

    const unsubscribe = async () => {
      try {
        const response = await fetch(
          `${API_URL}/api/public/newsletter/unsubscribe?id=${encodeURIComponent(id)}`
        );
        const data = (await response.json()) as UnsubscribeResponse;

        if (data.success && data.data) {
          setStatus('success');
          setMessage(data.data.message);
        } else if (data.error) {
          setStatus('error');
          setMessage(data.error.message);
        }
      } catch {
        setStatus('error');
        setMessage('Došlo je do greške. Pokušajte ponovno.');
      }
    };

    void unsubscribe();
  }, [id]);

  return (
    <main className="flex min-h-[60vh] items-center justify-center px-4 py-16">
      <div className="mx-auto max-w-md text-center">
        {status === 'loading' && (
          <>
            <Loader2 className="mx-auto h-16 w-16 animate-spin text-primary-600" />
            <h1 className="mt-6 font-display text-2xl font-bold text-neutral-900">
              Odjavljujem...
            </h1>
            <p className="mt-2 text-neutral-600">
              Molimo pričekajte.
            </p>
          </>
        )}

        {status === 'success' && (
          <>
            <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
              <CheckCircle className="h-10 w-10 text-green-600" />
            </div>
            <h1 className="mt-6 font-display text-2xl font-bold text-neutral-900">
              Odjava uspješna
            </h1>
            <p className="mt-2 text-neutral-600">
              {message}
            </p>
            <p className="mt-4 text-sm text-neutral-500">
              Žao nam je što odlazite. Uvijek se možete ponovo pretplatiti.
            </p>
            <Link
              href="/"
              className="mt-6 inline-block rounded-lg bg-primary-600 px-6 py-3 font-medium text-white hover:bg-primary-700"
            >
              Povratak na naslovnicu
            </Link>
          </>
        )}

        {status === 'error' && (
          <>
            <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
              <XCircle className="h-10 w-10 text-red-600" />
            </div>
            <h1 className="mt-6 font-display text-2xl font-bold text-neutral-900">
              Greška pri odjavi
            </h1>
            <p className="mt-2 text-neutral-600">
              {message}
            </p>
            <Link
              href="/"
              className="mt-6 inline-block rounded-lg bg-primary-600 px-6 py-3 font-medium text-white hover:bg-primary-700"
            >
              Povratak na naslovnicu
            </Link>
          </>
        )}
      </div>
    </main>
  );
}
```

**Verify:** `pnpm type-check`

---

## Task 10: Wire Homepage Newsletter Component

**Files:**
- Modify: `apps/web/app/page.tsx` or homepage component using NewsletterSection

**Implementation:**

Find where `NewsletterSection` is used and add the onSubmit handler. First, check current usage:

```bash
grep -r "NewsletterSection" apps/web/
```

Then wire it with:

```typescript
// In the homepage or component using NewsletterSection
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

async function handleNewsletterSubmit(email: string): Promise<void> {
  const response = await fetch(`${API_URL}/api/public/newsletter/subscribe`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email }),
  });

  const data = await response.json();

  if (!response.ok || !data.success) {
    throw new Error(data.error?.message || 'Subscription failed');
  }
}

// Use in component:
<NewsletterSection onSubmit={handleNewsletterSubmit} />
```

**Verify:** `pnpm type-check && pnpm build`

---

## Task 11: Final Verification

**Run all checks:**

```bash
pnpm type-check
pnpm lint
pnpm build
```

**Manual test flow:**
1. Go to homepage, enter email in newsletter form
2. Check database for new subscriber with `confirmed: false`
3. Check email inbox for confirmation link
4. Click confirmation link
5. Verify subscriber is now `confirmed: true`
6. Try subscribing again - should get "already subscribed" error

---

## Summary

| Task | Description |
|------|-------------|
| 1 | Newsletter repository with CRUD operations |
| 2 | Validation schema for subscription |
| 3 | Email template for confirmation |
| 4 | Email service function |
| 5 | Subscribe API endpoint |
| 6 | Confirm API endpoint |
| 7 | Unsubscribe API endpoint |
| 8 | Public confirmation page |
| 9 | Public unsubscribe page |
| 10 | Wire homepage newsletter component |
| 11 | Final verification |
