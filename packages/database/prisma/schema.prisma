// Prisma Schema for Veliki Bukovec
// See docs/DATABASE.md for full documentation

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector, pg_trgm]
}

// ============================================================================
// BETTER AUTH TABLES (Standard Schema)
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Custom extension field
  role          String    @default("staff") // 'super_admin', 'admin', 'staff'

  // Relations
  sessions      Session[]
  accounts      Account[]
  passkeys      Passkey[]
  twoFactor     TwoFactor?

  // Content relations
  posts         Post[]
  documents     Document[]

  // Communication relations
  contactReplies ContactMessage[] @relation("RepliedBy")
  problemResolutions ProblemReport[] @relation("ResolvedBy")

  @@index([email])
  @@index([role])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String    // 'google', 'credential'
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?   // For credential provider (hashed)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String   // email or other identifier
  value      String   // token value
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ============================================================================
// BETTER AUTH PLUGIN TABLES
// ============================================================================

model Passkey {
  id           String   @id @default(cuid())
  userId       String
  name         String?  // User-friendly name "MacBook Touch ID"
  publicKey    String
  credentialID String   @unique
  counter      Int      @default(0)
  deviceType   String?  // 'platform' or 'cross-platform'
  backedUp     Boolean  @default(false)
  transports   String?  // JSON array of transports
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialID])
  @@map("passkey")
}

model TwoFactor {
  id          String   @id @default(cuid())
  userId      String   @unique
  secret      String   // Encrypted TOTP secret
  backupCodes String?  // Encrypted backup codes (JSON)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor")
}

// ============================================================================
// CONTENT TABLES
// ============================================================================

model Post {
  id             String    @id @default(uuid())
  title          String
  slug           String    @unique
  content        String    // Rich text (TipTap JSON)
  excerpt        String?   // Short summary
  featuredImage  String?   @map("featured_image") // R2 URL
  images         Json?     // Additional images [{url, caption}]
  category       String    @default("aktualnosti")
  isFeatured     Boolean   @default(false) @map("is_featured")
  facebookPostId String?   @map("facebook_post_id")
  authorId       String?   @map("author_id")
  publishedAt    DateTime? @map("published_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  author User? @relation(fields: [authorId], references: [id])

  @@index([publishedAt(sort: Desc)])
  @@index([category])
  @@index([isFeatured])
  @@index([authorId])
  @@map("posts")
}

model Document {
  id          String   @id @default(uuid())
  title       String
  fileUrl     String   @map("file_url") // R2 URL
  fileSize    Int?     @map("file_size")
  category    String   // 'sjednice', 'izbori', 'planovi', etc.
  subcategory String?
  year        Int?
  uploadedBy  String?  @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")

  uploader User? @relation(fields: [uploadedBy], references: [id])

  @@index([category, year(sort: Desc)])
  @@map("documents")
}

model Event {
  id          String    @id @default(uuid())
  title       String
  description String?
  eventDate   DateTime  @map("event_date") @db.Date
  eventTime   DateTime? @map("event_time") @db.Time()
  endDate     DateTime? @map("end_date") @db.Date
  location    String?
  posterImage String?   @map("poster_image") // R2 URL
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([eventDate])
  @@map("events")
}

model Page {
  id        String   @id @default(uuid())
  title     String
  slug      String   @unique
  content   String
  parentId  String?  @map("parent_id")
  menuOrder Int      @default(0) @map("menu_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent   Page?  @relation("PageHierarchy", fields: [parentId], references: [id])
  children Page[] @relation("PageHierarchy")

  @@index([parentId])
  @@map("pages")
}

model Gallery {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  eventDate   DateTime? @map("event_date") @db.Date
  description String?
  coverImage  String?   @map("cover_image") // R2 URL
  createdAt   DateTime  @default(now()) @map("created_at")

  images GalleryImage[]

  @@index([eventDate(sort: Desc)])
  @@map("galleries")
}

model GalleryImage {
  id           String   @id @default(uuid())
  galleryId    String   @map("gallery_id")
  imageUrl     String   @map("image_url") // R2 URL (large)
  thumbnailUrl String?  @map("thumbnail_url") // R2 URL (thumbnail)
  caption      String?
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@index([galleryId, sortOrder])
  @@map("gallery_images")
}

// ============================================================================
// COMMUNICATION TABLES
// ============================================================================

model ContactMessage {
  id        String    @id @default(uuid())
  name      String
  email     String
  subject   String?
  message   String
  status    String    @default("new") // 'new', 'read', 'replied', 'archived'
  repliedAt DateTime? @map("replied_at")
  repliedBy String?   @map("replied_by")
  ipAddress String?   @map("ip_address")
  createdAt DateTime  @default(now()) @map("created_at")

  replier User? @relation("RepliedBy", fields: [repliedBy], references: [id])

  @@index([status, createdAt(sort: Desc)])
  @@map("contact_messages")
}

model ProblemReport {
  id              String    @id @default(uuid())
  reporterName    String?   @map("reporter_name")
  reporterEmail   String?   @map("reporter_email")
  reporterPhone   String?   @map("reporter_phone")
  problemType     String    @map("problem_type") // 'cesta', 'rasvjeta', 'otpad', 'komunalno', 'ostalo'
  location        String
  description     String
  images          Json?     // [{url, caption}] R2 URLs
  status          String    @default("new") // 'new', 'in_progress', 'resolved', 'rejected'
  resolutionNotes String?   @map("resolution_notes")
  resolvedAt      DateTime? @map("resolved_at")
  resolvedBy      String?   @map("resolved_by")
  ipAddress       String?   @map("ip_address")
  createdAt       DateTime  @default(now()) @map("created_at")

  resolver User? @relation("ResolvedBy", fields: [resolvedBy], references: [id])

  @@index([status, createdAt(sort: Desc)])
  @@map("problem_reports")
}

model NewsletterSubscriber {
  id                String    @id @default(uuid())
  email             String    @unique
  confirmed         Boolean   @default(false)
  confirmationToken String?   @map("confirmation_token")
  confirmedAt       DateTime? @map("confirmed_at")
  unsubscribedAt    DateTime? @map("unsubscribed_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([confirmed])
  @@map("newsletter_subscribers")
}

model NewsletterSend {
  id             String   @id @default(uuid())
  subject        String
  contentHtml    String   @map("content_html")
  contentText    String   @map("content_text")
  sentAt         DateTime @default(now()) @map("sent_at")
  recipientCount Int?     @map("recipient_count")
  postsIncluded  Json?    @map("posts_included") // [{id, title}]
  eventsIncluded Json?    @map("events_included") // [{id, title}]
  isManual       Boolean  @default(false) @map("is_manual")

  @@map("newsletter_sends")
}
