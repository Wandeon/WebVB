// Prisma Schema for Veliki Bukovec
// See docs/DATABASE.md for full documentation

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector, pg_trgm]
}

// ============================================================================
// BETTER AUTH TABLES (Standard Schema)
// ============================================================================

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Custom extension field
  role   String  @default("staff") // 'super_admin', 'admin', 'staff'
  active Boolean @default(true) // Soft-delete flag for user management

  // Relations
  sessions  Session[]
  accounts  Account[]
  passkeys  Passkey[]
  twoFactor TwoFactor?

  // Content relations
  posts         Post[]
  documents     Document[]
  announcements Announcement[]

  // Communication relations
  contactReplies     ContactMessage[] @relation("RepliedBy")
  problemResolutions ProblemReport[]  @relation("ResolvedBy")

  // System relations
  aiRequests AiQueue[]
  auditLogs  AuditLog[]

  @@index([email])
  @@index([role])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String // 'google', 'credential'
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String? // For credential provider (hashed)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String // email or other identifier
  value      String // token value
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ============================================================================
// BETTER AUTH PLUGIN TABLES
// ============================================================================

model Passkey {
  id           String   @id @default(cuid())
  userId       String
  name         String? // User-friendly name "MacBook Touch ID"
  publicKey    String
  credentialID String   @unique
  counter      Int      @default(0)
  deviceType   String? // 'platform' or 'cross-platform'
  backedUp     Boolean  @default(false)
  transports   String? // JSON array of transports
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialID])
  @@map("passkey")
}

model TwoFactor {
  id          String   @id @default(cuid())
  userId      String   @unique
  secret      String // Encrypted TOTP secret
  backupCodes String? // Encrypted backup codes (JSON)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor")
}

// ============================================================================
// CONTENT TABLES
// ============================================================================

model Post {
  id             String    @id @default(uuid())
  title          String
  slug           String    @unique
  content        String // Rich text (TipTap HTML)
  excerpt        String? // Short summary
  featuredImage  String?   @map("featured_image") // R2 URL
  images         Json? // Additional images [{url, caption}]
  category       String    @default("aktualnosti")
  isFeatured     Boolean   @default(false) @map("is_featured")
  facebookPostId String?   @map("facebook_post_id")
  authorId       String?   @map("author_id")
  publishedAt    DateTime? @map("published_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  author User? @relation(fields: [authorId], references: [id])

  @@index([publishedAt(sort: Desc)])
  @@index([category])
  @@index([category, publishedAt(sort: Desc)])
  @@index([isFeatured])
  @@index([authorId])
  @@map("posts")
}

model Document {
  id          String   @id @default(uuid())
  title       String
  fileUrl     String   @map("file_url") // R2 URL
  fileSize    Int?     @map("file_size")
  category    String // 'sjednice', 'izbori', 'planovi', etc.
  subcategory String?
  year        Int?
  uploadedBy  String?  @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")

  uploader User? @relation(fields: [uploadedBy], references: [id])

  @@index([category, year(sort: Desc)])
  @@map("documents")
}

model Event {
  id          String    @id @default(uuid())
  title       String
  description String?
  eventDate   DateTime  @map("event_date") @db.Date
  eventTime   DateTime? @map("event_time") @db.Time()
  endDate     DateTime? @map("end_date") @db.Date
  location    String?
  posterImage String?   @map("poster_image") // R2 URL
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([eventDate])
  @@map("events")
}

model Page {
  id        String   @id @default(uuid())
  title     String
  slug      String   @unique
  content   String
  parentId  String?  @map("parent_id")
  menuOrder Int      @default(0) @map("menu_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent   Page?  @relation("PageHierarchy", fields: [parentId], references: [id])
  children Page[] @relation("PageHierarchy")

  @@index([parentId])
  @@map("pages")
}

model Gallery {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  eventDate   DateTime? @map("event_date") @db.Date
  description String?
  coverImage  String?   @map("cover_image") // R2 URL
  createdAt   DateTime  @default(now()) @map("created_at")

  images GalleryImage[]

  @@index([eventDate(sort: Desc)])
  @@map("galleries")
}

model GalleryImage {
  id           String   @id @default(uuid())
  galleryId    String   @map("gallery_id")
  imageUrl     String   @map("image_url") // R2 URL (large)
  thumbnailUrl String?  @map("thumbnail_url") // R2 URL (thumbnail)
  caption      String?
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@index([galleryId, sortOrder])
  @@map("gallery_images")
}

// ============================================================================
// COMMUNICATION TABLES
// ============================================================================

model ContactMessage {
  id        String    @id @default(uuid())
  name      String
  email     String
  subject   String?
  message   String
  status    String    @default("new") // 'new', 'read', 'replied', 'archived'
  repliedAt DateTime? @map("replied_at")
  repliedBy String?   @map("replied_by")
  ipAddress String?   @map("ip_address")
  createdAt DateTime  @default(now()) @map("created_at")

  replier User? @relation("RepliedBy", fields: [repliedBy], references: [id])

  @@index([status, createdAt(sort: Desc)])
  @@map("contact_messages")
}

model ProblemReport {
  id              String    @id @default(uuid())
  reporterName    String?   @map("reporter_name")
  reporterEmail   String?   @map("reporter_email")
  reporterPhone   String?   @map("reporter_phone")
  problemType     String    @map("problem_type") // 'cesta', 'rasvjeta', 'otpad', 'komunalno', 'ostalo'
  location        String
  description     String
  images          Json? // [{url, caption}] R2 URLs
  status          String    @default("new") // 'new', 'in_progress', 'resolved', 'rejected'
  resolutionNotes String?   @map("resolution_notes")
  resolvedAt      DateTime? @map("resolved_at")
  resolvedBy      String?   @map("resolved_by")
  ipAddress       String?   @map("ip_address")
  createdAt       DateTime  @default(now()) @map("created_at")

  resolver User? @relation("ResolvedBy", fields: [resolvedBy], references: [id])

  @@index([status, createdAt(sort: Desc)])
  @@map("problem_reports")
}

model NewsletterSubscriber {
  id                String    @id @default(uuid())
  email             String    @unique
  confirmed         Boolean   @default(false)
  confirmationToken String?   @map("confirmation_token")
  confirmedAt       DateTime? @map("confirmed_at")
  unsubscribedAt    DateTime? @map("unsubscribed_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([confirmed])
  @@map("newsletter_subscribers")
}

model NewsletterSend {
  id             String   @id @default(uuid())
  subject        String
  contentHtml    String   @map("content_html")
  contentText    String   @map("content_text")
  sentAt         DateTime @default(now()) @map("sent_at")
  recipientCount Int?     @map("recipient_count")
  postsIncluded  Json?    @map("posts_included") // [{id, title}]
  eventsIncluded Json?    @map("events_included") // [{id, title}]
  isManual       Boolean  @default(false) @map("is_manual")

  @@map("newsletter_sends")
}

model NewsletterDraft {
  id        String   @id @default("singleton")
  introText String?  @map("intro_text") @db.Text
  items     Json     @default("[]") // [{type: 'post'|'announcement'|'event', id: string, addedAt: string}]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("newsletter_drafts")
}

// ============================================================================
// SYSTEM TABLES
// ============================================================================

model Setting {
  key       String   @id
  value     Json
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("settings")
}

model Embedding {
  id         String                      @id @default(uuid())
  sourceType String                      @map("source_type") // 'document', 'page', 'post'
  sourceId   String                      @map("source_id")
  chunkIndex Int                         @map("chunk_index")
  chunkText  String                      @map("chunk_text")
  embedding  Unsupported("vector(768)")?
  createdAt  DateTime                    @default(now()) @map("created_at")

  @@index([sourceType, sourceId])
  @@map("embeddings")
}

model SearchIndex {
  id           String                      @id @default(uuid())
  sourceType   String                      @map("source_type") // 'post', 'document', 'page', 'event'
  sourceId     String                      @map("source_id")
  title        String
  contentText  String                      @map("content_text")
  category     String?
  url          String
  publishedAt  DateTime?                   @map("published_at")
  searchVector Unsupported("tsvector")?    @map("search_vector")
  embedding    Unsupported("vector(768)")?
  updatedAt    DateTime                    @default(now()) @updatedAt @map("updated_at")

  @@unique([sourceType, sourceId])
  @@map("search_index")
}

model AiQueue {
  id           String    @id @default(uuid())
  userId       String?   @map("user_id")
  requestType  String    @map("request_type") // 'post_generation', 'chat'
  inputData    Json      @map("input_data")
  status       String    @default("pending") // 'pending', 'processing', 'completed', 'failed', 'cancelled', 'dead_letter'
  lockedAt     DateTime? @map("locked_at")
  lockedBy     String?   @map("locked_by")
  leaseExpiresAt DateTime? @map("lease_expires_at")
  result       Json?
  errorMessage String?   @map("error_message")
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3) @map("max_attempts")
  createdAt    DateTime  @default(now()) @map("created_at")
  processedAt  DateTime? @map("processed_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([status, createdAt])
  @@map("ai_queue")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String // 'create', 'update', 'delete', 'login', 'logout'
  entityType String?  @map("entity_type") // 'post', 'document', 'user', etc.
  entityId   String?  @map("entity_id")
  changes    Json? // {before: {...}, after: {...}}
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_log")
}

// ============================================================================
// PUSH NOTIFICATIONS
// ============================================================================

model PushSubscription {
  id               String    @id @default(uuid())
  endpoint         String    @unique
  p256dh           String // Public key for encryption
  auth             String // Auth secret
  userAgent        String?   @map("user_agent")
  locale           String    @default("hr") // User locale for notifications
  topics           Json      @default("[\"all\"]") // ["waste", "news", "events", "announcements"]
  preferences      Json?     // { quietHoursStart?: "22:00", quietHoursEnd?: "07:00" }
  isActive         Boolean   @default(true) @map("is_active")
  lastSeenAt       DateTime? @map("last_seen_at")
  lastErrorAt      DateTime? @map("last_error_at")
  lastErrorMessage String?   @map("last_error_message")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([createdAt(sort: Desc)])
  @@map("push_subscriptions")
}

model NotificationSend {
  id             String   @id @default(uuid())
  topic          String // 'waste', 'news', 'events', 'announcements', 'all'
  title          String
  body           String
  url            String?
  sentAt         DateTime @default(now()) @map("sent_at")
  recipientCount Int      @map("recipient_count")
  successCount   Int      @default(0) @map("success_count")
  failureCount   Int      @default(0) @map("failure_count")
  metadata       Json? // Additional context like event_id, post_id, etc.

  @@index([topic])
  @@index([sentAt(sort: Desc)])
  @@map("notification_sends")
}

// ============================================================================
// ANNOUNCEMENTS (OBAVIJESTI)
// ============================================================================

model Announcement {
  id          String    @id @default(uuid())
  title       String
  slug        String    @unique
  content     String?   @db.Text
  excerpt     String?
  category    String    @default("obavijest") // 'natjecaj', 'oglas', 'poziv', 'obavijest'
  validFrom   DateTime? @map("valid_from")
  validUntil  DateTime? @map("valid_until")
  publishedAt DateTime? @map("published_at")
  authorId    String?   @map("author_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  author      User?                    @relation(fields: [authorId], references: [id])
  attachments AnnouncementAttachment[]

  @@index([category])
  @@index([publishedAt(sort: Desc)])
  @@index([category, publishedAt(sort: Desc)])
  @@index([validUntil])
  @@index([authorId])
  @@map("announcements")
}

model AnnouncementAttachment {
  id             String   @id @default(uuid())
  announcementId String   @map("announcement_id")
  fileName       String   @map("file_name")
  fileUrl        String   @map("file_url") // R2 URL
  fileSize       Int      @map("file_size")
  mimeType       String   @default("application/pdf") @map("mime_type")
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at")

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@index([announcementId, sortOrder])
  @@map("announcement_attachments")
}
